
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="AI-based Media and Misinformation Content Analysis Tool">
      
      
      
        <link rel="canonical" href="https://ssciwr.github.io/AMMICO/api/">
      
      
        <link rel="prev" href="../faq/">
      
      
      
        
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>API Reference - AMMICO</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#api-reference" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="AMMICO" class="md-header__button md-logo" aria-label="AMMICO" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            AMMICO
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              API Reference
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/ssciwr/AMMICO" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    ssciwr/AMMICO
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="AMMICO" class="md-nav__button md-logo" aria-label="AMMICO" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    AMMICO
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/ssciwr/AMMICO" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    ssciwr/AMMICO
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Tutorials
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Tutorials
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/getting_started/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Getting started
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/image_summary/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Image summary and VQA
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/video_summary/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Video summary and VQA
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/text/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Text analysis
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/ammico_demo_multimodal_analysis/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Multimodal analysis
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/colors/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Color analysis
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/display/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Interactive display
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Modules
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Modules
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../modules/text/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Text analysis
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../modules/image_summary/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Image summary and VQA
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../modules/video_summary/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Video summary and VQA
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../modules/colors/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Color analysis
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../modules/display/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Interactive display
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    More information
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    More information
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../set_up_credentials/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Set up credentials for Google Cloud API
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../faq/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    FAQ
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    API Reference
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    API Reference
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#text" class="md-nav__link">
    <span class="md-ellipsis">
      
        Text
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.text" class="md-nav__link">
    <span class="md-ellipsis">
      
        text
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.text.TextAnalyzer" class="md-nav__link">
    <span class="md-ellipsis">
      
        TextAnalyzer
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="TextAnalyzer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ammico.text.TextAnalyzer.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.text.TextAnalyzer.read_csv" class="md-nav__link">
    <span class="md-ellipsis">
      
        read_csv
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.text.TextDetector" class="md-nav__link">
    <span class="md-ellipsis">
      
        TextDetector
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="TextDetector">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ammico.text.TextDetector.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.text.TextDetector.analyse_image" class="md-nav__link">
    <span class="md-ellipsis">
      
        analyse_image
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.text.TextDetector.get_text_from_image" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_text_from_image
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.text.TextDetector.remove_linebreaks" class="md-nav__link">
    <span class="md-ellipsis">
      
        remove_linebreaks
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.text.TextDetector.set_keys" class="md-nav__link">
    <span class="md-ellipsis">
      
        set_keys
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.text.TextDetector.translate_text" class="md-nav__link">
    <span class="md-ellipsis">
      
        translate_text
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.text.privacy_disclosure" class="md-nav__link">
    <span class="md-ellipsis">
      
        privacy_disclosure
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#image-summary" class="md-nav__link">
    <span class="md-ellipsis">
      
        Image Summary
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.image_summary" class="md-nav__link">
    <span class="md-ellipsis">
      
        image_summary
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.image_summary.ImageSummaryDetector" class="md-nav__link">
    <span class="md-ellipsis">
      
        ImageSummaryDetector
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ImageSummaryDetector">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ammico.image_summary.ImageSummaryDetector.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.image_summary.ImageSummaryDetector.analyse_image" class="md-nav__link">
    <span class="md-ellipsis">
      
        analyse_image
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.image_summary.ImageSummaryDetector.analyse_images_from_dict" class="md-nav__link">
    <span class="md-ellipsis">
      
        analyse_images_from_dict
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.image_summary.ImageSummaryDetector.answer_questions" class="md-nav__link">
    <span class="md-ellipsis">
      
        answer_questions
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.image_summary.ImageSummaryDetector.generate_caption" class="md-nav__link">
    <span class="md-ellipsis">
      
        generate_caption
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#video-summary" class="md-nav__link">
    <span class="md-ellipsis">
      
        Video Summary
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.video_summary" class="md-nav__link">
    <span class="md-ellipsis">
      
        video_summary
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.video_summary.VideoSummaryDetector" class="md-nav__link">
    <span class="md-ellipsis">
      
        VideoSummaryDetector
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="VideoSummaryDetector">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ammico.video_summary.VideoSummaryDetector.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.video_summary.VideoSummaryDetector.analyse_videos_from_dict" class="md-nav__link">
    <span class="md-ellipsis">
      
        analyse_videos_from_dict
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.video_summary.VideoSummaryDetector.final_answers" class="md-nav__link">
    <span class="md-ellipsis">
      
        final_answers
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.video_summary.VideoSummaryDetector.final_summary" class="md-nav__link">
    <span class="md-ellipsis">
      
        final_summary
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.video_summary.VideoSummaryDetector.make_captions_for_subclips" class="md-nav__link">
    <span class="md-ellipsis">
      
        make_captions_for_subclips
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.video_summary.VideoSummaryDetector.merge_audio_visual_boundaries" class="md-nav__link">
    <span class="md-ellipsis">
      
        merge_audio_visual_boundaries
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#colors" class="md-nav__link">
    <span class="md-ellipsis">
      
        Colors
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.colors" class="md-nav__link">
    <span class="md-ellipsis">
      
        colors
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.colors.ColorDetector" class="md-nav__link">
    <span class="md-ellipsis">
      
        ColorDetector
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ColorDetector">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ammico.colors.ColorDetector.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.colors.ColorDetector.analyse_image" class="md-nav__link">
    <span class="md-ellipsis">
      
        analyse_image
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.colors.ColorDetector.rgb2name" class="md-nav__link">
    <span class="md-ellipsis">
      
        rgb2name
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#utils" class="md-nav__link">
    <span class="md-ellipsis">
      
        Utils
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.utils" class="md-nav__link">
    <span class="md-ellipsis">
      
        utils
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.utils.AnalysisMethod" class="md-nav__link">
    <span class="md-ellipsis">
      
        AnalysisMethod
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.utils.DownloadResource" class="md-nav__link">
    <span class="md-ellipsis">
      
        DownloadResource
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.utils.ammico_prefetch_models" class="md-nav__link">
    <span class="md-ellipsis">
      
        ammico_prefetch_models
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.utils.append_data_to_dict" class="md-nav__link">
    <span class="md-ellipsis">
      
        append_data_to_dict
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.utils.dump_df" class="md-nav__link">
    <span class="md-ellipsis">
      
        dump_df
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.utils.find_files" class="md-nav__link">
    <span class="md-ellipsis">
      
        find_files
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.utils.find_videos" class="md-nav__link">
    <span class="md-ellipsis">
      
        find_videos
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.utils.get_supported_whisperx_languages" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_supported_whisperx_languages
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.utils.initialize_dict" class="md-nav__link">
    <span class="md-ellipsis">
      
        initialize_dict
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.utils.is_interactive" class="md-nav__link">
    <span class="md-ellipsis">
      
        is_interactive
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.utils.load_image" class="md-nav__link">
    <span class="md-ellipsis">
      
        load_image
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.utils.prepare_image" class="md-nav__link">
    <span class="md-ellipsis">
      
        prepare_image
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#display" class="md-nav__link">
    <span class="md-ellipsis">
      
        Display
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.display" class="md-nav__link">
    <span class="md-ellipsis">
      
        display
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.display.AnalysisExplorer" class="md-nav__link">
    <span class="md-ellipsis">
      
        AnalysisExplorer
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="AnalysisExplorer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ammico.display.AnalysisExplorer.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.display.AnalysisExplorer.run_server" class="md-nav__link">
    <span class="md-ellipsis">
      
        run_server
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.display.AnalysisExplorer.update_picture" class="md-nav__link">
    <span class="md-ellipsis">
      
        update_picture
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#model" class="md-nav__link">
    <span class="md-ellipsis">
      
        Model
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.model" class="md-nav__link">
    <span class="md-ellipsis">
      
        model
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.model.AudioToTextModel" class="md-nav__link">
    <span class="md-ellipsis">
      
        AudioToTextModel
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="AudioToTextModel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ammico.model.AudioToTextModel.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.model.AudioToTextModel.close" class="md-nav__link">
    <span class="md-ellipsis">
      
        close
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.model.MultimodalEmbeddingsModel" class="md-nav__link">
    <span class="md-ellipsis">
      
        MultimodalEmbeddingsModel
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MultimodalEmbeddingsModel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ammico.model.MultimodalEmbeddingsModel.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.model.MultimodalEmbeddingsModel.close" class="md-nav__link">
    <span class="md-ellipsis">
      
        close
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.model.MultimodalSummaryModel" class="md-nav__link">
    <span class="md-ellipsis">
      
        MultimodalSummaryModel
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MultimodalSummaryModel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ammico.model.MultimodalSummaryModel.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.model.MultimodalSummaryModel.close" class="md-nav__link">
    <span class="md-ellipsis">
      
        close
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prompt-builder" class="md-nav__link">
    <span class="md-ellipsis">
      
        Prompt Builder
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.prompt_builder" class="md-nav__link">
    <span class="md-ellipsis">
      
        prompt_builder
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.prompt_builder.ProcessingLevel" class="md-nav__link">
    <span class="md-ellipsis">
      
        ProcessingLevel
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.prompt_builder.PromptBuilder" class="md-nav__link">
    <span class="md-ellipsis">
      
        PromptBuilder
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PromptBuilder">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ammico.prompt_builder.PromptBuilder.audio_module" class="md-nav__link">
    <span class="md-ellipsis">
      
        audio_module
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.prompt_builder.PromptBuilder.build_clip_prompt" class="md-nav__link">
    <span class="md-ellipsis">
      
        build_clip_prompt
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.prompt_builder.PromptBuilder.build_frame_prompt" class="md-nav__link">
    <span class="md-ellipsis">
      
        build_frame_prompt
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.prompt_builder.PromptBuilder.build_video_prompt" class="md-nav__link">
    <span class="md-ellipsis">
      
        build_video_prompt
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.prompt_builder.PromptBuilder.questions_module" class="md-nav__link">
    <span class="md-ellipsis">
      
        questions_module
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.prompt_builder.PromptBuilder.summary_task" class="md-nav__link">
    <span class="md-ellipsis">
      
        summary_task
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.prompt_builder.PromptBuilder.summary_vqa_task" class="md-nav__link">
    <span class="md-ellipsis">
      
        summary_vqa_task
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.prompt_builder.PromptBuilder.visual_captions_final_module" class="md-nav__link">
    <span class="md-ellipsis">
      
        visual_captions_final_module
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.prompt_builder.PromptBuilder.visual_captions_module" class="md-nav__link">
    <span class="md-ellipsis">
      
        visual_captions_module
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.prompt_builder.PromptBuilder.visual_frames_module" class="md-nav__link">
    <span class="md-ellipsis">
      
        visual_frames_module
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.prompt_builder.PromptBuilder.vqa_context_module" class="md-nav__link">
    <span class="md-ellipsis">
      
        vqa_context_module
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.prompt_builder.PromptBuilder.vqa_only_task" class="md-nav__link">
    <span class="md-ellipsis">
      
        vqa_only_task
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#text" class="md-nav__link">
    <span class="md-ellipsis">
      
        Text
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.text" class="md-nav__link">
    <span class="md-ellipsis">
      
        text
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.text.TextAnalyzer" class="md-nav__link">
    <span class="md-ellipsis">
      
        TextAnalyzer
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="TextAnalyzer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ammico.text.TextAnalyzer.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.text.TextAnalyzer.read_csv" class="md-nav__link">
    <span class="md-ellipsis">
      
        read_csv
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.text.TextDetector" class="md-nav__link">
    <span class="md-ellipsis">
      
        TextDetector
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="TextDetector">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ammico.text.TextDetector.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.text.TextDetector.analyse_image" class="md-nav__link">
    <span class="md-ellipsis">
      
        analyse_image
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.text.TextDetector.get_text_from_image" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_text_from_image
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.text.TextDetector.remove_linebreaks" class="md-nav__link">
    <span class="md-ellipsis">
      
        remove_linebreaks
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.text.TextDetector.set_keys" class="md-nav__link">
    <span class="md-ellipsis">
      
        set_keys
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.text.TextDetector.translate_text" class="md-nav__link">
    <span class="md-ellipsis">
      
        translate_text
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.text.privacy_disclosure" class="md-nav__link">
    <span class="md-ellipsis">
      
        privacy_disclosure
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#image-summary" class="md-nav__link">
    <span class="md-ellipsis">
      
        Image Summary
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.image_summary" class="md-nav__link">
    <span class="md-ellipsis">
      
        image_summary
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.image_summary.ImageSummaryDetector" class="md-nav__link">
    <span class="md-ellipsis">
      
        ImageSummaryDetector
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ImageSummaryDetector">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ammico.image_summary.ImageSummaryDetector.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.image_summary.ImageSummaryDetector.analyse_image" class="md-nav__link">
    <span class="md-ellipsis">
      
        analyse_image
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.image_summary.ImageSummaryDetector.analyse_images_from_dict" class="md-nav__link">
    <span class="md-ellipsis">
      
        analyse_images_from_dict
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.image_summary.ImageSummaryDetector.answer_questions" class="md-nav__link">
    <span class="md-ellipsis">
      
        answer_questions
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.image_summary.ImageSummaryDetector.generate_caption" class="md-nav__link">
    <span class="md-ellipsis">
      
        generate_caption
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#video-summary" class="md-nav__link">
    <span class="md-ellipsis">
      
        Video Summary
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.video_summary" class="md-nav__link">
    <span class="md-ellipsis">
      
        video_summary
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.video_summary.VideoSummaryDetector" class="md-nav__link">
    <span class="md-ellipsis">
      
        VideoSummaryDetector
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="VideoSummaryDetector">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ammico.video_summary.VideoSummaryDetector.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.video_summary.VideoSummaryDetector.analyse_videos_from_dict" class="md-nav__link">
    <span class="md-ellipsis">
      
        analyse_videos_from_dict
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.video_summary.VideoSummaryDetector.final_answers" class="md-nav__link">
    <span class="md-ellipsis">
      
        final_answers
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.video_summary.VideoSummaryDetector.final_summary" class="md-nav__link">
    <span class="md-ellipsis">
      
        final_summary
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.video_summary.VideoSummaryDetector.make_captions_for_subclips" class="md-nav__link">
    <span class="md-ellipsis">
      
        make_captions_for_subclips
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.video_summary.VideoSummaryDetector.merge_audio_visual_boundaries" class="md-nav__link">
    <span class="md-ellipsis">
      
        merge_audio_visual_boundaries
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#colors" class="md-nav__link">
    <span class="md-ellipsis">
      
        Colors
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.colors" class="md-nav__link">
    <span class="md-ellipsis">
      
        colors
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.colors.ColorDetector" class="md-nav__link">
    <span class="md-ellipsis">
      
        ColorDetector
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ColorDetector">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ammico.colors.ColorDetector.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.colors.ColorDetector.analyse_image" class="md-nav__link">
    <span class="md-ellipsis">
      
        analyse_image
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.colors.ColorDetector.rgb2name" class="md-nav__link">
    <span class="md-ellipsis">
      
        rgb2name
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#utils" class="md-nav__link">
    <span class="md-ellipsis">
      
        Utils
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.utils" class="md-nav__link">
    <span class="md-ellipsis">
      
        utils
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.utils.AnalysisMethod" class="md-nav__link">
    <span class="md-ellipsis">
      
        AnalysisMethod
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.utils.DownloadResource" class="md-nav__link">
    <span class="md-ellipsis">
      
        DownloadResource
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.utils.ammico_prefetch_models" class="md-nav__link">
    <span class="md-ellipsis">
      
        ammico_prefetch_models
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.utils.append_data_to_dict" class="md-nav__link">
    <span class="md-ellipsis">
      
        append_data_to_dict
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.utils.dump_df" class="md-nav__link">
    <span class="md-ellipsis">
      
        dump_df
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.utils.find_files" class="md-nav__link">
    <span class="md-ellipsis">
      
        find_files
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.utils.find_videos" class="md-nav__link">
    <span class="md-ellipsis">
      
        find_videos
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.utils.get_supported_whisperx_languages" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_supported_whisperx_languages
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.utils.initialize_dict" class="md-nav__link">
    <span class="md-ellipsis">
      
        initialize_dict
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.utils.is_interactive" class="md-nav__link">
    <span class="md-ellipsis">
      
        is_interactive
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.utils.load_image" class="md-nav__link">
    <span class="md-ellipsis">
      
        load_image
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.utils.prepare_image" class="md-nav__link">
    <span class="md-ellipsis">
      
        prepare_image
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#display" class="md-nav__link">
    <span class="md-ellipsis">
      
        Display
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.display" class="md-nav__link">
    <span class="md-ellipsis">
      
        display
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.display.AnalysisExplorer" class="md-nav__link">
    <span class="md-ellipsis">
      
        AnalysisExplorer
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="AnalysisExplorer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ammico.display.AnalysisExplorer.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.display.AnalysisExplorer.run_server" class="md-nav__link">
    <span class="md-ellipsis">
      
        run_server
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.display.AnalysisExplorer.update_picture" class="md-nav__link">
    <span class="md-ellipsis">
      
        update_picture
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#model" class="md-nav__link">
    <span class="md-ellipsis">
      
        Model
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.model" class="md-nav__link">
    <span class="md-ellipsis">
      
        model
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.model.AudioToTextModel" class="md-nav__link">
    <span class="md-ellipsis">
      
        AudioToTextModel
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="AudioToTextModel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ammico.model.AudioToTextModel.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.model.AudioToTextModel.close" class="md-nav__link">
    <span class="md-ellipsis">
      
        close
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.model.MultimodalEmbeddingsModel" class="md-nav__link">
    <span class="md-ellipsis">
      
        MultimodalEmbeddingsModel
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MultimodalEmbeddingsModel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ammico.model.MultimodalEmbeddingsModel.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.model.MultimodalEmbeddingsModel.close" class="md-nav__link">
    <span class="md-ellipsis">
      
        close
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.model.MultimodalSummaryModel" class="md-nav__link">
    <span class="md-ellipsis">
      
        MultimodalSummaryModel
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MultimodalSummaryModel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ammico.model.MultimodalSummaryModel.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.model.MultimodalSummaryModel.close" class="md-nav__link">
    <span class="md-ellipsis">
      
        close
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prompt-builder" class="md-nav__link">
    <span class="md-ellipsis">
      
        Prompt Builder
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.prompt_builder" class="md-nav__link">
    <span class="md-ellipsis">
      
        prompt_builder
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.prompt_builder.ProcessingLevel" class="md-nav__link">
    <span class="md-ellipsis">
      
        ProcessingLevel
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ammico.prompt_builder.PromptBuilder" class="md-nav__link">
    <span class="md-ellipsis">
      
        PromptBuilder
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PromptBuilder">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ammico.prompt_builder.PromptBuilder.audio_module" class="md-nav__link">
    <span class="md-ellipsis">
      
        audio_module
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.prompt_builder.PromptBuilder.build_clip_prompt" class="md-nav__link">
    <span class="md-ellipsis">
      
        build_clip_prompt
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.prompt_builder.PromptBuilder.build_frame_prompt" class="md-nav__link">
    <span class="md-ellipsis">
      
        build_frame_prompt
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.prompt_builder.PromptBuilder.build_video_prompt" class="md-nav__link">
    <span class="md-ellipsis">
      
        build_video_prompt
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.prompt_builder.PromptBuilder.questions_module" class="md-nav__link">
    <span class="md-ellipsis">
      
        questions_module
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.prompt_builder.PromptBuilder.summary_task" class="md-nav__link">
    <span class="md-ellipsis">
      
        summary_task
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.prompt_builder.PromptBuilder.summary_vqa_task" class="md-nav__link">
    <span class="md-ellipsis">
      
        summary_vqa_task
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.prompt_builder.PromptBuilder.visual_captions_final_module" class="md-nav__link">
    <span class="md-ellipsis">
      
        visual_captions_final_module
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.prompt_builder.PromptBuilder.visual_captions_module" class="md-nav__link">
    <span class="md-ellipsis">
      
        visual_captions_module
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.prompt_builder.PromptBuilder.visual_frames_module" class="md-nav__link">
    <span class="md-ellipsis">
      
        visual_frames_module
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.prompt_builder.PromptBuilder.vqa_context_module" class="md-nav__link">
    <span class="md-ellipsis">
      
        vqa_context_module
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ammico.prompt_builder.PromptBuilder.vqa_only_task" class="md-nav__link">
    <span class="md-ellipsis">
      
        vqa_only_task
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="api-reference">API Reference</h1>
<h2 id="text">Text</h2>


<div class="doc doc-object doc-module">



<a id="ammico.text"></a>
    <div class="doc doc-contents first">










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="ammico.text.TextAnalyzer" class="doc doc-heading">
            <code>TextAnalyzer</code>


</h2>


    <div class="doc doc-contents ">



        <p>Used to get text from a csv and then run the TextDetector on it.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>ammico/text.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TextAnalyzer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Used to get text from a csv and then run the TextDetector on it.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">csv_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">column_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">csv_encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;utf-8&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Init the TextTranslator class.</span>

<span class="sd">        Args:</span>
<span class="sd">            csv_path (str): Path to the CSV file containing the text entries.</span>
<span class="sd">            column_key (str): Key for the column containing the text entries.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            csv_encoding (str): Encoding of the CSV file. Defaults to &quot;utf-8&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csv_path</span> <span class="o">=</span> <span class="n">csv_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">column_key</span> <span class="o">=</span> <span class="n">column_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csv_encoding</span> <span class="o">=</span> <span class="n">csv_encoding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_valid_csv_path</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_file_exists</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_key</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No column key provided - using &#39;text&#39; as default.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">column_key</span> <span class="o">=</span> <span class="s2">&quot;text&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">csv_encoding</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No encoding provided - using &#39;utf-8&#39; as default.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">csv_encoding</span> <span class="o">=</span> <span class="s2">&quot;utf-8&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">column_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The provided column key is not a string.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">csv_encoding</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The provided encoding is not a string.&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_check_valid_csv_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">csv_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The provided path to the CSV file is not a string.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">csv_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.csv&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The provided file is not a CSV file.&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_check_file_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">csv_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>  <span class="c1"># noqa</span>
                <span class="k">pass</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;The provided CSV file does not exist.&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read the CSV file and return the dictionary with the text entries.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: The dictionary with the text entries.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">csv_path</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">csv_encoding</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;The provided column key is not in the CSV file. Please check.&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mylist</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">column_key</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mydict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">text</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mylist</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mydict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">csv_path</span> <span class="o">+</span> <span class="s2">&quot;row-&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">csv_path</span><span class="p">,</span>
                <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">text</span><span class="p">,</span>
            <span class="p">}</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="ammico.text.TextAnalyzer.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="n">column_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">csv_encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Init the TextTranslator class.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>csv_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the CSV file containing the text entries.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>column_key</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Key for the column containing the text entries.
Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>csv_encoding</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Encoding of the CSV file. Defaults to "utf-8".</p>
              </div>
            </td>
            <td>
                  <code>&#39;utf-8&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ammico/text.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">csv_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">column_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">csv_encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;utf-8&quot;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Init the TextTranslator class.</span>

<span class="sd">    Args:</span>
<span class="sd">        csv_path (str): Path to the CSV file containing the text entries.</span>
<span class="sd">        column_key (str): Key for the column containing the text entries.</span>
<span class="sd">            Defaults to None.</span>
<span class="sd">        csv_encoding (str): Encoding of the CSV file. Defaults to &quot;utf-8&quot;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">csv_path</span> <span class="o">=</span> <span class="n">csv_path</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">column_key</span> <span class="o">=</span> <span class="n">column_key</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">csv_encoding</span> <span class="o">=</span> <span class="n">csv_encoding</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_check_valid_csv_path</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_check_file_exists</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_key</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No column key provided - using &#39;text&#39; as default.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">column_key</span> <span class="o">=</span> <span class="s2">&quot;text&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">csv_encoding</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No encoding provided - using &#39;utf-8&#39; as default.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csv_encoding</span> <span class="o">=</span> <span class="s2">&quot;utf-8&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">column_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The provided column key is not a string.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">csv_encoding</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The provided encoding is not a string.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ammico.text.TextAnalyzer.read_csv" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">read_csv</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Read the CSV file and return the dictionary with the text entries.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The dictionary with the text entries.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ammico/text.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read the CSV file and return the dictionary with the text entries.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: The dictionary with the text entries.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">csv_path</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">csv_encoding</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;The provided column key is not in the CSV file. Please check.&quot;</span>
        <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mylist</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">column_key</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mydict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">text</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mylist</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mydict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">csv_path</span> <span class="o">+</span> <span class="s2">&quot;row-&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">csv_path</span><span class="p">,</span>
            <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">text</span><span class="p">,</span>
        <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="ammico.text.TextDetector" class="doc doc-heading">
            <code>TextDetector</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="AnalysisMethod (ammico.utils.AnalysisMethod)" href="#ammico.utils.AnalysisMethod">AnalysisMethod</a></code></p>










              <details class="mkdocstrings-source">
                <summary>Source code in <code>ammico/text.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TextDetector</span><span class="p">(</span><span class="n">AnalysisMethod</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">subdict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">skip_extraction</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">accept_privacy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;PRIVACY_AMMICO&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Init text detection class.</span>

<span class="sd">        Args:</span>
<span class="sd">            subdict (dict): Dictionary containing file name/path, and possibly previous</span>
<span class="sd">                analysis results from other modules.</span>
<span class="sd">            skip_extraction (bool, optional): Decide if text will be extracted from images or</span>
<span class="sd">                is already provided via a csv. Defaults to False.</span>
<span class="sd">            accept_privacy (str, optional): Environment variable to accept the privacy</span>
<span class="sd">                statement for the Google Cloud processing of the data. Defaults to</span>
<span class="sd">                &quot;PRIVACY_AMMICO&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">subdict</span><span class="p">)</span>
        <span class="c1"># disable this for now</span>
        <span class="c1"># maybe it would be better to initialize the keys differently</span>
        <span class="c1"># the reason is that they are inconsistent depending on the selected</span>
        <span class="c1"># options, and also this may not be really necessary and rather restrictive</span>
        <span class="c1"># self.subdict.update(self.set_keys())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">accepted</span> <span class="o">=</span> <span class="n">privacy_disclosure</span><span class="p">(</span><span class="n">accept_privacy</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">accepted</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Privacy disclosure not accepted - skipping text detection.&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">translator</span> <span class="o">=</span> <span class="n">Translator</span><span class="p">(</span><span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skip_extraction</span> <span class="o">=</span> <span class="n">skip_extraction</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">skip_extraction</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;skip_extraction needs to be set to true or false&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_extraction</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Skipping text extraction from image.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reading text directly from provided dictionary.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_spacy</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the default keys for text analysis.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: The dictionary with default text keys.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;text_language&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;text_english&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">params</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_initialize_spacy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the Spacy library for text analysis.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nlp</span> <span class="o">=</span> <span class="n">spacy</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;en_core_web_md&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">spacy</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s2">&quot;en_core_web_md&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nlp</span> <span class="o">=</span> <span class="n">spacy</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;en_core_web_md&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_check_add_space_after_full_stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a space after a full stop. Required by googletrans.&quot;&quot;&quot;</span>
        <span class="c1"># we have found text, now we check for full stops</span>
        <span class="n">index_stop</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">start</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">])]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">index_stop</span><span class="p">:</span>  <span class="c1"># no full stops found</span>
            <span class="k">return</span>
        <span class="c1"># check if this includes the last string item</span>
        <span class="n">end_of_list</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">index_stop</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="c1"># the last found full stop is at the end of the string</span>
            <span class="c1"># but we can include all others</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">index_stop</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">end_of_list</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">index_stop</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">end_of_list</span><span class="p">:</span>  <span class="c1"># only one full stop at end of string</span>
            <span class="k">return</span>
        <span class="c1"># if this is not the end of the list, check if there is a space after the full stop</span>
        <span class="n">no_space</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">index_stop</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot; &quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">no_space</span><span class="p">:</span>  <span class="c1"># all full stops have a space after them</span>
            <span class="k">return</span>
        <span class="c1"># else, amend the text</span>
        <span class="n">add_one</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">no_space</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">][:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">add_one</span><span class="p">]</span>
                <span class="o">+</span> <span class="s2">&quot; &quot;</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="n">add_one</span> <span class="p">:]</span>
            <span class="p">)</span>
            <span class="n">add_one</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_truncate_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Truncate the text if it is too long for googletrans.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">max_length</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Text is too long - truncating to </span><span class="si">{}</span><span class="s2"> characters.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">max_length</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="p">[</span><span class="s2">&quot;text_truncated&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">][:</span><span class="n">max_length</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analyse_image</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform text extraction and analysis of the text.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: The updated dictionary with text analysis results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_extraction</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_text_from_image</span><span class="p">()</span>
        <span class="c1"># check that text was found</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No text found - skipping analysis.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># make sure all full stops are followed by whitespace</span>
            <span class="c1"># otherwise googletrans breaks</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_add_space_after_full_stop</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_truncate_text</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">translate_text</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove_linebreaks</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="p">[</span><span class="s2">&quot;text_english&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_run_spacy</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_text_from_image</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Detect text on the image using Google Cloud Vision API.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">accepted</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Privacy disclosure not accepted - skipping text detection.&quot;</span>
            <span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">client</span> <span class="o">=</span> <span class="n">vision</span><span class="o">.</span><span class="n">ImageAnnotatorClient</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">DefaultCredentialsError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DefaultCredentialsError</span><span class="p">(</span>
                <span class="s2">&quot;Please provide credentials for google cloud vision API, see https://cloud.google.com/docs/authentication/application-default-credentials.&quot;</span>
            <span class="p">)</span>
        <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">image_file</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">image_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">vision</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">)</span>
        <span class="c1"># check for usual connection errors and retry if necessary</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">text_detection</span><span class="p">(</span><span class="n">image</span><span class="o">=</span><span class="n">image</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">grpc</span><span class="o">.</span><span class="n">RpcError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cloud vision API connection failed&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Skipping this image ..</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Connection failed with code </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exc</span><span class="o">.</span><span class="n">code</span><span class="p">(),</span> <span class="n">exc</span><span class="p">))</span>
        <span class="c1"># here check if text was found on image</span>
        <span class="k">if</span> <span class="n">response</span><span class="p">:</span>
            <span class="n">texts</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">text_annotations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">description</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">texts</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No text found on image.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">message</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Google Cloud Vision Error&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="se">\n</span><span class="s2">For more info on error messages, check: &quot;</span>
                <span class="s2">&quot;https://cloud.google.com/apis/design/errors&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">response</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">message</span>
                <span class="p">)</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">translate_text</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Translate the detected text to English using the Translator object.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">accepted</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Privacy disclosure not accepted - skipping text translation.&quot;</span>
            <span class="p">)</span>
        <span class="n">text_to_translate</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="p">[</span><span class="s2">&quot;text_truncated&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;text_truncated&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span>
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">translated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">translator</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">text_to_translate</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not translate the text with error </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="ne">Exception</span><span class="p">))</span>
            <span class="n">translated</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Skipping translation for this text.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="p">[</span><span class="s2">&quot;text_language&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">translated</span><span class="o">.</span><span class="n">src</span> <span class="k">if</span> <span class="n">translated</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="p">[</span><span class="s2">&quot;text_english&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">translated</span><span class="o">.</span><span class="n">text</span> <span class="k">if</span> <span class="n">translated</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">remove_linebreaks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove linebreaks from original and translated text.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="p">[</span><span class="s2">&quot;text_english&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="p">[</span><span class="s2">&quot;text_english&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="p">[</span><span class="s2">&quot;text_english&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_run_spacy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate Spacy doc object for further text analysis.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">doc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nlp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="p">[</span><span class="s2">&quot;text_english&quot;</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="ammico.text.TextDetector.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">subdict</span><span class="p">,</span> <span class="n">skip_extraction</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">accept_privacy</span><span class="o">=</span><span class="s1">&#39;PRIVACY_AMMICO&#39;</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Init text detection class.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>subdict</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing file name/path, and possibly previous
analysis results from other modules.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>skip_extraction</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Decide if text will be extracted from images or
is already provided via a csv. Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>accept_privacy</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Environment variable to accept the privacy
statement for the Google Cloud processing of the data. Defaults to
"PRIVACY_AMMICO".</p>
              </div>
            </td>
            <td>
                  <code>&#39;PRIVACY_AMMICO&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ammico/text.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">subdict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">skip_extraction</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">accept_privacy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;PRIVACY_AMMICO&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Init text detection class.</span>

<span class="sd">    Args:</span>
<span class="sd">        subdict (dict): Dictionary containing file name/path, and possibly previous</span>
<span class="sd">            analysis results from other modules.</span>
<span class="sd">        skip_extraction (bool, optional): Decide if text will be extracted from images or</span>
<span class="sd">            is already provided via a csv. Defaults to False.</span>
<span class="sd">        accept_privacy (str, optional): Environment variable to accept the privacy</span>
<span class="sd">            statement for the Google Cloud processing of the data. Defaults to</span>
<span class="sd">            &quot;PRIVACY_AMMICO&quot;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">subdict</span><span class="p">)</span>
    <span class="c1"># disable this for now</span>
    <span class="c1"># maybe it would be better to initialize the keys differently</span>
    <span class="c1"># the reason is that they are inconsistent depending on the selected</span>
    <span class="c1"># options, and also this may not be really necessary and rather restrictive</span>
    <span class="c1"># self.subdict.update(self.set_keys())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">accepted</span> <span class="o">=</span> <span class="n">privacy_disclosure</span><span class="p">(</span><span class="n">accept_privacy</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">accepted</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Privacy disclosure not accepted - skipping text detection.&quot;</span>
        <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">translator</span> <span class="o">=</span> <span class="n">Translator</span><span class="p">(</span><span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">skip_extraction</span> <span class="o">=</span> <span class="n">skip_extraction</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">skip_extraction</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;skip_extraction needs to be set to true or false&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_extraction</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Skipping text extraction from image.&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reading text directly from provided dictionary.&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_spacy</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ammico.text.TextDetector.analyse_image" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">analyse_image</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Perform text extraction and analysis of the text.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The updated dictionary with text analysis results.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ammico/text.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">analyse_image</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Perform text extraction and analysis of the text.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: The updated dictionary with text analysis results.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_extraction</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_text_from_image</span><span class="p">()</span>
    <span class="c1"># check that text was found</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No text found - skipping analysis.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># make sure all full stops are followed by whitespace</span>
        <span class="c1"># otherwise googletrans breaks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_add_space_after_full_stop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_truncate_text</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">translate_text</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remove_linebreaks</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="p">[</span><span class="s2">&quot;text_english&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_run_spacy</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ammico.text.TextDetector.get_text_from_image" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_text_from_image</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Detect text on the image using Google Cloud Vision API.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ammico/text.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_text_from_image</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Detect text on the image using Google Cloud Vision API.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">accepted</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Privacy disclosure not accepted - skipping text detection.&quot;</span>
        <span class="p">)</span>
    <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">vision</span><span class="o">.</span><span class="n">ImageAnnotatorClient</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">DefaultCredentialsError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">DefaultCredentialsError</span><span class="p">(</span>
            <span class="s2">&quot;Please provide credentials for google cloud vision API, see https://cloud.google.com/docs/authentication/application-default-credentials.&quot;</span>
        <span class="p">)</span>
    <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">image_file</span><span class="p">:</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">image_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">vision</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">)</span>
    <span class="c1"># check for usual connection errors and retry if necessary</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">text_detection</span><span class="p">(</span><span class="n">image</span><span class="o">=</span><span class="n">image</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">grpc</span><span class="o">.</span><span class="n">RpcError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cloud vision API connection failed&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Skipping this image ..</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Connection failed with code </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exc</span><span class="o">.</span><span class="n">code</span><span class="p">(),</span> <span class="n">exc</span><span class="p">))</span>
    <span class="c1"># here check if text was found on image</span>
    <span class="k">if</span> <span class="n">response</span><span class="p">:</span>
        <span class="n">texts</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">text_annotations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">description</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">texts</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No text found on image.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">message</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Google Cloud Vision Error&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">{}</span><span class="se">\n</span><span class="s2">For more info on error messages, check: &quot;</span>
            <span class="s2">&quot;https://cloud.google.com/apis/design/errors&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">response</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">message</span>
            <span class="p">)</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ammico.text.TextDetector.remove_linebreaks" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">remove_linebreaks</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Remove linebreaks from original and translated text.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ammico/text.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">remove_linebreaks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Remove linebreaks from original and translated text.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="p">[</span><span class="s2">&quot;text_english&quot;</span><span class="p">]:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="p">[</span><span class="s2">&quot;text_english&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="p">[</span><span class="s2">&quot;text_english&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ammico.text.TextDetector.set_keys" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">set_keys</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Set the default keys for text analysis.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The dictionary with default text keys.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ammico/text.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">set_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set the default keys for text analysis.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: The dictionary with default text keys.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;text_language&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;text_english&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">params</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ammico.text.TextDetector.translate_text" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">translate_text</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Translate the detected text to English using the Translator object.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ammico/text.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">translate_text</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Translate the detected text to English using the Translator object.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">accepted</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Privacy disclosure not accepted - skipping text translation.&quot;</span>
        <span class="p">)</span>
    <span class="n">text_to_translate</span> <span class="o">=</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="p">[</span><span class="s2">&quot;text_truncated&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;text_truncated&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span>
        <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">translated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">translator</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">text_to_translate</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not translate the text with error </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="ne">Exception</span><span class="p">))</span>
        <span class="n">translated</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Skipping translation for this text.&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="p">[</span><span class="s2">&quot;text_language&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">translated</span><span class="o">.</span><span class="n">src</span> <span class="k">if</span> <span class="n">translated</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="p">[</span><span class="s2">&quot;text_english&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">translated</span><span class="o">.</span><span class="n">text</span> <span class="k">if</span> <span class="n">translated</span> <span class="k">else</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h2 id="ammico.text.privacy_disclosure" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">privacy_disclosure</span><span class="p">(</span><span class="n">accept_privacy</span><span class="o">=</span><span class="s1">&#39;PRIVACY_AMMICO&#39;</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Asks the user to accept the privacy statement.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>accept_privacy</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the disclosure variable (default: "PRIVACY_AMMICO").</p>
              </div>
            </td>
            <td>
                  <code>&#39;PRIVACY_AMMICO&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ammico/text.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">privacy_disclosure</span><span class="p">(</span><span class="n">accept_privacy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;PRIVACY_AMMICO&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Asks the user to accept the privacy statement.</span>

<span class="sd">    Args:</span>
<span class="sd">        accept_privacy (str): The name of the disclosure variable (default: &quot;PRIVACY_AMMICO&quot;).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">accept_privacy</span><span class="p">):</span>
        <span class="n">accepted</span> <span class="o">=</span> <span class="n">_ask_for_privacy_acceptance</span><span class="p">(</span><span class="n">accept_privacy</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">accept_privacy</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;False&quot;</span><span class="p">:</span>
        <span class="n">accepted</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">accept_privacy</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;True&quot;</span><span class="p">:</span>
        <span class="n">accepted</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;Could not determine privacy disclosure - skipping </span><span class="se">\</span>
<span class="s2">              text detection and translation.&quot;</span>
        <span class="p">)</span>
        <span class="n">accepted</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">accepted</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><h2 id="image-summary">Image Summary</h2>


<div class="doc doc-object doc-module">



<a id="ammico.image_summary"></a>
    <div class="doc doc-contents first">










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="ammico.image_summary.ImageSummaryDetector" class="doc doc-heading">
            <code>ImageSummaryDetector</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="AnalysisMethod (ammico.utils.AnalysisMethod)" href="#ammico.utils.AnalysisMethod">AnalysisMethod</a></code></p>










              <details class="mkdocstrings-source">
                <summary>Source code in <code>ammico/image_summary.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ImageSummaryDetector</span><span class="p">(</span><span class="n">AnalysisMethod</span><span class="p">):</span>
    <span class="n">token_prompt_config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;prompt&quot;</span><span class="p">:</span> <span class="s2">&quot;Describe this image.&quot;</span><span class="p">,</span> <span class="s2">&quot;max_new_tokens&quot;</span><span class="p">:</span> <span class="mi">256</span><span class="p">},</span>
            <span class="s2">&quot;questions&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;prompt&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;max_new_tokens&quot;</span><span class="p">:</span> <span class="mi">128</span><span class="p">},</span>
        <span class="p">},</span>
        <span class="s2">&quot;concise&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;prompt&quot;</span><span class="p">:</span> <span class="s2">&quot;Describe this image in one concise caption.&quot;</span><span class="p">,</span>
                <span class="s2">&quot;max_new_tokens&quot;</span><span class="p">:</span> <span class="mi">64</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;questions&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;prompt&quot;</span><span class="p">:</span> <span class="s2">&quot;Answer concisely: &quot;</span><span class="p">,</span> <span class="s2">&quot;max_new_tokens&quot;</span><span class="p">:</span> <span class="mi">128</span><span class="p">},</span>
        <span class="p">},</span>
    <span class="p">}</span>
    <span class="n">MAX_QUESTIONS_PER_IMAGE</span> <span class="o">=</span> <span class="mi">32</span>
    <span class="n">KEYS_BATCH_SIZE</span> <span class="o">=</span> <span class="mi">16</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">summary_model</span><span class="p">:</span> <span class="n">MultimodalSummaryModel</span><span class="p">,</span>
        <span class="n">subdict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Class for analysing images using QWEN-2.5-VL model.</span>
<span class="sd">        It provides methods for generating captions and answering questions about images.</span>

<span class="sd">        Args:</span>
<span class="sd">            summary_model ([type], optional): An instance of MultimodalSummaryModel to be used for analysis.</span>
<span class="sd">            subdict (dict, optional): Dictionary containing the image to be analysed. Defaults to {}.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">subdict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">subdict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">subdict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">summary_model</span> <span class="o">=</span> <span class="n">summary_model</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_load_pil_if_needed</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">,</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">&quot;RGB&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">filename</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">&quot;RGB&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;filename must be a path or PIL.Image&quot;</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_is_sequence_but_not_str</span><span class="p">(</span><span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;True for sequence-like but not a string/bytes/PIL.Image.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">_Sequence</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_prepare_inputs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">list_of_questions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">entry</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;filename&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;entry must contain key &#39;filename&#39;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">,</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">)):</span>
            <span class="n">images_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_pil_if_needed</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_sequence_but_not_str</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="n">images_context</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_load_pil_if_needed</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">filename</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Unsupported &#39;filename&#39; entry: expected path, PIL.Image, or sequence.&quot;</span>
            <span class="p">)</span>

        <span class="n">images_only_messages</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
                <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="o">*</span><span class="p">(</span>
                        <span class="p">[{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="n">img</span><span class="p">}</span> <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">images_context</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">images_context</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
                        <span class="k">else</span> <span class="p">[{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="n">images_context</span><span class="p">}]</span>
                    <span class="p">)</span>
                <span class="p">],</span>
            <span class="p">}</span>
        <span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">image_inputs</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">process_vision_info</span><span class="p">(</span><span class="n">images_only_messages</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image processing failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">list_of_questions</span><span class="p">:</span>
            <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="o">*</span><span class="p">(</span>
                            <span class="p">[</span>
                                <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="n">image</span><span class="p">}</span>
                                <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">images_context</span>
                            <span class="p">]</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">images_context</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
                            <span class="k">else</span> <span class="p">[{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="n">images_context</span><span class="p">}]</span>
                        <span class="p">),</span>
                        <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">q</span><span class="p">},</span>
                    <span class="p">],</span>
                <span class="p">}</span>
            <span class="p">]</span>
            <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary_model</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">apply_chat_template</span><span class="p">(</span>
                <span class="n">messages</span><span class="p">,</span> <span class="n">tokenize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_generation_prompt</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="n">texts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

        <span class="n">images_batch</span> <span class="o">=</span> <span class="p">[</span><span class="n">image_inputs</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary_model</span><span class="o">.</span><span class="n">processor</span><span class="p">(</span>
            <span class="n">text</span><span class="o">=</span><span class="n">texts</span><span class="p">,</span>
            <span class="n">images</span><span class="o">=</span><span class="n">images_batch</span><span class="p">,</span>
            <span class="n">padding</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">summary_model</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="k">return</span> <span class="n">inputs</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_analysis_type</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">analysis_type</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="s2">&quot;AnalysisType&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
        <span class="n">list_of_questions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
        <span class="n">max_questions_per_image</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">analysis_type</span><span class="p">,</span> <span class="n">AnalysisType</span><span class="p">):</span>
            <span class="n">analysis_type</span> <span class="o">=</span> <span class="n">analysis_type</span><span class="o">.</span><span class="n">value</span>

        <span class="n">allowed</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="s2">&quot;questions&quot;</span><span class="p">,</span> <span class="s2">&quot;summary_and_questions&quot;</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">analysis_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;analysis_type must be one of </span><span class="si">{</span><span class="n">allowed</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">list_of_questions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">list_of_questions</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;Are there people in the image?&quot;</span><span class="p">,</span>
                <span class="s2">&quot;What is this picture about?&quot;</span><span class="p">,</span>
            <span class="p">]</span>

        <span class="k">if</span> <span class="n">analysis_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;questions&quot;</span><span class="p">,</span> <span class="s2">&quot;summary_and_questions&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_of_questions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_questions_per_image</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Number of questions per image (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">list_of_questions</span><span class="p">)</span><span class="si">}</span><span class="s2">) exceeds safety cap (</span><span class="si">{</span><span class="n">max_questions_per_image</span><span class="si">}</span><span class="s2">). Reduce questions or increase max_questions_per_image.&quot;</span>
                <span class="p">)</span>

        <span class="n">is_summary</span> <span class="o">=</span> <span class="n">analysis_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="s2">&quot;summary_and_questions&quot;</span><span class="p">)</span>
        <span class="n">is_questions</span> <span class="o">=</span> <span class="n">analysis_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;questions&quot;</span><span class="p">,</span> <span class="s2">&quot;summary_and_questions&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">analysis_type</span><span class="p">,</span> <span class="n">list_of_questions</span><span class="p">,</span> <span class="n">is_summary</span><span class="p">,</span> <span class="n">is_questions</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analyse_image</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">entry</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">analysis_type</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">AnalysisType</span><span class="p">]</span> <span class="o">=</span> <span class="n">AnalysisType</span><span class="o">.</span><span class="n">SUMMARY_AND_QUESTIONS</span><span class="p">,</span>
        <span class="n">list_of_questions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_questions_per_image</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">MAX_QUESTIONS_PER_IMAGE</span><span class="p">,</span>
        <span class="n">is_concise_summary</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">is_concise_answer</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Analyse a single image entry. Returns dict with keys depending on analysis_type:</span>
<span class="sd">            - &#39;caption&#39; (str) if summary requested</span>
<span class="sd">            - &#39;vqa&#39; (dict) if questions requested</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span> <span class="o">=</span> <span class="n">entry</span>
        <span class="n">analysis_type</span><span class="p">,</span> <span class="n">list_of_questions</span><span class="p">,</span> <span class="n">is_summary</span><span class="p">,</span> <span class="n">is_questions</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validate_analysis_type</span><span class="p">(</span>
                <span class="n">analysis_type</span><span class="p">,</span> <span class="n">list_of_questions</span><span class="p">,</span> <span class="n">max_questions_per_image</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">is_summary</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">caps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_caption</span><span class="p">(</span>
                    <span class="n">entry</span><span class="p">,</span>
                    <span class="n">num_return_sequences</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">is_concise_summary</span><span class="o">=</span><span class="n">is_concise_summary</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="p">[</span><span class="s2">&quot;caption&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">caps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">caps</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Caption generation failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_questions</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">vqa_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_questions</span><span class="p">(</span>
                    <span class="n">list_of_questions</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">is_concise_answer</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="p">[</span><span class="s2">&quot;vqa&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vqa_map</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;VQA failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analyse_images_from_dict</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">analysis_type</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">AnalysisType</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">AnalysisType</span><span class="o">.</span><span class="n">SUMMARY_AND_QUESTIONS</span><span class="p">,</span>
        <span class="n">list_of_questions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_questions_per_image</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">MAX_QUESTIONS_PER_IMAGE</span><span class="p">,</span>
        <span class="n">keys_batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">KEYS_BATCH_SIZE</span><span class="p">,</span>
        <span class="n">is_concise_summary</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">is_concise_answer</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Analyse image with  model.</span>

<span class="sd">        Args:</span>
<span class="sd">            analysis_type (str): type of the analysis.</span>
<span class="sd">            list_of_questions (list[str]): list of questions.</span>
<span class="sd">            max_questions_per_image (int): maximum number of questions per image.</span>
<span class="sd">                We recommend to keep it low to avoid long processing times and high memory usage.</span>
<span class="sd">            keys_batch_size (int): number of images to process in a batch.</span>
<span class="sd">            is_concise_summary (bool): whether to generate concise summary.</span>
<span class="sd">            is_concise_answer (bool): whether to generate concise answers.</span>
<span class="sd">        Returns:</span>
<span class="sd">            self.subdict (dict): dictionary with analysis results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: add option to ask multiple questions per image as one batch.</span>
        <span class="n">analysis_type</span><span class="p">,</span> <span class="n">list_of_questions</span><span class="p">,</span> <span class="n">is_summary</span><span class="p">,</span> <span class="n">is_questions</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validate_analysis_type</span><span class="p">(</span>
                <span class="n">analysis_type</span><span class="p">,</span> <span class="n">list_of_questions</span><span class="p">,</span> <span class="n">max_questions_per_image</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">batch_start</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">),</span> <span class="n">keys_batch_size</span><span class="p">):</span>
            <span class="n">batch_keys</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="n">batch_start</span> <span class="p">:</span> <span class="n">batch_start</span> <span class="o">+</span> <span class="n">keys_batch_size</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">batch_keys</span><span class="p">:</span>
                <span class="n">entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">is_summary</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">caps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_caption</span><span class="p">(</span>
                            <span class="n">entry</span><span class="p">,</span>
                            <span class="n">num_return_sequences</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                            <span class="n">is_concise_summary</span><span class="o">=</span><span class="n">is_concise_summary</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;caption&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">caps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">caps</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Caption generation failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">is_questions</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">vqa_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_questions</span><span class="p">(</span>
                            <span class="n">list_of_questions</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">is_concise_answer</span>
                        <span class="p">)</span>
                        <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;vqa&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vqa_map</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;VQA failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_caption</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">entry</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">num_return_sequences</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">is_concise_summary</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create caption for image. Depending on is_concise_summary it will be either concise or detailed.</span>

<span class="sd">        Args:</span>
<span class="sd">            entry (dict): dictionary containing the image to be captioned.</span>
<span class="sd">            num_return_sequences (int): number of captions to generate.</span>
<span class="sd">            is_concise_summary (bool): whether to generate concise summary.</span>

<span class="sd">        Returns:</span>
<span class="sd">            results (list[str]): list of generated captions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">token_prompt_config</span><span class="p">[</span>
            <span class="s2">&quot;concise&quot;</span> <span class="k">if</span> <span class="n">is_concise_summary</span> <span class="k">else</span> <span class="s2">&quot;default&quot;</span>
        <span class="p">][</span><span class="s2">&quot;summary&quot;</span><span class="p">][</span><span class="s2">&quot;prompt&quot;</span><span class="p">]</span>
        <span class="n">max_new_tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">token_prompt_config</span><span class="p">[</span>
            <span class="s2">&quot;concise&quot;</span> <span class="k">if</span> <span class="n">is_concise_summary</span> <span class="k">else</span> <span class="s2">&quot;default&quot;</span>
        <span class="p">][</span><span class="s2">&quot;summary&quot;</span><span class="p">][</span><span class="s2">&quot;max_new_tokens&quot;</span><span class="p">]</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_inputs</span><span class="p">([</span><span class="n">prompt</span><span class="p">],</span> <span class="n">entry</span><span class="p">)</span>

        <span class="n">gen_conf</span> <span class="o">=</span> <span class="n">GenerationConfig</span><span class="p">(</span>
            <span class="n">max_new_tokens</span><span class="o">=</span><span class="n">max_new_tokens</span><span class="p">,</span>
            <span class="n">do_sample</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">num_return_sequences</span><span class="o">=</span><span class="n">num_return_sequences</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">inference_mode</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary_model</span><span class="o">.</span><span class="n">device</span> <span class="o">==</span> <span class="s2">&quot;cuda&quot;</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">autocast</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span><span class="p">,</span> <span class="n">enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                        <span class="n">generated_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary_model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span>
                            <span class="o">**</span><span class="n">inputs</span><span class="p">,</span> <span class="n">generation_config</span><span class="o">=</span><span class="n">gen_conf</span>
                        <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">generated_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary_model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span>
                        <span class="o">**</span><span class="n">inputs</span><span class="p">,</span> <span class="n">generation_config</span><span class="o">=</span><span class="n">gen_conf</span>
                    <span class="p">)</span>
            <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Retry without autocast failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Attempting cudnn-disabled retry.&quot;</span>
                <span class="p">)</span>
                <span class="n">cudnn_was_enabled</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">cudnn</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="ow">and</span> <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">cudnn</span><span class="o">.</span><span class="n">enabled</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">cudnn_was_enabled</span><span class="p">:</span>
                    <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">cudnn</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">generated_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary_model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span>
                        <span class="o">**</span><span class="n">inputs</span><span class="p">,</span> <span class="n">generation_config</span><span class="o">=</span><span class="n">gen_conf</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">retry_error</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Failed to generate ids after retry: </span><span class="si">{</span><span class="n">retry_error</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">retry_error</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">cudnn_was_enabled</span><span class="p">:</span>
                        <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">cudnn</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">decoded</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s2">&quot;input_ids&quot;</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
            <span class="n">in_ids</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span>
            <span class="n">trimmed</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">out_ids</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">inp_ids</span><span class="p">)</span> <span class="p">:]</span>
                <span class="k">for</span> <span class="n">inp_ids</span><span class="p">,</span> <span class="n">out_ids</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">in_ids</span><span class="p">,</span> <span class="n">generated_ids</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="n">decoded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary_model</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">batch_decode</span><span class="p">(</span>
                <span class="n">trimmed</span><span class="p">,</span> <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">clean_up_tokenization_spaces</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">decoded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary_model</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">batch_decode</span><span class="p">(</span>
                <span class="n">generated_ids</span><span class="p">,</span>
                <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">clean_up_tokenization_spaces</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">decoded</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">results</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_clean_list_of_questions</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">list_of_questions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clean the list of questions to contain correctly formatted strings.&quot;&quot;&quot;</span>
        <span class="c1"># remove all None or empty questions</span>
        <span class="n">list_of_questions</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">list_of_questions</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">and</span> <span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
        <span class="c1"># ensure each question ends with a question mark</span>
        <span class="n">list_of_questions</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;?&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;?&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">list_of_questions</span>
        <span class="p">]</span>
        <span class="c1"># ensure each question starts with the prompt</span>
        <span class="n">list_of_questions</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">i</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prompt</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span> <span class="k">else</span> <span class="n">prompt</span> <span class="o">+</span> <span class="n">i</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">list_of_questions</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">list_of_questions</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">answer_questions</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">list_of_questions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">entry</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">is_concise_answer</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create answers for list of questions about image.</span>
<span class="sd">        Args:</span>
<span class="sd">            list_of_questions (list[str]): list of questions.</span>
<span class="sd">            entry (dict): dictionary containing the image to be captioned.</span>
<span class="sd">            is_concise_answer (bool): whether to generate concise answers.</span>
<span class="sd">        Returns:</span>
<span class="sd">            answers (list[str]): list of answers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">token_prompt_config</span><span class="p">[</span>
            <span class="s2">&quot;concise&quot;</span> <span class="k">if</span> <span class="n">is_concise_answer</span> <span class="k">else</span> <span class="s2">&quot;default&quot;</span>
        <span class="p">][</span><span class="s2">&quot;questions&quot;</span><span class="p">][</span><span class="s2">&quot;prompt&quot;</span><span class="p">]</span>
        <span class="n">max_new_tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">token_prompt_config</span><span class="p">[</span>
            <span class="s2">&quot;concise&quot;</span> <span class="k">if</span> <span class="n">is_concise_answer</span> <span class="k">else</span> <span class="s2">&quot;default&quot;</span>
        <span class="p">][</span><span class="s2">&quot;questions&quot;</span><span class="p">][</span><span class="s2">&quot;max_new_tokens&quot;</span><span class="p">]</span>

        <span class="n">list_of_questions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clean_list_of_questions</span><span class="p">(</span><span class="n">list_of_questions</span><span class="p">,</span> <span class="n">prompt</span><span class="p">)</span>
        <span class="n">gen_conf</span> <span class="o">=</span> <span class="n">GenerationConfig</span><span class="p">(</span><span class="n">max_new_tokens</span><span class="o">=</span><span class="n">max_new_tokens</span><span class="p">,</span> <span class="n">do_sample</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">question_chunk_size</span> <span class="o">=</span> <span class="mi">8</span>
        <span class="n">answers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_of_questions</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">question_chunk_size</span><span class="p">):</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="n">list_of_questions</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">question_chunk_size</span><span class="p">]</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_inputs</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">inference_mode</span><span class="p">():</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary_model</span><span class="o">.</span><span class="n">device</span> <span class="o">==</span> <span class="s2">&quot;cuda&quot;</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">autocast</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span><span class="p">,</span> <span class="n">enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                        <span class="n">out_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary_model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span>
                            <span class="o">**</span><span class="n">inputs</span><span class="p">,</span> <span class="n">generation_config</span><span class="o">=</span><span class="n">gen_conf</span>
                        <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary_model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span>
                        <span class="o">**</span><span class="n">inputs</span><span class="p">,</span> <span class="n">generation_config</span><span class="o">=</span><span class="n">gen_conf</span>
                    <span class="p">)</span>

            <span class="k">if</span> <span class="s2">&quot;input_ids&quot;</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
                <span class="n">in_ids</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span>
                <span class="n">trimmed_batch</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">out_row</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">inp_row</span><span class="p">)</span> <span class="p">:]</span> <span class="k">for</span> <span class="n">inp_row</span><span class="p">,</span> <span class="n">out_row</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">in_ids</span><span class="p">,</span> <span class="n">out_ids</span><span class="p">)</span>
                <span class="p">]</span>
                <span class="n">decoded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary_model</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">batch_decode</span><span class="p">(</span>
                    <span class="n">trimmed_batch</span><span class="p">,</span>
                    <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">clean_up_tokenization_spaces</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">decoded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary_model</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">batch_decode</span><span class="p">(</span>
                    <span class="n">out_ids</span><span class="p">,</span>
                    <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">clean_up_tokenization_spaces</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="n">answers</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">d</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">decoded</span><span class="p">])</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">answers</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_of_questions</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Expected </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">list_of_questions</span><span class="p">)</span><span class="si">}</span><span class="s2"> answers, but got </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">answers</span><span class="p">)</span><span class="si">}</span><span class="s2">, try varying amount of questions&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">answers</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="ammico.image_summary.ImageSummaryDetector.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">summary_model</span><span class="p">,</span> <span class="n">subdict</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Class for analysing images using QWEN-2.5-VL model.
It provides methods for generating captions and answering questions about images.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>summary_model</code>
            </td>
            <td>
                  <code>[<span title="type">type</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An instance of MultimodalSummaryModel to be used for analysis.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>subdict</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing the image to be analysed. Defaults to {}.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>None.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ammico/image_summary.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">summary_model</span><span class="p">:</span> <span class="n">MultimodalSummaryModel</span><span class="p">,</span>
    <span class="n">subdict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class for analysing images using QWEN-2.5-VL model.</span>
<span class="sd">    It provides methods for generating captions and answering questions about images.</span>

<span class="sd">    Args:</span>
<span class="sd">        summary_model ([type], optional): An instance of MultimodalSummaryModel to be used for analysis.</span>
<span class="sd">        subdict (dict, optional): Dictionary containing the image to be analysed. Defaults to {}.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">subdict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">subdict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">subdict</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">summary_model</span> <span class="o">=</span> <span class="n">summary_model</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ammico.image_summary.ImageSummaryDetector.analyse_image" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">analyse_image</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">analysis_type</span><span class="o">=</span><span class="n">AnalysisType</span><span class="o">.</span><span class="n">SUMMARY_AND_QUESTIONS</span><span class="p">,</span> <span class="n">list_of_questions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_questions_per_image</span><span class="o">=</span><span class="n">MAX_QUESTIONS_PER_IMAGE</span><span class="p">,</span> <span class="n">is_concise_summary</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">is_concise_answer</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Analyse a single image entry. Returns dict with keys depending on analysis_type:
    - 'caption' (str) if summary requested
    - 'vqa' (dict) if questions requested</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ammico/image_summary.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">analyse_image</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">entry</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">analysis_type</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">AnalysisType</span><span class="p">]</span> <span class="o">=</span> <span class="n">AnalysisType</span><span class="o">.</span><span class="n">SUMMARY_AND_QUESTIONS</span><span class="p">,</span>
    <span class="n">list_of_questions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">max_questions_per_image</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">MAX_QUESTIONS_PER_IMAGE</span><span class="p">,</span>
    <span class="n">is_concise_summary</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">is_concise_answer</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Analyse a single image entry. Returns dict with keys depending on analysis_type:</span>
<span class="sd">        - &#39;caption&#39; (str) if summary requested</span>
<span class="sd">        - &#39;vqa&#39; (dict) if questions requested</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span> <span class="o">=</span> <span class="n">entry</span>
    <span class="n">analysis_type</span><span class="p">,</span> <span class="n">list_of_questions</span><span class="p">,</span> <span class="n">is_summary</span><span class="p">,</span> <span class="n">is_questions</span> <span class="o">=</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_analysis_type</span><span class="p">(</span>
            <span class="n">analysis_type</span><span class="p">,</span> <span class="n">list_of_questions</span><span class="p">,</span> <span class="n">max_questions_per_image</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">is_summary</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">caps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_caption</span><span class="p">(</span>
                <span class="n">entry</span><span class="p">,</span>
                <span class="n">num_return_sequences</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">is_concise_summary</span><span class="o">=</span><span class="n">is_concise_summary</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="p">[</span><span class="s2">&quot;caption&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">caps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">caps</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Caption generation failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">is_questions</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">vqa_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_questions</span><span class="p">(</span>
                <span class="n">list_of_questions</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">is_concise_answer</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="p">[</span><span class="s2">&quot;vqa&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vqa_map</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;VQA failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ammico.image_summary.ImageSummaryDetector.analyse_images_from_dict" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">analyse_images_from_dict</span><span class="p">(</span><span class="n">analysis_type</span><span class="o">=</span><span class="n">AnalysisType</span><span class="o">.</span><span class="n">SUMMARY_AND_QUESTIONS</span><span class="p">,</span> <span class="n">list_of_questions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_questions_per_image</span><span class="o">=</span><span class="n">MAX_QUESTIONS_PER_IMAGE</span><span class="p">,</span> <span class="n">keys_batch_size</span><span class="o">=</span><span class="n">KEYS_BATCH_SIZE</span><span class="p">,</span> <span class="n">is_concise_summary</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">is_concise_answer</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Analyse image with  model.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>analysis_type</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>type of the analysis.</p>
              </div>
            </td>
            <td>
                  <code><span title="ammico.utils.AnalysisType.SUMMARY_AND_QUESTIONS">SUMMARY_AND_QUESTIONS</span></code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>list_of_questions</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list of questions.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_questions_per_image</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>maximum number of questions per image.
We recommend to keep it low to avoid long processing times and high memory usage.</p>
              </div>
            </td>
            <td>
                  <code><span title="ammico.image_summary.ImageSummaryDetector.MAX_QUESTIONS_PER_IMAGE">MAX_QUESTIONS_PER_IMAGE</span></code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>keys_batch_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>number of images to process in a batch.</p>
              </div>
            </td>
            <td>
                  <code><span title="ammico.image_summary.ImageSummaryDetector.KEYS_BATCH_SIZE">KEYS_BATCH_SIZE</span></code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>is_concise_summary</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>whether to generate concise summary.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>is_concise_answer</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>whether to generate concise answers.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Returns:
    self.subdict (dict): dictionary with analysis results.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ammico/image_summary.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">analyse_images_from_dict</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">analysis_type</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">AnalysisType</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">AnalysisType</span><span class="o">.</span><span class="n">SUMMARY_AND_QUESTIONS</span><span class="p">,</span>
    <span class="n">list_of_questions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">max_questions_per_image</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">MAX_QUESTIONS_PER_IMAGE</span><span class="p">,</span>
    <span class="n">keys_batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">KEYS_BATCH_SIZE</span><span class="p">,</span>
    <span class="n">is_concise_summary</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">is_concise_answer</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Analyse image with  model.</span>

<span class="sd">    Args:</span>
<span class="sd">        analysis_type (str): type of the analysis.</span>
<span class="sd">        list_of_questions (list[str]): list of questions.</span>
<span class="sd">        max_questions_per_image (int): maximum number of questions per image.</span>
<span class="sd">            We recommend to keep it low to avoid long processing times and high memory usage.</span>
<span class="sd">        keys_batch_size (int): number of images to process in a batch.</span>
<span class="sd">        is_concise_summary (bool): whether to generate concise summary.</span>
<span class="sd">        is_concise_answer (bool): whether to generate concise answers.</span>
<span class="sd">    Returns:</span>
<span class="sd">        self.subdict (dict): dictionary with analysis results.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: add option to ask multiple questions per image as one batch.</span>
    <span class="n">analysis_type</span><span class="p">,</span> <span class="n">list_of_questions</span><span class="p">,</span> <span class="n">is_summary</span><span class="p">,</span> <span class="n">is_questions</span> <span class="o">=</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_analysis_type</span><span class="p">(</span>
            <span class="n">analysis_type</span><span class="p">,</span> <span class="n">list_of_questions</span><span class="p">,</span> <span class="n">max_questions_per_image</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">batch_start</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">),</span> <span class="n">keys_batch_size</span><span class="p">):</span>
        <span class="n">batch_keys</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="n">batch_start</span> <span class="p">:</span> <span class="n">batch_start</span> <span class="o">+</span> <span class="n">keys_batch_size</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">batch_keys</span><span class="p">:</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">is_summary</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">caps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_caption</span><span class="p">(</span>
                        <span class="n">entry</span><span class="p">,</span>
                        <span class="n">num_return_sequences</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">is_concise_summary</span><span class="o">=</span><span class="n">is_concise_summary</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;caption&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">caps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">caps</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Caption generation failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">is_questions</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">vqa_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_questions</span><span class="p">(</span>
                        <span class="n">list_of_questions</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">is_concise_answer</span>
                    <span class="p">)</span>
                    <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;vqa&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vqa_map</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;VQA failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ammico.image_summary.ImageSummaryDetector.answer_questions" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">answer_questions</span><span class="p">(</span><span class="n">list_of_questions</span><span class="p">,</span> <span class="n">entry</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">is_concise_answer</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Create answers for list of questions about image.
Args:
    list_of_questions (list[str]): list of questions.
    entry (dict): dictionary containing the image to be captioned.
    is_concise_answer (bool): whether to generate concise answers.
Returns:
    answers (list[str]): list of answers.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ammico/image_summary.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">answer_questions</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">list_of_questions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">entry</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">is_concise_answer</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create answers for list of questions about image.</span>
<span class="sd">    Args:</span>
<span class="sd">        list_of_questions (list[str]): list of questions.</span>
<span class="sd">        entry (dict): dictionary containing the image to be captioned.</span>
<span class="sd">        is_concise_answer (bool): whether to generate concise answers.</span>
<span class="sd">    Returns:</span>
<span class="sd">        answers (list[str]): list of answers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">token_prompt_config</span><span class="p">[</span>
        <span class="s2">&quot;concise&quot;</span> <span class="k">if</span> <span class="n">is_concise_answer</span> <span class="k">else</span> <span class="s2">&quot;default&quot;</span>
    <span class="p">][</span><span class="s2">&quot;questions&quot;</span><span class="p">][</span><span class="s2">&quot;prompt&quot;</span><span class="p">]</span>
    <span class="n">max_new_tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">token_prompt_config</span><span class="p">[</span>
        <span class="s2">&quot;concise&quot;</span> <span class="k">if</span> <span class="n">is_concise_answer</span> <span class="k">else</span> <span class="s2">&quot;default&quot;</span>
    <span class="p">][</span><span class="s2">&quot;questions&quot;</span><span class="p">][</span><span class="s2">&quot;max_new_tokens&quot;</span><span class="p">]</span>

    <span class="n">list_of_questions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clean_list_of_questions</span><span class="p">(</span><span class="n">list_of_questions</span><span class="p">,</span> <span class="n">prompt</span><span class="p">)</span>
    <span class="n">gen_conf</span> <span class="o">=</span> <span class="n">GenerationConfig</span><span class="p">(</span><span class="n">max_new_tokens</span><span class="o">=</span><span class="n">max_new_tokens</span><span class="p">,</span> <span class="n">do_sample</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">question_chunk_size</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="n">answers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_of_questions</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">question_chunk_size</span><span class="p">):</span>
        <span class="n">chunk</span> <span class="o">=</span> <span class="n">list_of_questions</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">question_chunk_size</span><span class="p">]</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_inputs</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">inference_mode</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary_model</span><span class="o">.</span><span class="n">device</span> <span class="o">==</span> <span class="s2">&quot;cuda&quot;</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">autocast</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span><span class="p">,</span> <span class="n">enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                    <span class="n">out_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary_model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span>
                        <span class="o">**</span><span class="n">inputs</span><span class="p">,</span> <span class="n">generation_config</span><span class="o">=</span><span class="n">gen_conf</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary_model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span>
                    <span class="o">**</span><span class="n">inputs</span><span class="p">,</span> <span class="n">generation_config</span><span class="o">=</span><span class="n">gen_conf</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;input_ids&quot;</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
            <span class="n">in_ids</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span>
            <span class="n">trimmed_batch</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">out_row</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">inp_row</span><span class="p">)</span> <span class="p">:]</span> <span class="k">for</span> <span class="n">inp_row</span><span class="p">,</span> <span class="n">out_row</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">in_ids</span><span class="p">,</span> <span class="n">out_ids</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="n">decoded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary_model</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">batch_decode</span><span class="p">(</span>
                <span class="n">trimmed_batch</span><span class="p">,</span>
                <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">clean_up_tokenization_spaces</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">decoded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary_model</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">batch_decode</span><span class="p">(</span>
                <span class="n">out_ids</span><span class="p">,</span>
                <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">clean_up_tokenization_spaces</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">answers</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">d</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">decoded</span><span class="p">])</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">answers</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_of_questions</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Expected </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">list_of_questions</span><span class="p">)</span><span class="si">}</span><span class="s2"> answers, but got </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">answers</span><span class="p">)</span><span class="si">}</span><span class="s2">, try varying amount of questions&quot;</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">answers</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ammico.image_summary.ImageSummaryDetector.generate_caption" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">generate_caption</span><span class="p">(</span><span class="n">entry</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_return_sequences</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">is_concise_summary</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Create caption for image. Depending on is_concise_summary it will be either concise or detailed.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>entry</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dictionary containing the image to be captioned.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>num_return_sequences</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>number of captions to generate.</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>is_concise_summary</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>whether to generate concise summary.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>results</code></td>            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list of generated captions.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ammico/image_summary.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">generate_caption</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">entry</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">num_return_sequences</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">is_concise_summary</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create caption for image. Depending on is_concise_summary it will be either concise or detailed.</span>

<span class="sd">    Args:</span>
<span class="sd">        entry (dict): dictionary containing the image to be captioned.</span>
<span class="sd">        num_return_sequences (int): number of captions to generate.</span>
<span class="sd">        is_concise_summary (bool): whether to generate concise summary.</span>

<span class="sd">    Returns:</span>
<span class="sd">        results (list[str]): list of generated captions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">token_prompt_config</span><span class="p">[</span>
        <span class="s2">&quot;concise&quot;</span> <span class="k">if</span> <span class="n">is_concise_summary</span> <span class="k">else</span> <span class="s2">&quot;default&quot;</span>
    <span class="p">][</span><span class="s2">&quot;summary&quot;</span><span class="p">][</span><span class="s2">&quot;prompt&quot;</span><span class="p">]</span>
    <span class="n">max_new_tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">token_prompt_config</span><span class="p">[</span>
        <span class="s2">&quot;concise&quot;</span> <span class="k">if</span> <span class="n">is_concise_summary</span> <span class="k">else</span> <span class="s2">&quot;default&quot;</span>
    <span class="p">][</span><span class="s2">&quot;summary&quot;</span><span class="p">][</span><span class="s2">&quot;max_new_tokens&quot;</span><span class="p">]</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_inputs</span><span class="p">([</span><span class="n">prompt</span><span class="p">],</span> <span class="n">entry</span><span class="p">)</span>

    <span class="n">gen_conf</span> <span class="o">=</span> <span class="n">GenerationConfig</span><span class="p">(</span>
        <span class="n">max_new_tokens</span><span class="o">=</span><span class="n">max_new_tokens</span><span class="p">,</span>
        <span class="n">do_sample</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">num_return_sequences</span><span class="o">=</span><span class="n">num_return_sequences</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">inference_mode</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary_model</span><span class="o">.</span><span class="n">device</span> <span class="o">==</span> <span class="s2">&quot;cuda&quot;</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">autocast</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span><span class="p">,</span> <span class="n">enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                    <span class="n">generated_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary_model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span>
                        <span class="o">**</span><span class="n">inputs</span><span class="p">,</span> <span class="n">generation_config</span><span class="o">=</span><span class="n">gen_conf</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">generated_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary_model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span>
                    <span class="o">**</span><span class="n">inputs</span><span class="p">,</span> <span class="n">generation_config</span><span class="o">=</span><span class="n">gen_conf</span>
                <span class="p">)</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Retry without autocast failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Attempting cudnn-disabled retry.&quot;</span>
            <span class="p">)</span>
            <span class="n">cudnn_was_enabled</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">cudnn</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="ow">and</span> <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">cudnn</span><span class="o">.</span><span class="n">enabled</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">cudnn_was_enabled</span><span class="p">:</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">cudnn</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">generated_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary_model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span>
                    <span class="o">**</span><span class="n">inputs</span><span class="p">,</span> <span class="n">generation_config</span><span class="o">=</span><span class="n">gen_conf</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">retry_error</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Failed to generate ids after retry: </span><span class="si">{</span><span class="n">retry_error</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">retry_error</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cudnn_was_enabled</span><span class="p">:</span>
                    <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">cudnn</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">decoded</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="s2">&quot;input_ids&quot;</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
        <span class="n">in_ids</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span>
        <span class="n">trimmed</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">out_ids</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">inp_ids</span><span class="p">)</span> <span class="p">:]</span>
            <span class="k">for</span> <span class="n">inp_ids</span><span class="p">,</span> <span class="n">out_ids</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">in_ids</span><span class="p">,</span> <span class="n">generated_ids</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">decoded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary_model</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">batch_decode</span><span class="p">(</span>
            <span class="n">trimmed</span><span class="p">,</span> <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">clean_up_tokenization_spaces</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">decoded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary_model</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">batch_decode</span><span class="p">(</span>
            <span class="n">generated_ids</span><span class="p">,</span>
            <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">clean_up_tokenization_spaces</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">decoded</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">results</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div><h2 id="video-summary">Video Summary</h2>


<div class="doc doc-object doc-module">



<a id="ammico.video_summary"></a>
    <div class="doc doc-contents first">










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="ammico.video_summary.VideoSummaryDetector" class="doc doc-heading">
            <code>VideoSummaryDetector</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="AnalysisMethod (ammico.utils.AnalysisMethod)" href="#ammico.utils.AnalysisMethod">AnalysisMethod</a></code></p>










              <details class="mkdocstrings-source">
                <summary>Source code in <code>ammico/video_summary.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  37</span>
<span class="normal">  38</span>
<span class="normal">  39</span>
<span class="normal">  40</span>
<span class="normal">  41</span>
<span class="normal">  42</span>
<span class="normal">  43</span>
<span class="normal">  44</span>
<span class="normal">  45</span>
<span class="normal">  46</span>
<span class="normal">  47</span>
<span class="normal">  48</span>
<span class="normal">  49</span>
<span class="normal">  50</span>
<span class="normal">  51</span>
<span class="normal">  52</span>
<span class="normal">  53</span>
<span class="normal">  54</span>
<span class="normal">  55</span>
<span class="normal">  56</span>
<span class="normal">  57</span>
<span class="normal">  58</span>
<span class="normal">  59</span>
<span class="normal">  60</span>
<span class="normal">  61</span>
<span class="normal">  62</span>
<span class="normal">  63</span>
<span class="normal">  64</span>
<span class="normal">  65</span>
<span class="normal">  66</span>
<span class="normal">  67</span>
<span class="normal">  68</span>
<span class="normal">  69</span>
<span class="normal">  70</span>
<span class="normal">  71</span>
<span class="normal">  72</span>
<span class="normal">  73</span>
<span class="normal">  74</span>
<span class="normal">  75</span>
<span class="normal">  76</span>
<span class="normal">  77</span>
<span class="normal">  78</span>
<span class="normal">  79</span>
<span class="normal">  80</span>
<span class="normal">  81</span>
<span class="normal">  82</span>
<span class="normal">  83</span>
<span class="normal">  84</span>
<span class="normal">  85</span>
<span class="normal">  86</span>
<span class="normal">  87</span>
<span class="normal">  88</span>
<span class="normal">  89</span>
<span class="normal">  90</span>
<span class="normal">  91</span>
<span class="normal">  92</span>
<span class="normal">  93</span>
<span class="normal">  94</span>
<span class="normal">  95</span>
<span class="normal">  96</span>
<span class="normal">  97</span>
<span class="normal">  98</span>
<span class="normal">  99</span>
<span class="normal"> 100</span>
<span class="normal"> 101</span>
<span class="normal"> 102</span>
<span class="normal"> 103</span>
<span class="normal"> 104</span>
<span class="normal"> 105</span>
<span class="normal"> 106</span>
<span class="normal"> 107</span>
<span class="normal"> 108</span>
<span class="normal"> 109</span>
<span class="normal"> 110</span>
<span class="normal"> 111</span>
<span class="normal"> 112</span>
<span class="normal"> 113</span>
<span class="normal"> 114</span>
<span class="normal"> 115</span>
<span class="normal"> 116</span>
<span class="normal"> 117</span>
<span class="normal"> 118</span>
<span class="normal"> 119</span>
<span class="normal"> 120</span>
<span class="normal"> 121</span>
<span class="normal"> 122</span>
<span class="normal"> 123</span>
<span class="normal"> 124</span>
<span class="normal"> 125</span>
<span class="normal"> 126</span>
<span class="normal"> 127</span>
<span class="normal"> 128</span>
<span class="normal"> 129</span>
<span class="normal"> 130</span>
<span class="normal"> 131</span>
<span class="normal"> 132</span>
<span class="normal"> 133</span>
<span class="normal"> 134</span>
<span class="normal"> 135</span>
<span class="normal"> 136</span>
<span class="normal"> 137</span>
<span class="normal"> 138</span>
<span class="normal"> 139</span>
<span class="normal"> 140</span>
<span class="normal"> 141</span>
<span class="normal"> 142</span>
<span class="normal"> 143</span>
<span class="normal"> 144</span>
<span class="normal"> 145</span>
<span class="normal"> 146</span>
<span class="normal"> 147</span>
<span class="normal"> 148</span>
<span class="normal"> 149</span>
<span class="normal"> 150</span>
<span class="normal"> 151</span>
<span class="normal"> 152</span>
<span class="normal"> 153</span>
<span class="normal"> 154</span>
<span class="normal"> 155</span>
<span class="normal"> 156</span>
<span class="normal"> 157</span>
<span class="normal"> 158</span>
<span class="normal"> 159</span>
<span class="normal"> 160</span>
<span class="normal"> 161</span>
<span class="normal"> 162</span>
<span class="normal"> 163</span>
<span class="normal"> 164</span>
<span class="normal"> 165</span>
<span class="normal"> 166</span>
<span class="normal"> 167</span>
<span class="normal"> 168</span>
<span class="normal"> 169</span>
<span class="normal"> 170</span>
<span class="normal"> 171</span>
<span class="normal"> 172</span>
<span class="normal"> 173</span>
<span class="normal"> 174</span>
<span class="normal"> 175</span>
<span class="normal"> 176</span>
<span class="normal"> 177</span>
<span class="normal"> 178</span>
<span class="normal"> 179</span>
<span class="normal"> 180</span>
<span class="normal"> 181</span>
<span class="normal"> 182</span>
<span class="normal"> 183</span>
<span class="normal"> 184</span>
<span class="normal"> 185</span>
<span class="normal"> 186</span>
<span class="normal"> 187</span>
<span class="normal"> 188</span>
<span class="normal"> 189</span>
<span class="normal"> 190</span>
<span class="normal"> 191</span>
<span class="normal"> 192</span>
<span class="normal"> 193</span>
<span class="normal"> 194</span>
<span class="normal"> 195</span>
<span class="normal"> 196</span>
<span class="normal"> 197</span>
<span class="normal"> 198</span>
<span class="normal"> 199</span>
<span class="normal"> 200</span>
<span class="normal"> 201</span>
<span class="normal"> 202</span>
<span class="normal"> 203</span>
<span class="normal"> 204</span>
<span class="normal"> 205</span>
<span class="normal"> 206</span>
<span class="normal"> 207</span>
<span class="normal"> 208</span>
<span class="normal"> 209</span>
<span class="normal"> 210</span>
<span class="normal"> 211</span>
<span class="normal"> 212</span>
<span class="normal"> 213</span>
<span class="normal"> 214</span>
<span class="normal"> 215</span>
<span class="normal"> 216</span>
<span class="normal"> 217</span>
<span class="normal"> 218</span>
<span class="normal"> 219</span>
<span class="normal"> 220</span>
<span class="normal"> 221</span>
<span class="normal"> 222</span>
<span class="normal"> 223</span>
<span class="normal"> 224</span>
<span class="normal"> 225</span>
<span class="normal"> 226</span>
<span class="normal"> 227</span>
<span class="normal"> 228</span>
<span class="normal"> 229</span>
<span class="normal"> 230</span>
<span class="normal"> 231</span>
<span class="normal"> 232</span>
<span class="normal"> 233</span>
<span class="normal"> 234</span>
<span class="normal"> 235</span>
<span class="normal"> 236</span>
<span class="normal"> 237</span>
<span class="normal"> 238</span>
<span class="normal"> 239</span>
<span class="normal"> 240</span>
<span class="normal"> 241</span>
<span class="normal"> 242</span>
<span class="normal"> 243</span>
<span class="normal"> 244</span>
<span class="normal"> 245</span>
<span class="normal"> 246</span>
<span class="normal"> 247</span>
<span class="normal"> 248</span>
<span class="normal"> 249</span>
<span class="normal"> 250</span>
<span class="normal"> 251</span>
<span class="normal"> 252</span>
<span class="normal"> 253</span>
<span class="normal"> 254</span>
<span class="normal"> 255</span>
<span class="normal"> 256</span>
<span class="normal"> 257</span>
<span class="normal"> 258</span>
<span class="normal"> 259</span>
<span class="normal"> 260</span>
<span class="normal"> 261</span>
<span class="normal"> 262</span>
<span class="normal"> 263</span>
<span class="normal"> 264</span>
<span class="normal"> 265</span>
<span class="normal"> 266</span>
<span class="normal"> 267</span>
<span class="normal"> 268</span>
<span class="normal"> 269</span>
<span class="normal"> 270</span>
<span class="normal"> 271</span>
<span class="normal"> 272</span>
<span class="normal"> 273</span>
<span class="normal"> 274</span>
<span class="normal"> 275</span>
<span class="normal"> 276</span>
<span class="normal"> 277</span>
<span class="normal"> 278</span>
<span class="normal"> 279</span>
<span class="normal"> 280</span>
<span class="normal"> 281</span>
<span class="normal"> 282</span>
<span class="normal"> 283</span>
<span class="normal"> 284</span>
<span class="normal"> 285</span>
<span class="normal"> 286</span>
<span class="normal"> 287</span>
<span class="normal"> 288</span>
<span class="normal"> 289</span>
<span class="normal"> 290</span>
<span class="normal"> 291</span>
<span class="normal"> 292</span>
<span class="normal"> 293</span>
<span class="normal"> 294</span>
<span class="normal"> 295</span>
<span class="normal"> 296</span>
<span class="normal"> 297</span>
<span class="normal"> 298</span>
<span class="normal"> 299</span>
<span class="normal"> 300</span>
<span class="normal"> 301</span>
<span class="normal"> 302</span>
<span class="normal"> 303</span>
<span class="normal"> 304</span>
<span class="normal"> 305</span>
<span class="normal"> 306</span>
<span class="normal"> 307</span>
<span class="normal"> 308</span>
<span class="normal"> 309</span>
<span class="normal"> 310</span>
<span class="normal"> 311</span>
<span class="normal"> 312</span>
<span class="normal"> 313</span>
<span class="normal"> 314</span>
<span class="normal"> 315</span>
<span class="normal"> 316</span>
<span class="normal"> 317</span>
<span class="normal"> 318</span>
<span class="normal"> 319</span>
<span class="normal"> 320</span>
<span class="normal"> 321</span>
<span class="normal"> 322</span>
<span class="normal"> 323</span>
<span class="normal"> 324</span>
<span class="normal"> 325</span>
<span class="normal"> 326</span>
<span class="normal"> 327</span>
<span class="normal"> 328</span>
<span class="normal"> 329</span>
<span class="normal"> 330</span>
<span class="normal"> 331</span>
<span class="normal"> 332</span>
<span class="normal"> 333</span>
<span class="normal"> 334</span>
<span class="normal"> 335</span>
<span class="normal"> 336</span>
<span class="normal"> 337</span>
<span class="normal"> 338</span>
<span class="normal"> 339</span>
<span class="normal"> 340</span>
<span class="normal"> 341</span>
<span class="normal"> 342</span>
<span class="normal"> 343</span>
<span class="normal"> 344</span>
<span class="normal"> 345</span>
<span class="normal"> 346</span>
<span class="normal"> 347</span>
<span class="normal"> 348</span>
<span class="normal"> 349</span>
<span class="normal"> 350</span>
<span class="normal"> 351</span>
<span class="normal"> 352</span>
<span class="normal"> 353</span>
<span class="normal"> 354</span>
<span class="normal"> 355</span>
<span class="normal"> 356</span>
<span class="normal"> 357</span>
<span class="normal"> 358</span>
<span class="normal"> 359</span>
<span class="normal"> 360</span>
<span class="normal"> 361</span>
<span class="normal"> 362</span>
<span class="normal"> 363</span>
<span class="normal"> 364</span>
<span class="normal"> 365</span>
<span class="normal"> 366</span>
<span class="normal"> 367</span>
<span class="normal"> 368</span>
<span class="normal"> 369</span>
<span class="normal"> 370</span>
<span class="normal"> 371</span>
<span class="normal"> 372</span>
<span class="normal"> 373</span>
<span class="normal"> 374</span>
<span class="normal"> 375</span>
<span class="normal"> 376</span>
<span class="normal"> 377</span>
<span class="normal"> 378</span>
<span class="normal"> 379</span>
<span class="normal"> 380</span>
<span class="normal"> 381</span>
<span class="normal"> 382</span>
<span class="normal"> 383</span>
<span class="normal"> 384</span>
<span class="normal"> 385</span>
<span class="normal"> 386</span>
<span class="normal"> 387</span>
<span class="normal"> 388</span>
<span class="normal"> 389</span>
<span class="normal"> 390</span>
<span class="normal"> 391</span>
<span class="normal"> 392</span>
<span class="normal"> 393</span>
<span class="normal"> 394</span>
<span class="normal"> 395</span>
<span class="normal"> 396</span>
<span class="normal"> 397</span>
<span class="normal"> 398</span>
<span class="normal"> 399</span>
<span class="normal"> 400</span>
<span class="normal"> 401</span>
<span class="normal"> 402</span>
<span class="normal"> 403</span>
<span class="normal"> 404</span>
<span class="normal"> 405</span>
<span class="normal"> 406</span>
<span class="normal"> 407</span>
<span class="normal"> 408</span>
<span class="normal"> 409</span>
<span class="normal"> 410</span>
<span class="normal"> 411</span>
<span class="normal"> 412</span>
<span class="normal"> 413</span>
<span class="normal"> 414</span>
<span class="normal"> 415</span>
<span class="normal"> 416</span>
<span class="normal"> 417</span>
<span class="normal"> 418</span>
<span class="normal"> 419</span>
<span class="normal"> 420</span>
<span class="normal"> 421</span>
<span class="normal"> 422</span>
<span class="normal"> 423</span>
<span class="normal"> 424</span>
<span class="normal"> 425</span>
<span class="normal"> 426</span>
<span class="normal"> 427</span>
<span class="normal"> 428</span>
<span class="normal"> 429</span>
<span class="normal"> 430</span>
<span class="normal"> 431</span>
<span class="normal"> 432</span>
<span class="normal"> 433</span>
<span class="normal"> 434</span>
<span class="normal"> 435</span>
<span class="normal"> 436</span>
<span class="normal"> 437</span>
<span class="normal"> 438</span>
<span class="normal"> 439</span>
<span class="normal"> 440</span>
<span class="normal"> 441</span>
<span class="normal"> 442</span>
<span class="normal"> 443</span>
<span class="normal"> 444</span>
<span class="normal"> 445</span>
<span class="normal"> 446</span>
<span class="normal"> 447</span>
<span class="normal"> 448</span>
<span class="normal"> 449</span>
<span class="normal"> 450</span>
<span class="normal"> 451</span>
<span class="normal"> 452</span>
<span class="normal"> 453</span>
<span class="normal"> 454</span>
<span class="normal"> 455</span>
<span class="normal"> 456</span>
<span class="normal"> 457</span>
<span class="normal"> 458</span>
<span class="normal"> 459</span>
<span class="normal"> 460</span>
<span class="normal"> 461</span>
<span class="normal"> 462</span>
<span class="normal"> 463</span>
<span class="normal"> 464</span>
<span class="normal"> 465</span>
<span class="normal"> 466</span>
<span class="normal"> 467</span>
<span class="normal"> 468</span>
<span class="normal"> 469</span>
<span class="normal"> 470</span>
<span class="normal"> 471</span>
<span class="normal"> 472</span>
<span class="normal"> 473</span>
<span class="normal"> 474</span>
<span class="normal"> 475</span>
<span class="normal"> 476</span>
<span class="normal"> 477</span>
<span class="normal"> 478</span>
<span class="normal"> 479</span>
<span class="normal"> 480</span>
<span class="normal"> 481</span>
<span class="normal"> 482</span>
<span class="normal"> 483</span>
<span class="normal"> 484</span>
<span class="normal"> 485</span>
<span class="normal"> 486</span>
<span class="normal"> 487</span>
<span class="normal"> 488</span>
<span class="normal"> 489</span>
<span class="normal"> 490</span>
<span class="normal"> 491</span>
<span class="normal"> 492</span>
<span class="normal"> 493</span>
<span class="normal"> 494</span>
<span class="normal"> 495</span>
<span class="normal"> 496</span>
<span class="normal"> 497</span>
<span class="normal"> 498</span>
<span class="normal"> 499</span>
<span class="normal"> 500</span>
<span class="normal"> 501</span>
<span class="normal"> 502</span>
<span class="normal"> 503</span>
<span class="normal"> 504</span>
<span class="normal"> 505</span>
<span class="normal"> 506</span>
<span class="normal"> 507</span>
<span class="normal"> 508</span>
<span class="normal"> 509</span>
<span class="normal"> 510</span>
<span class="normal"> 511</span>
<span class="normal"> 512</span>
<span class="normal"> 513</span>
<span class="normal"> 514</span>
<span class="normal"> 515</span>
<span class="normal"> 516</span>
<span class="normal"> 517</span>
<span class="normal"> 518</span>
<span class="normal"> 519</span>
<span class="normal"> 520</span>
<span class="normal"> 521</span>
<span class="normal"> 522</span>
<span class="normal"> 523</span>
<span class="normal"> 524</span>
<span class="normal"> 525</span>
<span class="normal"> 526</span>
<span class="normal"> 527</span>
<span class="normal"> 528</span>
<span class="normal"> 529</span>
<span class="normal"> 530</span>
<span class="normal"> 531</span>
<span class="normal"> 532</span>
<span class="normal"> 533</span>
<span class="normal"> 534</span>
<span class="normal"> 535</span>
<span class="normal"> 536</span>
<span class="normal"> 537</span>
<span class="normal"> 538</span>
<span class="normal"> 539</span>
<span class="normal"> 540</span>
<span class="normal"> 541</span>
<span class="normal"> 542</span>
<span class="normal"> 543</span>
<span class="normal"> 544</span>
<span class="normal"> 545</span>
<span class="normal"> 546</span>
<span class="normal"> 547</span>
<span class="normal"> 548</span>
<span class="normal"> 549</span>
<span class="normal"> 550</span>
<span class="normal"> 551</span>
<span class="normal"> 552</span>
<span class="normal"> 553</span>
<span class="normal"> 554</span>
<span class="normal"> 555</span>
<span class="normal"> 556</span>
<span class="normal"> 557</span>
<span class="normal"> 558</span>
<span class="normal"> 559</span>
<span class="normal"> 560</span>
<span class="normal"> 561</span>
<span class="normal"> 562</span>
<span class="normal"> 563</span>
<span class="normal"> 564</span>
<span class="normal"> 565</span>
<span class="normal"> 566</span>
<span class="normal"> 567</span>
<span class="normal"> 568</span>
<span class="normal"> 569</span>
<span class="normal"> 570</span>
<span class="normal"> 571</span>
<span class="normal"> 572</span>
<span class="normal"> 573</span>
<span class="normal"> 574</span>
<span class="normal"> 575</span>
<span class="normal"> 576</span>
<span class="normal"> 577</span>
<span class="normal"> 578</span>
<span class="normal"> 579</span>
<span class="normal"> 580</span>
<span class="normal"> 581</span>
<span class="normal"> 582</span>
<span class="normal"> 583</span>
<span class="normal"> 584</span>
<span class="normal"> 585</span>
<span class="normal"> 586</span>
<span class="normal"> 587</span>
<span class="normal"> 588</span>
<span class="normal"> 589</span>
<span class="normal"> 590</span>
<span class="normal"> 591</span>
<span class="normal"> 592</span>
<span class="normal"> 593</span>
<span class="normal"> 594</span>
<span class="normal"> 595</span>
<span class="normal"> 596</span>
<span class="normal"> 597</span>
<span class="normal"> 598</span>
<span class="normal"> 599</span>
<span class="normal"> 600</span>
<span class="normal"> 601</span>
<span class="normal"> 602</span>
<span class="normal"> 603</span>
<span class="normal"> 604</span>
<span class="normal"> 605</span>
<span class="normal"> 606</span>
<span class="normal"> 607</span>
<span class="normal"> 608</span>
<span class="normal"> 609</span>
<span class="normal"> 610</span>
<span class="normal"> 611</span>
<span class="normal"> 612</span>
<span class="normal"> 613</span>
<span class="normal"> 614</span>
<span class="normal"> 615</span>
<span class="normal"> 616</span>
<span class="normal"> 617</span>
<span class="normal"> 618</span>
<span class="normal"> 619</span>
<span class="normal"> 620</span>
<span class="normal"> 621</span>
<span class="normal"> 622</span>
<span class="normal"> 623</span>
<span class="normal"> 624</span>
<span class="normal"> 625</span>
<span class="normal"> 626</span>
<span class="normal"> 627</span>
<span class="normal"> 628</span>
<span class="normal"> 629</span>
<span class="normal"> 630</span>
<span class="normal"> 631</span>
<span class="normal"> 632</span>
<span class="normal"> 633</span>
<span class="normal"> 634</span>
<span class="normal"> 635</span>
<span class="normal"> 636</span>
<span class="normal"> 637</span>
<span class="normal"> 638</span>
<span class="normal"> 639</span>
<span class="normal"> 640</span>
<span class="normal"> 641</span>
<span class="normal"> 642</span>
<span class="normal"> 643</span>
<span class="normal"> 644</span>
<span class="normal"> 645</span>
<span class="normal"> 646</span>
<span class="normal"> 647</span>
<span class="normal"> 648</span>
<span class="normal"> 649</span>
<span class="normal"> 650</span>
<span class="normal"> 651</span>
<span class="normal"> 652</span>
<span class="normal"> 653</span>
<span class="normal"> 654</span>
<span class="normal"> 655</span>
<span class="normal"> 656</span>
<span class="normal"> 657</span>
<span class="normal"> 658</span>
<span class="normal"> 659</span>
<span class="normal"> 660</span>
<span class="normal"> 661</span>
<span class="normal"> 662</span>
<span class="normal"> 663</span>
<span class="normal"> 664</span>
<span class="normal"> 665</span>
<span class="normal"> 666</span>
<span class="normal"> 667</span>
<span class="normal"> 668</span>
<span class="normal"> 669</span>
<span class="normal"> 670</span>
<span class="normal"> 671</span>
<span class="normal"> 672</span>
<span class="normal"> 673</span>
<span class="normal"> 674</span>
<span class="normal"> 675</span>
<span class="normal"> 676</span>
<span class="normal"> 677</span>
<span class="normal"> 678</span>
<span class="normal"> 679</span>
<span class="normal"> 680</span>
<span class="normal"> 681</span>
<span class="normal"> 682</span>
<span class="normal"> 683</span>
<span class="normal"> 684</span>
<span class="normal"> 685</span>
<span class="normal"> 686</span>
<span class="normal"> 687</span>
<span class="normal"> 688</span>
<span class="normal"> 689</span>
<span class="normal"> 690</span>
<span class="normal"> 691</span>
<span class="normal"> 692</span>
<span class="normal"> 693</span>
<span class="normal"> 694</span>
<span class="normal"> 695</span>
<span class="normal"> 696</span>
<span class="normal"> 697</span>
<span class="normal"> 698</span>
<span class="normal"> 699</span>
<span class="normal"> 700</span>
<span class="normal"> 701</span>
<span class="normal"> 702</span>
<span class="normal"> 703</span>
<span class="normal"> 704</span>
<span class="normal"> 705</span>
<span class="normal"> 706</span>
<span class="normal"> 707</span>
<span class="normal"> 708</span>
<span class="normal"> 709</span>
<span class="normal"> 710</span>
<span class="normal"> 711</span>
<span class="normal"> 712</span>
<span class="normal"> 713</span>
<span class="normal"> 714</span>
<span class="normal"> 715</span>
<span class="normal"> 716</span>
<span class="normal"> 717</span>
<span class="normal"> 718</span>
<span class="normal"> 719</span>
<span class="normal"> 720</span>
<span class="normal"> 721</span>
<span class="normal"> 722</span>
<span class="normal"> 723</span>
<span class="normal"> 724</span>
<span class="normal"> 725</span>
<span class="normal"> 726</span>
<span class="normal"> 727</span>
<span class="normal"> 728</span>
<span class="normal"> 729</span>
<span class="normal"> 730</span>
<span class="normal"> 731</span>
<span class="normal"> 732</span>
<span class="normal"> 733</span>
<span class="normal"> 734</span>
<span class="normal"> 735</span>
<span class="normal"> 736</span>
<span class="normal"> 737</span>
<span class="normal"> 738</span>
<span class="normal"> 739</span>
<span class="normal"> 740</span>
<span class="normal"> 741</span>
<span class="normal"> 742</span>
<span class="normal"> 743</span>
<span class="normal"> 744</span>
<span class="normal"> 745</span>
<span class="normal"> 746</span>
<span class="normal"> 747</span>
<span class="normal"> 748</span>
<span class="normal"> 749</span>
<span class="normal"> 750</span>
<span class="normal"> 751</span>
<span class="normal"> 752</span>
<span class="normal"> 753</span>
<span class="normal"> 754</span>
<span class="normal"> 755</span>
<span class="normal"> 756</span>
<span class="normal"> 757</span>
<span class="normal"> 758</span>
<span class="normal"> 759</span>
<span class="normal"> 760</span>
<span class="normal"> 761</span>
<span class="normal"> 762</span>
<span class="normal"> 763</span>
<span class="normal"> 764</span>
<span class="normal"> 765</span>
<span class="normal"> 766</span>
<span class="normal"> 767</span>
<span class="normal"> 768</span>
<span class="normal"> 769</span>
<span class="normal"> 770</span>
<span class="normal"> 771</span>
<span class="normal"> 772</span>
<span class="normal"> 773</span>
<span class="normal"> 774</span>
<span class="normal"> 775</span>
<span class="normal"> 776</span>
<span class="normal"> 777</span>
<span class="normal"> 778</span>
<span class="normal"> 779</span>
<span class="normal"> 780</span>
<span class="normal"> 781</span>
<span class="normal"> 782</span>
<span class="normal"> 783</span>
<span class="normal"> 784</span>
<span class="normal"> 785</span>
<span class="normal"> 786</span>
<span class="normal"> 787</span>
<span class="normal"> 788</span>
<span class="normal"> 789</span>
<span class="normal"> 790</span>
<span class="normal"> 791</span>
<span class="normal"> 792</span>
<span class="normal"> 793</span>
<span class="normal"> 794</span>
<span class="normal"> 795</span>
<span class="normal"> 796</span>
<span class="normal"> 797</span>
<span class="normal"> 798</span>
<span class="normal"> 799</span>
<span class="normal"> 800</span>
<span class="normal"> 801</span>
<span class="normal"> 802</span>
<span class="normal"> 803</span>
<span class="normal"> 804</span>
<span class="normal"> 805</span>
<span class="normal"> 806</span>
<span class="normal"> 807</span>
<span class="normal"> 808</span>
<span class="normal"> 809</span>
<span class="normal"> 810</span>
<span class="normal"> 811</span>
<span class="normal"> 812</span>
<span class="normal"> 813</span>
<span class="normal"> 814</span>
<span class="normal"> 815</span>
<span class="normal"> 816</span>
<span class="normal"> 817</span>
<span class="normal"> 818</span>
<span class="normal"> 819</span>
<span class="normal"> 820</span>
<span class="normal"> 821</span>
<span class="normal"> 822</span>
<span class="normal"> 823</span>
<span class="normal"> 824</span>
<span class="normal"> 825</span>
<span class="normal"> 826</span>
<span class="normal"> 827</span>
<span class="normal"> 828</span>
<span class="normal"> 829</span>
<span class="normal"> 830</span>
<span class="normal"> 831</span>
<span class="normal"> 832</span>
<span class="normal"> 833</span>
<span class="normal"> 834</span>
<span class="normal"> 835</span>
<span class="normal"> 836</span>
<span class="normal"> 837</span>
<span class="normal"> 838</span>
<span class="normal"> 839</span>
<span class="normal"> 840</span>
<span class="normal"> 841</span>
<span class="normal"> 842</span>
<span class="normal"> 843</span>
<span class="normal"> 844</span>
<span class="normal"> 845</span>
<span class="normal"> 846</span>
<span class="normal"> 847</span>
<span class="normal"> 848</span>
<span class="normal"> 849</span>
<span class="normal"> 850</span>
<span class="normal"> 851</span>
<span class="normal"> 852</span>
<span class="normal"> 853</span>
<span class="normal"> 854</span>
<span class="normal"> 855</span>
<span class="normal"> 856</span>
<span class="normal"> 857</span>
<span class="normal"> 858</span>
<span class="normal"> 859</span>
<span class="normal"> 860</span>
<span class="normal"> 861</span>
<span class="normal"> 862</span>
<span class="normal"> 863</span>
<span class="normal"> 864</span>
<span class="normal"> 865</span>
<span class="normal"> 866</span>
<span class="normal"> 867</span>
<span class="normal"> 868</span>
<span class="normal"> 869</span>
<span class="normal"> 870</span>
<span class="normal"> 871</span>
<span class="normal"> 872</span>
<span class="normal"> 873</span>
<span class="normal"> 874</span>
<span class="normal"> 875</span>
<span class="normal"> 876</span>
<span class="normal"> 877</span>
<span class="normal"> 878</span>
<span class="normal"> 879</span>
<span class="normal"> 880</span>
<span class="normal"> 881</span>
<span class="normal"> 882</span>
<span class="normal"> 883</span>
<span class="normal"> 884</span>
<span class="normal"> 885</span>
<span class="normal"> 886</span>
<span class="normal"> 887</span>
<span class="normal"> 888</span>
<span class="normal"> 889</span>
<span class="normal"> 890</span>
<span class="normal"> 891</span>
<span class="normal"> 892</span>
<span class="normal"> 893</span>
<span class="normal"> 894</span>
<span class="normal"> 895</span>
<span class="normal"> 896</span>
<span class="normal"> 897</span>
<span class="normal"> 898</span>
<span class="normal"> 899</span>
<span class="normal"> 900</span>
<span class="normal"> 901</span>
<span class="normal"> 902</span>
<span class="normal"> 903</span>
<span class="normal"> 904</span>
<span class="normal"> 905</span>
<span class="normal"> 906</span>
<span class="normal"> 907</span>
<span class="normal"> 908</span>
<span class="normal"> 909</span>
<span class="normal"> 910</span>
<span class="normal"> 911</span>
<span class="normal"> 912</span>
<span class="normal"> 913</span>
<span class="normal"> 914</span>
<span class="normal"> 915</span>
<span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">VideoSummaryDetector</span><span class="p">(</span><span class="n">AnalysisMethod</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">summary_model</span><span class="p">:</span> <span class="n">MultimodalSummaryModel</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">audio_model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AudioToTextModel</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">subdict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Class for analysing videos using QWEN-2.5-VL model.</span>
<span class="sd">        It provides methods for generating captions and answering questions about videos.</span>

<span class="sd">        Args:</span>
<span class="sd">            summary_model ([type], optional): An instance of MultimodalSummaryModel to be used for analysis.</span>
<span class="sd">            subdict (dict, optional): Dictionary containing the video to be analysed. Defaults to {}.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">subdict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">subdict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">subdict</span><span class="p">)</span>
        <span class="n">_validate_subdict</span><span class="p">(</span><span class="n">subdict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">summary_model</span> <span class="o">=</span> <span class="n">summary_model</span> <span class="ow">or</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">audio_model</span> <span class="o">=</span> <span class="n">audio_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prompt_builder</span> <span class="o">=</span> <span class="n">PromptBuilder</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_decode_trimmed_outputs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">generated_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">inputs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span>
        <span class="n">tokenizer</span><span class="p">,</span>
        <span class="n">prompt_texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Trim prompt tokens using attention_mask/input_ids when available and decode to strings.</span>
<span class="sd">        Then remove any literal prompt prefix using prompt_texts (one per batch element).</span>
<span class="sd">        Args:</span>
<span class="sd">            generated_ids (torch.Tensor): Generated token IDs from the model.</span>
<span class="sd">            inputs (Dict[str, torch.Tensor]): Original input tensors used for generation.</span>
<span class="sd">            tokenizer: Tokenizer used for decoding the generated outputs.</span>
<span class="sd">            prompt_texts (List[str]): List of prompt texts corresponding to each input in the batch.</span>
<span class="sd">        Returns:</span>
<span class="sd">            List[str]: Decoded generated texts after trimming and cleaning.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">generated_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="s2">&quot;input_ids&quot;</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
            <span class="n">token_for_padding</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token_id</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">,</span> <span class="s2">&quot;pad_token_id&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="k">else</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">,</span> <span class="s2">&quot;eos_token_id&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">token_for_padding</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">lengths</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="o">*</span> <span class="n">batch_size</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lengths</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ne</span><span class="p">(</span><span class="n">token_for_padding</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lengths</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">batch_size</span>

        <span class="n">trimmed_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>
            <span class="n">out_ids</span> <span class="o">=</span> <span class="n">generated_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">in_len</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lengths</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lengths</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">out_ids</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">in_len</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">out_ids</span><span class="p">[</span><span class="n">in_len</span><span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">out_ids</span><span class="o">.</span><span class="n">new_empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">out_ids</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="n">t_cpu</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
            <span class="n">trimmed_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t_cpu</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

        <span class="n">decoded</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">batch_decode</span><span class="p">(</span>
            <span class="n">trimmed_ids</span><span class="p">,</span> <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">clean_up_tokenization_spaces</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">decoded_results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ptext</span><span class="p">,</span> <span class="n">raw</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">prompt_texts</span><span class="p">,</span> <span class="n">decoded</span><span class="p">):</span>
            <span class="n">cleaned</span> <span class="o">=</span> <span class="n">_strip_prompt_prefix_literal</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="n">ptext</span><span class="p">)</span>
            <span class="n">decoded_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cleaned</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">decoded_results</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_from_processor_inputs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">processor_inputs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span>
        <span class="n">prompt_texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">tokenizer</span><span class="p">,</span>
        <span class="n">len_objects</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run model.generate on already-processed processor_inputs (tensors moved to device),</span>
<span class="sd">        then decode and trim prompt tokens &amp; remove literal prompt prefixes using prompt_texts.</span>
<span class="sd">        Args:</span>
<span class="sd">            processor_inputs (Dict[str, torch.Tensor]): Inputs prepared by the processor.</span>
<span class="sd">            prompt_texts (List[str]): List of prompt texts corresponding to each input in the batch.</span>
<span class="sd">            tokenizer: Tokenizer used for decoding the generated outputs.</span>
<span class="sd">            len_objects (Optional[int], optional): Number of objects/frames to adjust max_new_tokens. Defaults to None.</span>
<span class="sd">        Returns:</span>
<span class="sd">            List[str]: Decoded generated texts after trimming and cleaning.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># In case of many frames, allow more max_new_tokens # TODO recheck the logic</span>
        <span class="k">if</span> <span class="n">len_objects</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">max_new_tokens</span> <span class="o">=</span> <span class="n">len_objects</span> <span class="o">*</span> <span class="mi">128</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">max_new_tokens</span> <span class="o">=</span> <span class="mi">128</span>
        <span class="n">gen_conf</span> <span class="o">=</span> <span class="n">GenerationConfig</span><span class="p">(</span>
            <span class="n">max_new_tokens</span><span class="o">=</span><span class="n">max_new_tokens</span><span class="p">,</span>
            <span class="n">do_sample</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">num_return_sequences</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">processor_inputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
                <span class="n">processor_inputs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">summary_model</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">inference_mode</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary_model</span><span class="o">.</span><span class="n">device</span> <span class="o">==</span> <span class="s2">&quot;cuda&quot;</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">autocast</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span><span class="p">,</span> <span class="n">enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                        <span class="n">generated_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary_model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span>
                            <span class="o">**</span><span class="n">processor_inputs</span><span class="p">,</span> <span class="n">generation_config</span><span class="o">=</span><span class="n">gen_conf</span>
                        <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">generated_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary_model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span>
                        <span class="o">**</span><span class="n">processor_inputs</span><span class="p">,</span> <span class="n">generation_config</span><span class="o">=</span><span class="n">gen_conf</span>
                    <span class="p">)</span>
            <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Generation failed with error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Retrying with cuDNN disabled.&quot;</span><span class="p">,</span>
                    <span class="ne">RuntimeWarning</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">cudnn_was_enabled</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">cudnn</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="ow">and</span> <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">cudnn</span><span class="o">.</span><span class="n">enabled</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">cudnn_was_enabled</span><span class="p">:</span>
                    <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">cudnn</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">generated_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary_model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span>
                        <span class="o">**</span><span class="n">processor_inputs</span><span class="p">,</span> <span class="n">generation_config</span><span class="o">=</span><span class="n">gen_conf</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">retry_error</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Failed to generate ids after retry: </span><span class="si">{</span><span class="n">retry_error</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">retry_error</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">cudnn_was_enabled</span><span class="p">:</span>
                        <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">cudnn</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">decoded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decode_trimmed_outputs</span><span class="p">(</span>
            <span class="n">generated_ids</span><span class="p">,</span> <span class="n">processor_inputs</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">prompt_texts</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">decoded</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_audio_to_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">audio_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert audio file to text using an whisper model.</span>
<span class="sd">        Args:</span>
<span class="sd">            audio_path (str): Path to the audio file.</span>
<span class="sd">        Returns:</span>
<span class="sd">            List[Dict[str, Any]]: List of transcribed audio segments with start_time, end_time, text, and duration.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">audio_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Audio file </span><span class="si">{</span><span class="n">audio_path</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">matmul</span><span class="o">.</span><span class="n">allow_tf32</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">cudnn</span><span class="o">.</span><span class="n">allow_tf32</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">audio</span> <span class="o">=</span> <span class="n">whisperx</span><span class="o">.</span><span class="n">load_audio</span><span class="p">(</span><span class="n">audio_path</span><span class="p">)</span>
            <span class="n">transcribe_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">audio_model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">transcribe</span><span class="p">(</span><span class="n">audio</span><span class="p">)</span>
            <span class="n">model_a</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="n">whisperx</span><span class="o">.</span><span class="n">load_align_model</span><span class="p">(</span>
                <span class="n">language_code</span><span class="o">=</span><span class="n">transcribe_result</span><span class="p">[</span><span class="s2">&quot;language&quot;</span><span class="p">],</span>
                <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">audio_model</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">aligned_result</span> <span class="o">=</span> <span class="n">whisperx</span><span class="o">.</span><span class="n">align</span><span class="p">(</span>
                <span class="n">transcribe_result</span><span class="p">[</span><span class="s2">&quot;segments&quot;</span><span class="p">],</span>
                <span class="n">model_a</span><span class="p">,</span>
                <span class="n">metadata</span><span class="p">,</span>
                <span class="n">audio</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">audio_model</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">audio_descriptions</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="n">aligned_result</span><span class="p">[</span><span class="s2">&quot;segments&quot;</span><span class="p">]:</span>
                <span class="n">audio_descriptions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;start_time&quot;</span><span class="p">:</span> <span class="n">segment</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;end_time&quot;</span><span class="p">:</span> <span class="n">segment</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">segment</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
                        <span class="s2">&quot;duration&quot;</span><span class="p">:</span> <span class="n">segment</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">segment</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">],</span>
                    <span class="p">}</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">audio_descriptions</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to transcribe audio: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_check_audio_stream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if the video file has an audio stream.</span>
<span class="sd">        Args:</span>
<span class="sd">            filename (str): Path to the video file.</span>
<span class="sd">        Returns:</span>
<span class="sd">            bool: True if audio stream exists, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;ffprobe&quot;</span><span class="p">,</span>
                <span class="s2">&quot;-v&quot;</span><span class="p">,</span>
                <span class="s2">&quot;error&quot;</span><span class="p">,</span>
                <span class="s2">&quot;-select_streams&quot;</span><span class="p">,</span>
                <span class="s2">&quot;a&quot;</span><span class="p">,</span>
                <span class="s2">&quot;-show_entries&quot;</span><span class="p">,</span>
                <span class="s2">&quot;stream=codec_type&quot;</span><span class="p">,</span>
                <span class="s2">&quot;-of&quot;</span><span class="p">,</span>
                <span class="s2">&quot;default=noprint_wrappers=1:nokey=1&quot;</span><span class="p">,</span>
                <span class="n">filename</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                <span class="n">cmd</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Failed to check audio stream in video </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="ne">RuntimeWarning</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_transcribe_audio_part</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract audio part from the video file and generate captions using an audio whisperx model.</span>
<span class="sd">        Args:</span>
<span class="sd">            filename (str): Path to the video file.</span>
<span class="sd">        Returns:</span>
<span class="sd">            List[Dict[str, Any]]: List of transcribed audio segments with start_time, end_time, text, and duration.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_audio_stream</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">audio_model</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">audio_model</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmpdir</span><span class="p">:</span>
            <span class="n">audio_output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">,</span> <span class="s2">&quot;audio_extracted.wav&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="s2">&quot;ffmpeg&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;-i&quot;</span><span class="p">,</span>
                        <span class="n">filename</span><span class="p">,</span>
                        <span class="s2">&quot;-vn&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;-acodec&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;pcm_s16le&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;-ar&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;16000&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;-ac&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;1&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;-y&quot;</span><span class="p">,</span>
                        <span class="n">audio_output_path</span><span class="p">,</span>
                    <span class="p">],</span>
                    <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">,</span>
                    <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to extract audio from video: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">audio_descriptions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_audio_to_text</span><span class="p">(</span><span class="n">audio_output_path</span><span class="p">)</span>

        <span class="c1"># and close the audio model to free up resources</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">audio_model</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">audio_model</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">audio_descriptions</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_detect_scene_cuts</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Detect scene cuts in the video using frame differencing method.</span>
<span class="sd">        Args:</span>
<span class="sd">            filename: Path to the video file</span>
<span class="sd">        Returns:</span>
<span class="sd">            List of segments with &#39;start_time&#39; and &#39;end_time&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">cap</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">fps</span> <span class="o">=</span> <span class="n">cap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FPS</span><span class="p">)</span>

        <span class="n">frames</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">img_height</span><span class="p">,</span> <span class="n">img_width</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">ret</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">cap</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ret</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="n">img_height</span><span class="p">,</span> <span class="n">img_width</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">img_width</span> <span class="o">/</span> <span class="n">img_height</span> <span class="o">&gt;</span> <span class="mf">1.2</span><span class="p">:</span>
                    <span class="n">frame_small</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="p">(</span><span class="mi">320</span><span class="p">,</span> <span class="mi">240</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">img_width</span> <span class="o">/</span> <span class="n">img_height</span> <span class="o">&lt;</span> <span class="mf">0.8</span><span class="p">:</span>
                    <span class="n">frame_small</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="p">(</span><span class="mi">240</span><span class="p">,</span> <span class="mi">320</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">frame_small</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="p">(</span><span class="mi">320</span><span class="p">,</span> <span class="mi">320</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Failed to resize frame for scene cut detection: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="n">gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span>
                <span class="n">frame_small</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span>
            <span class="p">)</span>  <span class="c1"># TODO check if it is ok, maybe we can use color info as well</span>
            <span class="n">frames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gray</span><span class="p">)</span>

        <span class="n">cap</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">img_height</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">img_width</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Failed to read frames from video for scene cut detection.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Compute frame differences to keep memory usage low</span>
        <span class="n">frame_diffs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">frames</span><span class="p">)):</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">absdiff</span><span class="p">(</span><span class="n">frames</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">frames</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">mean_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>
            <span class="n">frame_diffs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean_diff</span><span class="p">)</span>

        <span class="c1"># Find peaks in differences (scene cuts) via adaptive threshold based on median</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="mf">25.0</span>
        <span class="n">median_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">frame_diffs</span><span class="p">)</span>
        <span class="n">cut_threshold</span> <span class="o">=</span> <span class="n">median_diff</span> <span class="o">+</span> <span class="n">threshold</span>

        <span class="n">cut_frames</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">find_peaks</span><span class="p">(</span>
            <span class="n">frame_diffs</span><span class="p">,</span>
            <span class="n">height</span><span class="o">=</span><span class="n">cut_threshold</span><span class="p">,</span>
            <span class="n">distance</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">fps</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">),</span>  <span class="c1"># At least 0.5s between cuts</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">video_segments</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cut_frames_with_starts</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">cut_frames</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">frames</span><span class="p">)]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cut_frames_with_starts</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">start_frame</span> <span class="o">=</span> <span class="n">cut_frames_with_starts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">end_frame</span> <span class="o">=</span> <span class="n">cut_frames_with_starts</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

            <span class="n">video_segments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;video_scene&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;start_time&quot;</span><span class="p">:</span> <span class="n">start_frame</span> <span class="o">/</span> <span class="n">fps</span><span class="p">,</span>
                    <span class="s2">&quot;end_time&quot;</span><span class="p">:</span> <span class="n">end_frame</span> <span class="o">/</span> <span class="n">fps</span><span class="p">,</span>
                    <span class="s2">&quot;duration&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">end_frame</span> <span class="o">-</span> <span class="n">start_frame</span><span class="p">)</span> <span class="o">/</span> <span class="n">fps</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>

        <span class="c1"># Since there may be issues with last frame detection, slightly adjust the end_time of the last segment</span>
        <span class="n">last_segment</span> <span class="o">=</span> <span class="n">video_segments</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">last_segment</span><span class="p">[</span><span class="s2">&quot;end_time&quot;</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.5</span>
        <span class="c1"># Ensure the end_time does not go below the start_time in case of very short last segment/video</span>
        <span class="k">if</span> <span class="n">last_segment</span><span class="p">[</span><span class="s2">&quot;end_time&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">last_segment</span><span class="p">[</span><span class="s2">&quot;start_time&quot;</span><span class="p">]:</span>
            <span class="n">last_segment</span><span class="p">[</span><span class="s2">&quot;end_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">last_segment</span><span class="p">[</span><span class="s2">&quot;start_time&quot;</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;segments&quot;</span><span class="p">:</span> <span class="n">video_segments</span><span class="p">,</span>
            <span class="s2">&quot;video_meta&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">img_width</span><span class="p">,</span>
                <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">img_height</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_frame_timestamps_from_clip</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract frame timestamps for each detected video segment.</span>
<span class="sd">        Args:</span>
<span class="sd">            filename: Path to the video file</span>
<span class="sd">        Returns:</span>
<span class="sd">            List of segments with &#39;start_time&#39;, &#39;end_time&#39;, and &#39;frame_timestamps&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">base_frames_per_clip</span> <span class="o">=</span> <span class="mf">4.0</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detect_scene_cuts</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">segments</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;segments&quot;</span><span class="p">]</span>
        <span class="n">video_meta</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;video_meta&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">seg</span> <span class="ow">in</span> <span class="n">segments</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">seg</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">2.0</span><span class="p">:</span>
                <span class="n">frame_rate_per_clip</span> <span class="o">=</span> <span class="mf">2.0</span>
            <span class="k">elif</span> <span class="n">seg</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">20.0</span><span class="p">:</span>
                <span class="n">frame_rate_per_clip</span> <span class="o">=</span> <span class="mf">6.0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">frame_rate_per_clip</span> <span class="o">=</span> <span class="n">base_frames_per_clip</span>

            <span class="n">start_time</span> <span class="o">=</span> <span class="n">seg</span><span class="p">[</span><span class="s2">&quot;start_time&quot;</span><span class="p">]</span>
            <span class="n">end_time</span> <span class="o">=</span> <span class="n">seg</span><span class="p">[</span><span class="s2">&quot;end_time&quot;</span><span class="p">]</span>
            <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">frame_rate_per_clip</span><span class="p">))</span>
            <span class="n">sample_times</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
                <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span>
            <span class="p">)</span>
            <span class="n">seg</span><span class="p">[</span><span class="s2">&quot;frame_timestamps&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample_times</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;segments&quot;</span><span class="p">:</span> <span class="n">segments</span><span class="p">,</span>
            <span class="s2">&quot;video_meta&quot;</span><span class="p">:</span> <span class="n">video_meta</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_reassign_video_timestamps_to_segments</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">segments</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">video_segs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reassign video frame timestamps to each new segment based on overlapping video scenes.</span>
<span class="sd">        Args:</span>
<span class="sd">            segments: List of segments to assign timestamps to.</span>
<span class="sd">            video_segs: List of video scenes with original frame timestamps.</span>
<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">boundary_margin</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="mf">1e-6</span>

        <span class="n">video_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">video_segs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">seg</span> <span class="ow">in</span> <span class="n">segments</span><span class="p">:</span>
            <span class="n">seg_start</span> <span class="o">=</span> <span class="n">seg</span><span class="p">[</span><span class="s2">&quot;start_time&quot;</span><span class="p">]</span>
            <span class="n">seg_end</span> <span class="o">=</span> <span class="n">seg</span><span class="p">[</span><span class="s2">&quot;end_time&quot;</span><span class="p">]</span>

            <span class="n">merged_timestamps</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">vscene</span> <span class="ow">in</span> <span class="n">video_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;frame_timestamps&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vscene</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Video scene missing &#39;frame_timestamps&#39; key.&quot;</span><span class="p">)</span>

                <span class="n">contrib</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="nb">float</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">vscene</span><span class="p">[</span><span class="s2">&quot;frame_timestamps&quot;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="n">eps</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">seg_start</span> <span class="o">-</span> <span class="n">boundary_margin</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">eps</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">seg_end</span> <span class="o">+</span> <span class="n">boundary_margin</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="n">eps</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">seg_start</span>
                    <span class="ow">and</span> <span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">eps</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">seg_end</span>
                <span class="p">]</span>
                <span class="k">if</span> <span class="n">contrib</span><span class="p">:</span>
                    <span class="n">merged_timestamps</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">contrib</span><span class="p">)</span>

            <span class="c1"># dedupe &amp; sort</span>
            <span class="n">seg</span><span class="p">[</span><span class="s2">&quot;video_frame_timestamps&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">merged_timestamps</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_combine_visual_frames_by_time</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">video_segs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Split too-long video segments (&gt;25s).</span>
<span class="sd">        Args:</span>
<span class="sd">            video_segs: List of video segments with &#39;start_time&#39; and &#39;end_time&#39;</span>
<span class="sd">        Returns:</span>
<span class="sd">            List of combined segments</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">video_segs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No video segments to combine.&quot;</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">vs</span> <span class="ow">in</span> <span class="n">video_segs</span><span class="p">:</span>
            <span class="n">st</span><span class="p">,</span> <span class="n">ed</span><span class="p">,</span> <span class="n">dur</span> <span class="o">=</span> <span class="p">(</span>
                <span class="nb">float</span><span class="p">(</span><span class="n">vs</span><span class="p">[</span><span class="s2">&quot;start_time&quot;</span><span class="p">]),</span>
                <span class="nb">float</span><span class="p">(</span><span class="n">vs</span><span class="p">[</span><span class="s2">&quot;end_time&quot;</span><span class="p">]),</span>
                <span class="nb">float</span><span class="p">(</span><span class="n">vs</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]),</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">dur</span> <span class="o">&gt;</span> <span class="mf">25.0</span><span class="p">:</span>
                <span class="n">parts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">dur</span> <span class="o">/</span> <span class="mf">25.0</span><span class="p">))</span>
                <span class="n">part_dur</span> <span class="o">=</span> <span class="n">dur</span> <span class="o">/</span> <span class="n">parts</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">parts</span><span class="p">):</span>
                    <span class="n">ps</span> <span class="o">=</span> <span class="n">st</span> <span class="o">+</span> <span class="n">p</span> <span class="o">*</span> <span class="n">part_dur</span>
                    <span class="n">pe</span> <span class="o">=</span> <span class="n">st</span> <span class="o">+</span> <span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">part_dur</span> <span class="k">if</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="n">parts</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">ed</span>
                    <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;start_time&quot;</span><span class="p">:</span> <span class="n">ps</span><span class="p">,</span>
                            <span class="s2">&quot;end_time&quot;</span><span class="p">:</span> <span class="n">pe</span><span class="p">,</span>
                            <span class="s2">&quot;duration&quot;</span><span class="p">:</span> <span class="n">pe</span> <span class="o">-</span> <span class="n">ps</span><span class="p">,</span>
                            <span class="s2">&quot;audio_phrases&quot;</span><span class="p">:</span> <span class="p">[],</span>
                            <span class="s2">&quot;video_scenes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">vs</span><span class="p">],</span>
                        <span class="p">}</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;start_time&quot;</span><span class="p">:</span> <span class="n">st</span><span class="p">,</span>
                        <span class="s2">&quot;end_time&quot;</span><span class="p">:</span> <span class="n">ed</span><span class="p">,</span>
                        <span class="s2">&quot;duration&quot;</span><span class="p">:</span> <span class="n">dur</span><span class="p">,</span>
                        <span class="s2">&quot;audio_phrases&quot;</span><span class="p">:</span> <span class="p">[],</span>
                        <span class="s2">&quot;video_scenes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">vs</span><span class="p">],</span>
                    <span class="p">}</span>
                <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_reassign_video_timestamps_to_segments</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">video_segs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">merge_audio_visual_boundaries</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">audio_segs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">video_segs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">segment_threshold_duration</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Merge audio phrase boundaries and video scene cuts into coherent temporal segments for the model</span>
<span class="sd">        Args:</span>
<span class="sd">            audio_segs: List of audio segments with &#39;start_time&#39; and &#39;end_time&#39;</span>
<span class="sd">            video_segs: List of video segments with &#39;start_time&#39; and &#39;end_time&#39;</span>
<span class="sd">            segment_threshold_duration: Duration to create a new segment boundary</span>
<span class="sd">        Returns:</span>
<span class="sd">            List of merged segments</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">audio_segs</span><span class="p">:</span>
            <span class="n">new_vid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_combine_visual_frames_by_time</span><span class="p">(</span><span class="n">video_segs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">new_vid</span>

        <span class="n">events</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;audio&quot;</span><span class="p">,</span> <span class="n">seg</span><span class="p">[</span><span class="s2">&quot;start_time&quot;</span><span class="p">],</span> <span class="n">seg</span><span class="p">[</span><span class="s2">&quot;end_time&quot;</span><span class="p">],</span> <span class="n">seg</span><span class="p">)</span> <span class="k">for</span> <span class="n">seg</span> <span class="ow">in</span> <span class="n">audio_segs</span>
        <span class="p">]</span> <span class="o">+</span> <span class="p">[(</span><span class="s2">&quot;video&quot;</span><span class="p">,</span> <span class="n">seg</span><span class="p">[</span><span class="s2">&quot;start_time&quot;</span><span class="p">],</span> <span class="n">seg</span><span class="p">[</span><span class="s2">&quot;end_time&quot;</span><span class="p">],</span> <span class="n">seg</span><span class="p">)</span> <span class="k">for</span> <span class="n">seg</span> <span class="ow">in</span> <span class="n">video_segs</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">events</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No audio and video segments to merge.&quot;</span><span class="p">)</span>

        <span class="n">events</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">global_last_end</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">events</span><span class="p">)</span>
        <span class="c1"># Create merged segments respecting both boundaries</span>
        <span class="n">merged</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">current_segment_start</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">current_audio_phrases</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">current_video_scenes</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">event_type</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
            <span class="n">current_duration</span> <span class="o">=</span> <span class="n">start</span> <span class="o">-</span> <span class="n">current_segment_start</span>
            <span class="k">if</span> <span class="n">current_duration</span> <span class="o">&gt;</span> <span class="n">segment_threshold_duration</span><span class="p">:</span>
                <span class="n">segment_end</span> <span class="o">=</span> <span class="n">start</span>

                <span class="k">if</span> <span class="n">segment_end</span> <span class="o">&lt;</span> <span class="n">current_segment_start</span><span class="p">:</span>
                    <span class="n">segment_end</span> <span class="o">=</span> <span class="n">current_segment_start</span>

                <span class="n">merged</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;start_time&quot;</span><span class="p">:</span> <span class="n">current_segment_start</span><span class="p">,</span>
                        <span class="s2">&quot;end_time&quot;</span><span class="p">:</span> <span class="n">segment_end</span><span class="p">,</span>
                        <span class="s2">&quot;audio_phrases&quot;</span><span class="p">:</span> <span class="n">current_audio_phrases</span><span class="p">,</span>
                        <span class="s2">&quot;video_scenes&quot;</span><span class="p">:</span> <span class="n">current_video_scenes</span><span class="p">,</span>
                        <span class="s2">&quot;duration&quot;</span><span class="p">:</span> <span class="n">segment_end</span> <span class="o">-</span> <span class="n">current_segment_start</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span>
                <span class="c1"># start a new segment at the current event&#39;s start</span>
                <span class="n">current_segment_start</span> <span class="o">=</span> <span class="n">segment_end</span>
                <span class="n">current_audio_phrases</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">current_video_scenes</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">if</span> <span class="n">event_type</span> <span class="o">==</span> <span class="s2">&quot;audio&quot;</span><span class="p">:</span>
                <span class="n">current_audio_phrases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">current_video_scenes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">current_audio_phrases</span> <span class="ow">or</span> <span class="n">current_video_scenes</span><span class="p">:</span>
            <span class="n">final_end</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">global_last_end</span><span class="p">,</span> <span class="n">events</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="n">current_segment_start</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">final_end</span> <span class="o">&lt;</span> <span class="n">current_segment_start</span><span class="p">:</span>
                <span class="n">final_end</span> <span class="o">=</span> <span class="n">current_segment_start</span>

            <span class="n">merged</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;start_time&quot;</span><span class="p">:</span> <span class="n">current_segment_start</span><span class="p">,</span>
                    <span class="s2">&quot;end_time&quot;</span><span class="p">:</span> <span class="n">final_end</span><span class="p">,</span>
                    <span class="s2">&quot;audio_phrases&quot;</span><span class="p">:</span> <span class="n">current_audio_phrases</span><span class="p">,</span>
                    <span class="s2">&quot;video_scenes&quot;</span><span class="p">:</span> <span class="n">current_video_scenes</span><span class="p">,</span>
                    <span class="s2">&quot;duration&quot;</span><span class="p">:</span> <span class="n">final_end</span> <span class="o">-</span> <span class="n">current_segment_start</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_reassign_video_timestamps_to_segments</span><span class="p">(</span><span class="n">merged</span><span class="p">,</span> <span class="n">video_segs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">merged</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_run_ffmpeg</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">cmd_args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CompletedProcess</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute ffmpeg command and return the completed process.</span>
<span class="sd">        Args:</span>
<span class="sd">            cmd_args: List of ffmpeg command arguments.</span>
<span class="sd">            timeout: Timeout for the subprocess.</span>
<span class="sd">        Returns:</span>
<span class="sd">            CompletedProcess: Result of the subprocess execution.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ffmpeg&quot;</span><span class="p">,</span> <span class="s2">&quot;-hide_banner&quot;</span><span class="p">,</span> <span class="s2">&quot;-loglevel&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">cmd_args</span>
        <span class="k">return</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
            <span class="n">cmd</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_extract_command</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">accurate</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">codec</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;png&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build ffmpeg command for frame extraction.</span>

<span class="sd">        Args:</span>
<span class="sd">            filename: Path to video file</span>
<span class="sd">            timestamp: Time in seconds</span>
<span class="sd">            accurate: If True, seek after input (slow but accurate)</span>
<span class="sd">            codec: Output codec (&#39;png&#39; or &#39;mjpeg&#39;)</span>
<span class="sd">        Returns:</span>
<span class="sd">            List of ffmpeg command arguments</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ss_arg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">timestamp</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Position -ss based on accuracy requirement</span>
        <span class="k">if</span> <span class="n">accurate</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;-i&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;-ss&quot;</span><span class="p">,</span> <span class="n">ss_arg</span><span class="p">]</span>  <span class="c1"># accurate mode</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;-ss&quot;</span><span class="p">,</span> <span class="n">ss_arg</span><span class="p">,</span> <span class="s2">&quot;-i&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">]</span>  <span class="c1"># fast mode</span>

        <span class="c1"># Common extraction parameters</span>
        <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-frames:v&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;-f&quot;</span><span class="p">,</span> <span class="s2">&quot;image2pipe&quot;</span><span class="p">]</span>

        <span class="c1"># Codec-specific settings</span>
        <span class="k">if</span> <span class="n">codec</span> <span class="o">==</span> <span class="s2">&quot;png&quot;</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-vcodec&quot;</span><span class="p">,</span> <span class="s2">&quot;png&quot;</span><span class="p">,</span> <span class="s2">&quot;-pix_fmt&quot;</span><span class="p">,</span> <span class="s2">&quot;rgb24&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">codec</span> <span class="o">==</span> <span class="s2">&quot;mjpeg&quot;</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-vcodec&quot;</span><span class="p">,</span> <span class="s2">&quot;mjpeg&quot;</span><span class="p">,</span> <span class="s2">&quot;-pix_fmt&quot;</span><span class="p">,</span> <span class="s2">&quot;yuvj420p&quot;</span><span class="p">]</span>

        <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;pipe:1&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cmd</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_run_ffmpeg_extraction</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">timestamp</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">out_w</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">out_h</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">30.0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract a single frame at the specified timestamp.</span>

<span class="sd">        Args:</span>
<span class="sd">            filename: Path to video file</span>
<span class="sd">            timestamp: Time in seconds</span>
<span class="sd">            out_w: Optional output width</span>
<span class="sd">            out_h: Optional output height</span>
<span class="sd">            timeout: Subprocess timeout in seconds</span>

<span class="sd">        Returns:</span>
<span class="sd">            PIL Image in RGB format</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If frame extraction fails</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">strategies</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;mjpeg&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;png&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
        <span class="p">]</span>

        <span class="n">last_error</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">codec</span><span class="p">,</span> <span class="n">use_accurate</span> <span class="ow">in</span> <span class="n">strategies</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_extract_command</span><span class="p">(</span>
                    <span class="n">filename</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">use_accurate</span><span class="p">,</span> <span class="n">codec</span>
                <span class="p">)</span>
                <span class="n">proc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_ffmpeg</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">proc</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">proc</span><span class="o">.</span><span class="n">stdout</span><span class="p">:</span>
                    <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">proc</span><span class="o">.</span><span class="n">stdout</span><span class="p">))</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">&quot;RGB&quot;</span><span class="p">)</span>
                    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="n">out_w</span><span class="p">,</span> <span class="n">out_h</span><span class="p">),</span> <span class="n">resample</span><span class="o">=</span><span class="n">Image</span><span class="o">.</span><span class="n">BILINEAR</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">img</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">last_error</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">last_error</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Frame extraction failed at </span><span class="si">{</span><span class="n">timestamp</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">s with codec </span><span class="si">{</span><span class="n">codec</span><span class="si">}</span><span class="s2"> &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="s1">&#39;accurate&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">use_accurate</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;fast&#39;</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">last_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="ne">RuntimeWarning</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Failed to extract frame at </span><span class="si">{</span><span class="n">timestamp</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">s from </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Last error: </span><span class="si">{</span><span class="n">last_error</span><span class="p">[:</span><span class="mi">500</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_output_dimensions</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">original_w</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">original_h</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate output dimensions in a fully adaptive way, preserving aspect ratio, but decreasing size.</span>
<span class="sd">        It works both for landscape and portrait videos.</span>
<span class="sd">        Args:</span>
<span class="sd">            original_w: Original width</span>
<span class="sd">            original_h: Original height</span>
<span class="sd">        Returns:</span>
<span class="sd">            Tuple of (out_w, out_h)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">aspect_ratio</span> <span class="o">=</span> <span class="n">original_w</span> <span class="o">/</span> <span class="n">original_h</span>
        <span class="n">max_dimension</span> <span class="o">=</span> <span class="mi">720</span>

        <span class="k">if</span> <span class="n">aspect_ratio</span> <span class="o">&gt;</span> <span class="mf">1.2</span><span class="p">:</span>
            <span class="n">out_w</span> <span class="o">=</span> <span class="n">max_dimension</span>
            <span class="n">out_h</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_dimension</span> <span class="o">/</span> <span class="n">aspect_ratio</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">aspect_ratio</span> <span class="o">&lt;</span> <span class="mf">0.8</span><span class="p">:</span>
            <span class="n">out_h</span> <span class="o">=</span> <span class="n">max_dimension</span>
            <span class="n">out_w</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_dimension</span> <span class="o">*</span> <span class="n">aspect_ratio</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out_w</span> <span class="o">=</span> <span class="n">max_dimension</span>
            <span class="n">out_h</span> <span class="o">=</span> <span class="n">max_dimension</span>
        <span class="k">return</span> <span class="n">out_w</span><span class="p">,</span> <span class="n">out_h</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_frames_ffmpeg</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">timestamps</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">original_w</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">original_h</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">workers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract multiple frames using a thread pool (parallel ffmpeg processes).</span>
<span class="sd">        Args:</span>
<span class="sd">            filename: Path to video file</span>
<span class="sd">            timestamps: List of times in seconds</span>
<span class="sd">            original_w: Original width of the video</span>
<span class="sd">            original_h: Original height of the video</span>
<span class="sd">            workers: Number of parallel threads</span>
<span class="sd">        Returns:</span>
<span class="sd">          List of (timestamp, PIL.Image) preserving order of timestamps.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">out_w</span><span class="p">,</span> <span class="n">out_h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_output_dimensions</span><span class="p">(</span><span class="n">original_w</span><span class="p">,</span> <span class="n">original_h</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="n">workers</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">futures</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">ex</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_run_ffmpeg_extraction</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">out_w</span><span class="p">,</span> <span class="n">out_h</span><span class="p">):</span> <span class="n">i</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">timestamps</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">fut</span> <span class="ow">in</span> <span class="n">as_completed</span><span class="p">(</span><span class="n">futures</span><span class="p">):</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">futures</span><span class="p">[</span><span class="n">fut</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">img</span> <span class="o">=</span> <span class="n">fut</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                    <span class="n">results</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">img</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Failed to extract frame for </span><span class="si">{</span><span class="n">timestamps</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="si">}</span><span class="s2">s: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

        <span class="k">return</span> <span class="p">[(</span><span class="n">timestamps</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">timestamps</span><span class="p">))]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_make_captions_from_extracted_frames</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">merged_segments</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">video_meta</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">list_of_questions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate captions for all extracted frames and then produce a concise summary of the video.</span>
<span class="sd">        Args:</span>
<span class="sd">            filename (str): Path to the video file.</span>
<span class="sd">            merged_segments (List[Dict[str, Any]]): List of merged segments with frame timestamps.</span>
<span class="sd">            list_of_questions (Optional[List[str]]): List of questions for VQA.</span>
<span class="sd">        Returns:</span>
<span class="sd">            None. Modifies merged_segments in place to add &#39;summary_bullets&#39; and &#39;vqa_bullets&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary_model</span><span class="o">.</span><span class="n">processor</span>

        <span class="n">img_width</span> <span class="o">=</span> <span class="n">video_meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">)</span>
        <span class="n">img_height</span> <span class="o">=</span> <span class="n">video_meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">img_width</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">img_height</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Frame dimensions not found in the last segment for extraction.&quot;</span>
            <span class="p">)</span>

        <span class="k">for</span> <span class="n">seg</span> <span class="ow">in</span> <span class="n">merged_segments</span><span class="p">:</span>  <span class="c1"># TODO might be generator faster, so changes to ffmpeg extraction may be needed</span>
            <span class="n">collected</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">frame_timestamps</span> <span class="o">=</span> <span class="n">seg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;video_frame_timestamps&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">frame_timestamps</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;No frame timestamps found for segment </span><span class="si">{</span><span class="n">seg</span><span class="p">[</span><span class="s1">&#39;start_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s to </span><span class="si">{</span><span class="n">seg</span><span class="p">[</span><span class="s1">&#39;end_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span>
                <span class="p">)</span>
            <span class="n">include_questions</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">list_of_questions</span><span class="p">)</span>
            <span class="n">caption_instruction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt_builder</span><span class="o">.</span><span class="n">build_frame_prompt</span><span class="p">(</span>
                <span class="n">include_vqa</span><span class="o">=</span><span class="n">include_questions</span><span class="p">,</span>
                <span class="n">questions</span><span class="o">=</span><span class="n">list_of_questions</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">pairs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_frames_ffmpeg</span><span class="p">(</span>
                <span class="n">filename</span><span class="p">,</span>
                <span class="n">frame_timestamps</span><span class="p">,</span>
                <span class="n">original_w</span><span class="o">=</span><span class="n">img_width</span><span class="p">,</span>
                <span class="n">original_h</span><span class="o">=</span><span class="n">img_height</span><span class="p">,</span>
                <span class="n">workers</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">prompt_texts</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">ts</span><span class="p">,</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">:</span>
                <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="p">[</span>
                            <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="n">img</span><span class="p">},</span>
                            <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">caption_instruction</span><span class="p">},</span>
                        <span class="p">],</span>
                    <span class="p">}</span>
                <span class="p">]</span>

                <span class="n">prompt_text</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">apply_chat_template</span><span class="p">(</span>
                    <span class="n">messages</span><span class="p">,</span> <span class="n">tokenize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_generation_prompt</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>

                <span class="n">prompt_texts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prompt_text</span><span class="p">)</span>

            <span class="n">processor_inputs</span> <span class="o">=</span> <span class="n">proc</span><span class="p">(</span>
                <span class="n">text</span><span class="o">=</span><span class="n">prompt_texts</span><span class="p">,</span>
                <span class="n">images</span><span class="o">=</span><span class="p">[</span><span class="n">img</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">],</span>
                <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span>
                <span class="n">padding</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">len_objects</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">include_questions</span><span class="p">:</span>
                <span class="n">len_objects</span> <span class="o">*=</span> <span class="mi">2</span>  <span class="c1"># because we expect two outputs per input when questions are included</span>
            <span class="n">captions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_from_processor_inputs</span><span class="p">(</span>
                <span class="n">processor_inputs</span><span class="p">,</span>
                <span class="n">prompt_texts</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">summary_model</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span>
                <span class="n">len_objects</span><span class="o">=</span><span class="n">len_objects</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">frame_timestamps</span><span class="p">,</span> <span class="n">captions</span><span class="p">):</span>
                <span class="n">collected</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">float</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">c</span><span class="p">))</span>

            <span class="n">collected</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">bullets_summary</span><span class="p">,</span> <span class="n">bullets_vqa</span> <span class="o">=</span> <span class="n">_categorize_outputs</span><span class="p">(</span>
                <span class="n">collected</span><span class="p">,</span> <span class="n">include_questions</span>
            <span class="p">)</span>

            <span class="n">seg</span><span class="p">[</span><span class="s2">&quot;summary_bullets&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bullets_summary</span>
            <span class="n">seg</span><span class="p">[</span><span class="s2">&quot;vqa_bullets&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bullets_vqa</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">make_captions_for_subclips</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">entry</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">list_of_questions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate captions for video subclips using both audio and visual information, for a further full video summary/VQA.</span>
<span class="sd">        Args:</span>
<span class="sd">            entry (Dict[str, Any]): Dictionary containing the video file information.</span>
<span class="sd">            list_of_questions (Optional[List[str]]): List of questions for VQA.</span>
<span class="sd">        Returns:</span>
<span class="sd">            List[Dict[str, Any]]: List of dictionaries containing timestamps and generated captions.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;filename&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;entry must contain key &#39;filename&#39;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Video file </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span><span class="p">)</span>

        <span class="n">audio_generated_captions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">audio_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">audio_generated_captions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_transcribe_audio_part</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;audio_descriptions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">audio_generated_captions</span>

        <span class="n">video_result_segments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_frame_timestamps_from_clip</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">video_segments_w_timestamps</span> <span class="o">=</span> <span class="n">video_result_segments</span><span class="p">[</span><span class="s2">&quot;segments&quot;</span><span class="p">]</span>
        <span class="n">video_meta</span> <span class="o">=</span> <span class="n">video_result_segments</span><span class="p">[</span><span class="s2">&quot;video_meta&quot;</span><span class="p">]</span>
        <span class="n">merged_segments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_audio_visual_boundaries</span><span class="p">(</span>
            <span class="n">audio_generated_captions</span><span class="p">,</span>
            <span class="n">video_segments_w_timestamps</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_make_captions_from_extracted_frames</span><span class="p">(</span>
            <span class="n">filename</span><span class="p">,</span>
            <span class="n">merged_segments</span><span class="p">,</span>
            <span class="n">video_meta</span><span class="p">,</span>
            <span class="n">list_of_questions</span><span class="o">=</span><span class="n">list_of_questions</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary_model</span><span class="o">.</span><span class="n">processor</span>
        <span class="k">for</span> <span class="n">seg</span> <span class="ow">in</span> <span class="n">merged_segments</span><span class="p">:</span>
            <span class="n">frame_timestamps</span> <span class="o">=</span> <span class="n">seg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;video_frame_timestamps&quot;</span><span class="p">,</span> <span class="p">[])</span>

            <span class="n">collected</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">include_audio</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">audio_lines</span> <span class="o">=</span> <span class="n">seg</span><span class="p">[</span><span class="s2">&quot;audio_phrases&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">audio_lines</span><span class="p">:</span>
                <span class="n">include_audio</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">include_questions</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">list_of_questions</span><span class="p">)</span>
            <span class="n">caption_instruction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt_builder</span><span class="o">.</span><span class="n">build_clip_prompt</span><span class="p">(</span>
                <span class="n">frame_bullets</span><span class="o">=</span><span class="n">seg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary_bullets&quot;</span><span class="p">,</span> <span class="p">[]),</span>
                <span class="n">include_audio</span><span class="o">=</span><span class="n">include_audio</span><span class="p">,</span>
                <span class="n">audio_transcription</span><span class="o">=</span><span class="n">seg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;audio_phrases&quot;</span><span class="p">,</span> <span class="p">[]),</span>
                <span class="n">include_vqa</span><span class="o">=</span><span class="n">include_questions</span><span class="p">,</span>
                <span class="n">questions</span><span class="o">=</span><span class="n">list_of_questions</span><span class="p">,</span>
                <span class="n">vqa_bullets</span><span class="o">=</span><span class="n">seg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;vqa_bullets&quot;</span><span class="p">,</span> <span class="p">[]),</span>
            <span class="p">)</span>
            <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">caption_instruction</span><span class="p">}],</span>
                <span class="p">}</span>
            <span class="p">]</span>
            <span class="n">prompt_text</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">apply_chat_template</span><span class="p">(</span>
                <span class="n">messages</span><span class="p">,</span> <span class="n">tokenize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_generation_prompt</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="n">processor_inputs</span> <span class="o">=</span> <span class="n">proc</span><span class="p">(</span>
                <span class="n">text</span><span class="o">=</span><span class="p">[</span><span class="n">prompt_text</span><span class="p">],</span>
                <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span>
                <span class="n">padding</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">final_outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_from_processor_inputs</span><span class="p">(</span>
                <span class="n">processor_inputs</span><span class="p">,</span>
                <span class="p">[</span><span class="n">prompt_text</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">summary_model</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">frame_timestamps</span><span class="p">,</span> <span class="n">final_outputs</span><span class="p">):</span>
                <span class="n">collected</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">float</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">c</span><span class="p">))</span>

            <span class="n">collected</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">bullets_summary</span><span class="p">,</span> <span class="n">bullets_vqa</span> <span class="o">=</span> <span class="n">_categorize_outputs</span><span class="p">(</span>
                <span class="n">collected</span><span class="p">,</span> <span class="n">include_questions</span>
            <span class="p">)</span>

            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;start_time&quot;</span><span class="p">:</span> <span class="n">seg</span><span class="p">[</span><span class="s2">&quot;start_time&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;end_time&quot;</span><span class="p">:</span> <span class="n">seg</span><span class="p">[</span><span class="s2">&quot;end_time&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;summary_bullets&quot;</span><span class="p">:</span> <span class="n">bullets_summary</span><span class="p">,</span>
                    <span class="s2">&quot;vqa_bullets&quot;</span><span class="p">:</span> <span class="n">bullets_vqa</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">final_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">summary_dict</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Produce a concise summary of the video, based on generated captions for all extracted frames.</span>
<span class="sd">        Args:</span>
<span class="sd">            summary_dict (Dict[str, Any]): Dictionary containing captions for the frames.</span>
<span class="sd">        Returns:</span>
<span class="sd">            Dict[str, Any]: A dictionary containing the list of captions with timestamps and the final summary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary_model</span><span class="o">.</span><span class="n">processor</span>

        <span class="n">bullets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">seg</span> <span class="ow">in</span> <span class="n">summary_dict</span><span class="p">:</span>
            <span class="n">seg_bullets</span> <span class="o">=</span> <span class="n">seg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary_bullets&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">bullets</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">seg_bullets</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bullets</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No captions available for summary generation.&quot;</span><span class="p">)</span>

        <span class="n">summary_user_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt_builder</span><span class="o">.</span><span class="n">build_video_prompt</span><span class="p">(</span>
            <span class="n">include_vqa</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">clip_summaries</span><span class="o">=</span><span class="n">bullets</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
                <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">summary_user_prompt</span><span class="p">}],</span>
            <span class="p">}</span>
        <span class="p">]</span>

        <span class="n">summary_prompt_text</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">apply_chat_template</span><span class="p">(</span>
            <span class="n">messages</span><span class="p">,</span> <span class="n">tokenize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_generation_prompt</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="n">summary_inputs</span> <span class="o">=</span> <span class="n">proc</span><span class="p">(</span>
            <span class="n">text</span><span class="o">=</span><span class="p">[</span><span class="n">summary_prompt_text</span><span class="p">],</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="n">summary_inputs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">summary_model</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="k">else</span> <span class="n">v</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">summary_inputs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="n">final_summary_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_from_processor_inputs</span><span class="p">(</span>
            <span class="n">summary_inputs</span><span class="p">,</span>
            <span class="p">[</span><span class="n">summary_prompt_text</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">summary_model</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">final_summary</span> <span class="o">=</span> <span class="n">final_summary_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="n">final_summary_list</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="n">final_summary</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">final_answers</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">answers_dict</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">list_of_questions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Answer the list of questions for the video based on the VQA bullets from the frames.</span>
<span class="sd">        Args:</span>
<span class="sd">            answers_dict (Dict[str, Any]): Dictionary containing the VQA bullets.</span>
<span class="sd">        Returns:</span>
<span class="sd">            Dict[str, Any]: A dictionary containing the list of answers to the questions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vqa_bullets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">summary_bullets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">seg</span> <span class="ow">in</span> <span class="n">answers_dict</span><span class="p">:</span>
            <span class="n">summary_bullets</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">seg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary_bullets&quot;</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="n">seg_bullets</span> <span class="o">=</span> <span class="n">seg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;vqa_bullets&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">vqa_bullets</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">seg_bullets</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">vqa_bullets</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;No VQA bullets generated for single frames available for answering questions.&quot;</span>
            <span class="p">)</span>

        <span class="n">include_questions</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">list_of_questions</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">include_questions</span><span class="p">:</span>
            <span class="n">prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt_builder</span><span class="o">.</span><span class="n">build_video_prompt</span><span class="p">(</span>
                <span class="n">include_vqa</span><span class="o">=</span><span class="n">include_questions</span><span class="p">,</span>
                <span class="n">questions</span><span class="o">=</span><span class="n">list_of_questions</span><span class="p">,</span>
                <span class="n">vqa_bullets</span><span class="o">=</span><span class="n">vqa_bullets</span><span class="p">,</span>
                <span class="n">clip_summaries</span><span class="o">=</span><span class="n">summary_bullets</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;list_of_questions must be provided for making final answers.&quot;</span>
            <span class="p">)</span>

        <span class="n">proc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary_model</span><span class="o">.</span><span class="n">processor</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
                <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}],</span>
            <span class="p">}</span>
        <span class="p">]</span>
        <span class="n">final_vqa_prompt_text</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">apply_chat_template</span><span class="p">(</span>
            <span class="n">messages</span><span class="p">,</span> <span class="n">tokenize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_generation_prompt</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">final_vqa_inputs</span> <span class="o">=</span> <span class="n">proc</span><span class="p">(</span>
            <span class="n">text</span><span class="o">=</span><span class="p">[</span><span class="n">final_vqa_prompt_text</span><span class="p">],</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">final_vqa_inputs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">summary_model</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="k">else</span> <span class="n">v</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">final_vqa_inputs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="n">final_vqa_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_from_processor_inputs</span><span class="p">(</span>
            <span class="n">final_vqa_inputs</span><span class="p">,</span>
            <span class="p">[</span><span class="n">final_vqa_prompt_text</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">summary_model</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">final_vqa_output</span> <span class="o">=</span> <span class="n">final_vqa_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="n">final_vqa_list</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">vqa_answers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">answer_matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span>
            <span class="sa">r</span><span class="s2">&quot;\d+\.\s+(.+?)(?=\n\d+\.|$)&quot;</span><span class="p">,</span> <span class="n">final_vqa_output</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">answer</span> <span class="ow">in</span> <span class="n">answer_matches</span><span class="p">:</span>
            <span class="n">vqa_answers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">answer</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;vqa_answers&quot;</span><span class="p">:</span> <span class="n">vqa_answers</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analyse_videos_from_dict</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">analysis_type</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">AnalysisType</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">AnalysisType</span><span class="o">.</span><span class="n">SUMMARY</span><span class="p">,</span>
        <span class="n">list_of_questions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Analyse the video specified in self.subdict using frame extraction and captioning.</span>
<span class="sd">        Args:</span>
<span class="sd">            analysis_type (Union[AnalysisType, str], optional): Type of analysis to perform. Defaults to AnalysisType.SUMMARY.</span>
<span class="sd">            list_of_questions (List[str], optional): List of questions to answer about the video. Required if analysis_type includes questions.</span>
<span class="sd">        Returns:</span>
<span class="sd">            Dict[str, Any]: A dictionary containing the analysis results, including summary and answers for provided questions(if any).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">list_of_questions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">list_of_questions</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Expected list_of_questions to be a list of strings.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">list_of_questions</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">list_of_questions</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;All items in list_of_questions must be strings.&quot;</span><span class="p">)</span>

        <span class="n">analysis_type</span><span class="p">,</span> <span class="n">is_summary</span><span class="p">,</span> <span class="n">is_questions</span> <span class="o">=</span> <span class="n">AnalysisType</span><span class="o">.</span><span class="n">_validate_analysis_type</span><span class="p">(</span>
            <span class="n">analysis_type</span><span class="p">,</span> <span class="n">list_of_questions</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">video_key</span><span class="p">,</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">answers_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_captions_for_subclips</span><span class="p">(</span>
                <span class="n">entry</span><span class="p">,</span>
                <span class="n">list_of_questions</span><span class="o">=</span><span class="n">list_of_questions</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">is_summary</span><span class="p">:</span>
                <span class="n">answer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_summary</span><span class="p">(</span><span class="n">answers_dict</span><span class="p">)</span>
                <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">answer</span><span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">is_questions</span><span class="p">:</span>
                <span class="n">answer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_answers</span><span class="p">(</span><span class="n">answers_dict</span><span class="p">,</span> <span class="n">list_of_questions</span><span class="p">)</span>
                <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;vqa_answers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">answer</span><span class="p">[</span><span class="s2">&quot;vqa_answers&quot;</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="p">[</span><span class="n">video_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="ammico.video_summary.VideoSummaryDetector.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">summary_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">audio_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subdict</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Class for analysing videos using QWEN-2.5-VL model.
It provides methods for generating captions and answering questions about videos.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>summary_model</code>
            </td>
            <td>
                  <code>[<span title="type">type</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An instance of MultimodalSummaryModel to be used for analysis.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>subdict</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing the video to be analysed. Defaults to {}.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>None.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ammico/video_summary.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">summary_model</span><span class="p">:</span> <span class="n">MultimodalSummaryModel</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">audio_model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AudioToTextModel</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">subdict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class for analysing videos using QWEN-2.5-VL model.</span>
<span class="sd">    It provides methods for generating captions and answering questions about videos.</span>

<span class="sd">    Args:</span>
<span class="sd">        summary_model ([type], optional): An instance of MultimodalSummaryModel to be used for analysis.</span>
<span class="sd">        subdict (dict, optional): Dictionary containing the video to be analysed. Defaults to {}.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">subdict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">subdict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">subdict</span><span class="p">)</span>
    <span class="n">_validate_subdict</span><span class="p">(</span><span class="n">subdict</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">summary_model</span> <span class="o">=</span> <span class="n">summary_model</span> <span class="ow">or</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">audio_model</span> <span class="o">=</span> <span class="n">audio_model</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">prompt_builder</span> <span class="o">=</span> <span class="n">PromptBuilder</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ammico.video_summary.VideoSummaryDetector.analyse_videos_from_dict" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">analyse_videos_from_dict</span><span class="p">(</span><span class="n">analysis_type</span><span class="o">=</span><span class="n">AnalysisType</span><span class="o">.</span><span class="n">SUMMARY</span><span class="p">,</span> <span class="n">list_of_questions</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Analyse the video specified in self.subdict using frame extraction and captioning.
Args:
    analysis_type (Union[AnalysisType, str], optional): Type of analysis to perform. Defaults to AnalysisType.SUMMARY.
    list_of_questions (List[str], optional): List of questions to answer about the video. Required if analysis_type includes questions.
Returns:
    Dict[str, Any]: A dictionary containing the analysis results, including summary and answers for provided questions(if any).</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ammico/video_summary.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">analyse_videos_from_dict</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">analysis_type</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">AnalysisType</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">AnalysisType</span><span class="o">.</span><span class="n">SUMMARY</span><span class="p">,</span>
    <span class="n">list_of_questions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Analyse the video specified in self.subdict using frame extraction and captioning.</span>
<span class="sd">    Args:</span>
<span class="sd">        analysis_type (Union[AnalysisType, str], optional): Type of analysis to perform. Defaults to AnalysisType.SUMMARY.</span>
<span class="sd">        list_of_questions (List[str], optional): List of questions to answer about the video. Required if analysis_type includes questions.</span>
<span class="sd">    Returns:</span>
<span class="sd">        Dict[str, Any]: A dictionary containing the analysis results, including summary and answers for provided questions(if any).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">list_of_questions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">list_of_questions</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Expected list_of_questions to be a list of strings.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">list_of_questions</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">list_of_questions</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;All items in list_of_questions must be strings.&quot;</span><span class="p">)</span>

    <span class="n">analysis_type</span><span class="p">,</span> <span class="n">is_summary</span><span class="p">,</span> <span class="n">is_questions</span> <span class="o">=</span> <span class="n">AnalysisType</span><span class="o">.</span><span class="n">_validate_analysis_type</span><span class="p">(</span>
        <span class="n">analysis_type</span><span class="p">,</span> <span class="n">list_of_questions</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">video_key</span><span class="p">,</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">answers_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_captions_for_subclips</span><span class="p">(</span>
            <span class="n">entry</span><span class="p">,</span>
            <span class="n">list_of_questions</span><span class="o">=</span><span class="n">list_of_questions</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">is_summary</span><span class="p">:</span>
            <span class="n">answer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_summary</span><span class="p">(</span><span class="n">answers_dict</span><span class="p">)</span>
            <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">answer</span><span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">is_questions</span><span class="p">:</span>
            <span class="n">answer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_answers</span><span class="p">(</span><span class="n">answers_dict</span><span class="p">,</span> <span class="n">list_of_questions</span><span class="p">)</span>
            <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;vqa_answers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">answer</span><span class="p">[</span><span class="s2">&quot;vqa_answers&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="p">[</span><span class="n">video_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ammico.video_summary.VideoSummaryDetector.final_answers" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">final_answers</span><span class="p">(</span><span class="n">answers_dict</span><span class="p">,</span> <span class="n">list_of_questions</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Answer the list of questions for the video based on the VQA bullets from the frames.
Args:
    answers_dict (Dict[str, Any]): Dictionary containing the VQA bullets.
Returns:
    Dict[str, Any]: A dictionary containing the list of answers to the questions.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ammico/video_summary.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">final_answers</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">answers_dict</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
    <span class="n">list_of_questions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Answer the list of questions for the video based on the VQA bullets from the frames.</span>
<span class="sd">    Args:</span>
<span class="sd">        answers_dict (Dict[str, Any]): Dictionary containing the VQA bullets.</span>
<span class="sd">    Returns:</span>
<span class="sd">        Dict[str, Any]: A dictionary containing the list of answers to the questions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">vqa_bullets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">summary_bullets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">seg</span> <span class="ow">in</span> <span class="n">answers_dict</span><span class="p">:</span>
        <span class="n">summary_bullets</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">seg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary_bullets&quot;</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="n">seg_bullets</span> <span class="o">=</span> <span class="n">seg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;vqa_bullets&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">vqa_bullets</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">seg_bullets</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">vqa_bullets</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;No VQA bullets generated for single frames available for answering questions.&quot;</span>
        <span class="p">)</span>

    <span class="n">include_questions</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">list_of_questions</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">include_questions</span><span class="p">:</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt_builder</span><span class="o">.</span><span class="n">build_video_prompt</span><span class="p">(</span>
            <span class="n">include_vqa</span><span class="o">=</span><span class="n">include_questions</span><span class="p">,</span>
            <span class="n">questions</span><span class="o">=</span><span class="n">list_of_questions</span><span class="p">,</span>
            <span class="n">vqa_bullets</span><span class="o">=</span><span class="n">vqa_bullets</span><span class="p">,</span>
            <span class="n">clip_summaries</span><span class="o">=</span><span class="n">summary_bullets</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;list_of_questions must be provided for making final answers.&quot;</span>
        <span class="p">)</span>

    <span class="n">proc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary_model</span><span class="o">.</span><span class="n">processor</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
            <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}],</span>
        <span class="p">}</span>
    <span class="p">]</span>
    <span class="n">final_vqa_prompt_text</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">apply_chat_template</span><span class="p">(</span>
        <span class="n">messages</span><span class="p">,</span> <span class="n">tokenize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_generation_prompt</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">final_vqa_inputs</span> <span class="o">=</span> <span class="n">proc</span><span class="p">(</span>
        <span class="n">text</span><span class="o">=</span><span class="p">[</span><span class="n">final_vqa_prompt_text</span><span class="p">],</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">final_vqa_inputs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">summary_model</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="k">else</span> <span class="n">v</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">final_vqa_inputs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="n">final_vqa_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_from_processor_inputs</span><span class="p">(</span>
        <span class="n">final_vqa_inputs</span><span class="p">,</span>
        <span class="p">[</span><span class="n">final_vqa_prompt_text</span><span class="p">],</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">summary_model</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">final_vqa_output</span> <span class="o">=</span> <span class="n">final_vqa_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="n">final_vqa_list</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
    <span class="n">vqa_answers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">answer_matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span>
        <span class="sa">r</span><span class="s2">&quot;\d+\.\s+(.+?)(?=\n\d+\.|$)&quot;</span><span class="p">,</span> <span class="n">final_vqa_output</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">answer</span> <span class="ow">in</span> <span class="n">answer_matches</span><span class="p">:</span>
        <span class="n">vqa_answers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">answer</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;vqa_answers&quot;</span><span class="p">:</span> <span class="n">vqa_answers</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ammico.video_summary.VideoSummaryDetector.final_summary" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">final_summary</span><span class="p">(</span><span class="n">summary_dict</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Produce a concise summary of the video, based on generated captions for all extracted frames.
Args:
    summary_dict (Dict[str, Any]): Dictionary containing captions for the frames.
Returns:
    Dict[str, Any]: A dictionary containing the list of captions with timestamps and the final summary.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ammico/video_summary.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">final_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">summary_dict</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Produce a concise summary of the video, based on generated captions for all extracted frames.</span>
<span class="sd">    Args:</span>
<span class="sd">        summary_dict (Dict[str, Any]): Dictionary containing captions for the frames.</span>
<span class="sd">    Returns:</span>
<span class="sd">        Dict[str, Any]: A dictionary containing the list of captions with timestamps and the final summary.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary_model</span><span class="o">.</span><span class="n">processor</span>

    <span class="n">bullets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">seg</span> <span class="ow">in</span> <span class="n">summary_dict</span><span class="p">:</span>
        <span class="n">seg_bullets</span> <span class="o">=</span> <span class="n">seg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary_bullets&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">bullets</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">seg_bullets</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">bullets</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No captions available for summary generation.&quot;</span><span class="p">)</span>

    <span class="n">summary_user_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt_builder</span><span class="o">.</span><span class="n">build_video_prompt</span><span class="p">(</span>
        <span class="n">include_vqa</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">clip_summaries</span><span class="o">=</span><span class="n">bullets</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
            <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">summary_user_prompt</span><span class="p">}],</span>
        <span class="p">}</span>
    <span class="p">]</span>

    <span class="n">summary_prompt_text</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">apply_chat_template</span><span class="p">(</span>
        <span class="n">messages</span><span class="p">,</span> <span class="n">tokenize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_generation_prompt</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="n">summary_inputs</span> <span class="o">=</span> <span class="n">proc</span><span class="p">(</span>
        <span class="n">text</span><span class="o">=</span><span class="p">[</span><span class="n">summary_prompt_text</span><span class="p">],</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="n">summary_inputs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">summary_model</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="k">else</span> <span class="n">v</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">summary_inputs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="n">final_summary_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_from_processor_inputs</span><span class="p">(</span>
        <span class="n">summary_inputs</span><span class="p">,</span>
        <span class="p">[</span><span class="n">summary_prompt_text</span><span class="p">],</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">summary_model</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">final_summary</span> <span class="o">=</span> <span class="n">final_summary_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="n">final_summary_list</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="n">final_summary</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ammico.video_summary.VideoSummaryDetector.make_captions_for_subclips" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">make_captions_for_subclips</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">list_of_questions</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Generate captions for video subclips using both audio and visual information, for a further full video summary/VQA.
Args:
    entry (Dict[str, Any]): Dictionary containing the video file information.
    list_of_questions (Optional[List[str]]): List of questions for VQA.
Returns:
    List[Dict[str, Any]]: List of dictionaries containing timestamps and generated captions.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ammico/video_summary.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span>
<span class="normal">936</span>
<span class="normal">937</span>
<span class="normal">938</span>
<span class="normal">939</span>
<span class="normal">940</span>
<span class="normal">941</span>
<span class="normal">942</span>
<span class="normal">943</span>
<span class="normal">944</span>
<span class="normal">945</span>
<span class="normal">946</span>
<span class="normal">947</span>
<span class="normal">948</span>
<span class="normal">949</span>
<span class="normal">950</span>
<span class="normal">951</span>
<span class="normal">952</span>
<span class="normal">953</span>
<span class="normal">954</span>
<span class="normal">955</span>
<span class="normal">956</span>
<span class="normal">957</span>
<span class="normal">958</span>
<span class="normal">959</span>
<span class="normal">960</span>
<span class="normal">961</span>
<span class="normal">962</span>
<span class="normal">963</span>
<span class="normal">964</span>
<span class="normal">965</span>
<span class="normal">966</span>
<span class="normal">967</span>
<span class="normal">968</span>
<span class="normal">969</span>
<span class="normal">970</span>
<span class="normal">971</span>
<span class="normal">972</span>
<span class="normal">973</span>
<span class="normal">974</span>
<span class="normal">975</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">make_captions_for_subclips</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">entry</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">list_of_questions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate captions for video subclips using both audio and visual information, for a further full video summary/VQA.</span>
<span class="sd">    Args:</span>
<span class="sd">        entry (Dict[str, Any]): Dictionary containing the video file information.</span>
<span class="sd">        list_of_questions (Optional[List[str]]): List of questions for VQA.</span>
<span class="sd">    Returns:</span>
<span class="sd">        List[Dict[str, Any]]: List of dictionaries containing timestamps and generated captions.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">filename</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;filename&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;entry must contain key &#39;filename&#39;&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Video file </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span><span class="p">)</span>

    <span class="n">audio_generated_captions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">audio_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">audio_generated_captions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_transcribe_audio_part</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;audio_descriptions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">audio_generated_captions</span>

    <span class="n">video_result_segments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_frame_timestamps_from_clip</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">video_segments_w_timestamps</span> <span class="o">=</span> <span class="n">video_result_segments</span><span class="p">[</span><span class="s2">&quot;segments&quot;</span><span class="p">]</span>
    <span class="n">video_meta</span> <span class="o">=</span> <span class="n">video_result_segments</span><span class="p">[</span><span class="s2">&quot;video_meta&quot;</span><span class="p">]</span>
    <span class="n">merged_segments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_audio_visual_boundaries</span><span class="p">(</span>
        <span class="n">audio_generated_captions</span><span class="p">,</span>
        <span class="n">video_segments_w_timestamps</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_make_captions_from_extracted_frames</span><span class="p">(</span>
        <span class="n">filename</span><span class="p">,</span>
        <span class="n">merged_segments</span><span class="p">,</span>
        <span class="n">video_meta</span><span class="p">,</span>
        <span class="n">list_of_questions</span><span class="o">=</span><span class="n">list_of_questions</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary_model</span><span class="o">.</span><span class="n">processor</span>
    <span class="k">for</span> <span class="n">seg</span> <span class="ow">in</span> <span class="n">merged_segments</span><span class="p">:</span>
        <span class="n">frame_timestamps</span> <span class="o">=</span> <span class="n">seg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;video_frame_timestamps&quot;</span><span class="p">,</span> <span class="p">[])</span>

        <span class="n">collected</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">include_audio</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">audio_lines</span> <span class="o">=</span> <span class="n">seg</span><span class="p">[</span><span class="s2">&quot;audio_phrases&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">audio_lines</span><span class="p">:</span>
            <span class="n">include_audio</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">include_questions</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">list_of_questions</span><span class="p">)</span>
        <span class="n">caption_instruction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt_builder</span><span class="o">.</span><span class="n">build_clip_prompt</span><span class="p">(</span>
            <span class="n">frame_bullets</span><span class="o">=</span><span class="n">seg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary_bullets&quot;</span><span class="p">,</span> <span class="p">[]),</span>
            <span class="n">include_audio</span><span class="o">=</span><span class="n">include_audio</span><span class="p">,</span>
            <span class="n">audio_transcription</span><span class="o">=</span><span class="n">seg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;audio_phrases&quot;</span><span class="p">,</span> <span class="p">[]),</span>
            <span class="n">include_vqa</span><span class="o">=</span><span class="n">include_questions</span><span class="p">,</span>
            <span class="n">questions</span><span class="o">=</span><span class="n">list_of_questions</span><span class="p">,</span>
            <span class="n">vqa_bullets</span><span class="o">=</span><span class="n">seg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;vqa_bullets&quot;</span><span class="p">,</span> <span class="p">[]),</span>
        <span class="p">)</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
                <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">caption_instruction</span><span class="p">}],</span>
            <span class="p">}</span>
        <span class="p">]</span>
        <span class="n">prompt_text</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">apply_chat_template</span><span class="p">(</span>
            <span class="n">messages</span><span class="p">,</span> <span class="n">tokenize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_generation_prompt</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">processor_inputs</span> <span class="o">=</span> <span class="n">proc</span><span class="p">(</span>
            <span class="n">text</span><span class="o">=</span><span class="p">[</span><span class="n">prompt_text</span><span class="p">],</span>
            <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span>
            <span class="n">padding</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">final_outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_from_processor_inputs</span><span class="p">(</span>
            <span class="n">processor_inputs</span><span class="p">,</span>
            <span class="p">[</span><span class="n">prompt_text</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">summary_model</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">frame_timestamps</span><span class="p">,</span> <span class="n">final_outputs</span><span class="p">):</span>
            <span class="n">collected</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">float</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">c</span><span class="p">))</span>

        <span class="n">collected</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">bullets_summary</span><span class="p">,</span> <span class="n">bullets_vqa</span> <span class="o">=</span> <span class="n">_categorize_outputs</span><span class="p">(</span>
            <span class="n">collected</span><span class="p">,</span> <span class="n">include_questions</span>
        <span class="p">)</span>

        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;start_time&quot;</span><span class="p">:</span> <span class="n">seg</span><span class="p">[</span><span class="s2">&quot;start_time&quot;</span><span class="p">],</span>
                <span class="s2">&quot;end_time&quot;</span><span class="p">:</span> <span class="n">seg</span><span class="p">[</span><span class="s2">&quot;end_time&quot;</span><span class="p">],</span>
                <span class="s2">&quot;summary_bullets&quot;</span><span class="p">:</span> <span class="n">bullets_summary</span><span class="p">,</span>
                <span class="s2">&quot;vqa_bullets&quot;</span><span class="p">:</span> <span class="n">bullets_vqa</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">results</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ammico.video_summary.VideoSummaryDetector.merge_audio_visual_boundaries" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">merge_audio_visual_boundaries</span><span class="p">(</span><span class="n">audio_segs</span><span class="p">,</span> <span class="n">video_segs</span><span class="p">,</span> <span class="n">segment_threshold_duration</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Merge audio phrase boundaries and video scene cuts into coherent temporal segments for the model
Args:
    audio_segs: List of audio segments with 'start_time' and 'end_time'
    video_segs: List of video segments with 'start_time' and 'end_time'
    segment_threshold_duration: Duration to create a new segment boundary
Returns:
    List of merged segments</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ammico/video_summary.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">merge_audio_visual_boundaries</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">audio_segs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
    <span class="n">video_segs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
    <span class="n">segment_threshold_duration</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Merge audio phrase boundaries and video scene cuts into coherent temporal segments for the model</span>
<span class="sd">    Args:</span>
<span class="sd">        audio_segs: List of audio segments with &#39;start_time&#39; and &#39;end_time&#39;</span>
<span class="sd">        video_segs: List of video segments with &#39;start_time&#39; and &#39;end_time&#39;</span>
<span class="sd">        segment_threshold_duration: Duration to create a new segment boundary</span>
<span class="sd">    Returns:</span>
<span class="sd">        List of merged segments</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">audio_segs</span><span class="p">:</span>
        <span class="n">new_vid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_combine_visual_frames_by_time</span><span class="p">(</span><span class="n">video_segs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_vid</span>

    <span class="n">events</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;audio&quot;</span><span class="p">,</span> <span class="n">seg</span><span class="p">[</span><span class="s2">&quot;start_time&quot;</span><span class="p">],</span> <span class="n">seg</span><span class="p">[</span><span class="s2">&quot;end_time&quot;</span><span class="p">],</span> <span class="n">seg</span><span class="p">)</span> <span class="k">for</span> <span class="n">seg</span> <span class="ow">in</span> <span class="n">audio_segs</span>
    <span class="p">]</span> <span class="o">+</span> <span class="p">[(</span><span class="s2">&quot;video&quot;</span><span class="p">,</span> <span class="n">seg</span><span class="p">[</span><span class="s2">&quot;start_time&quot;</span><span class="p">],</span> <span class="n">seg</span><span class="p">[</span><span class="s2">&quot;end_time&quot;</span><span class="p">],</span> <span class="n">seg</span><span class="p">)</span> <span class="k">for</span> <span class="n">seg</span> <span class="ow">in</span> <span class="n">video_segs</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">events</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No audio and video segments to merge.&quot;</span><span class="p">)</span>

    <span class="n">events</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">global_last_end</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">events</span><span class="p">)</span>
    <span class="c1"># Create merged segments respecting both boundaries</span>
    <span class="n">merged</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">current_segment_start</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">current_audio_phrases</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">current_video_scenes</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">event_type</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
        <span class="n">current_duration</span> <span class="o">=</span> <span class="n">start</span> <span class="o">-</span> <span class="n">current_segment_start</span>
        <span class="k">if</span> <span class="n">current_duration</span> <span class="o">&gt;</span> <span class="n">segment_threshold_duration</span><span class="p">:</span>
            <span class="n">segment_end</span> <span class="o">=</span> <span class="n">start</span>

            <span class="k">if</span> <span class="n">segment_end</span> <span class="o">&lt;</span> <span class="n">current_segment_start</span><span class="p">:</span>
                <span class="n">segment_end</span> <span class="o">=</span> <span class="n">current_segment_start</span>

            <span class="n">merged</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;start_time&quot;</span><span class="p">:</span> <span class="n">current_segment_start</span><span class="p">,</span>
                    <span class="s2">&quot;end_time&quot;</span><span class="p">:</span> <span class="n">segment_end</span><span class="p">,</span>
                    <span class="s2">&quot;audio_phrases&quot;</span><span class="p">:</span> <span class="n">current_audio_phrases</span><span class="p">,</span>
                    <span class="s2">&quot;video_scenes&quot;</span><span class="p">:</span> <span class="n">current_video_scenes</span><span class="p">,</span>
                    <span class="s2">&quot;duration&quot;</span><span class="p">:</span> <span class="n">segment_end</span> <span class="o">-</span> <span class="n">current_segment_start</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="c1"># start a new segment at the current event&#39;s start</span>
            <span class="n">current_segment_start</span> <span class="o">=</span> <span class="n">segment_end</span>
            <span class="n">current_audio_phrases</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">current_video_scenes</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">event_type</span> <span class="o">==</span> <span class="s2">&quot;audio&quot;</span><span class="p">:</span>
            <span class="n">current_audio_phrases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">current_video_scenes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">current_audio_phrases</span> <span class="ow">or</span> <span class="n">current_video_scenes</span><span class="p">:</span>
        <span class="n">final_end</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">global_last_end</span><span class="p">,</span> <span class="n">events</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="n">current_segment_start</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">final_end</span> <span class="o">&lt;</span> <span class="n">current_segment_start</span><span class="p">:</span>
            <span class="n">final_end</span> <span class="o">=</span> <span class="n">current_segment_start</span>

        <span class="n">merged</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;start_time&quot;</span><span class="p">:</span> <span class="n">current_segment_start</span><span class="p">,</span>
                <span class="s2">&quot;end_time&quot;</span><span class="p">:</span> <span class="n">final_end</span><span class="p">,</span>
                <span class="s2">&quot;audio_phrases&quot;</span><span class="p">:</span> <span class="n">current_audio_phrases</span><span class="p">,</span>
                <span class="s2">&quot;video_scenes&quot;</span><span class="p">:</span> <span class="n">current_video_scenes</span><span class="p">,</span>
                <span class="s2">&quot;duration&quot;</span><span class="p">:</span> <span class="n">final_end</span> <span class="o">-</span> <span class="n">current_segment_start</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_reassign_video_timestamps_to_segments</span><span class="p">(</span><span class="n">merged</span><span class="p">,</span> <span class="n">video_segs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">merged</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div><h2 id="colors">Colors</h2>


<div class="doc doc-object doc-module">



<a id="ammico.colors"></a>
    <div class="doc doc-contents first">










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="ammico.colors.ColorDetector" class="doc doc-heading">
            <code>ColorDetector</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="AnalysisMethod (ammico.utils.AnalysisMethod)" href="#ammico.utils.AnalysisMethod">AnalysisMethod</a></code></p>










              <details class="mkdocstrings-source">
                <summary>Source code in <code>ammico/colors.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ColorDetector</span><span class="p">(</span><span class="n">AnalysisMethod</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">subdict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">delta_e_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;CIE 1976&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Color Analysis class, analyse hue and identify named colors.</span>

<span class="sd">        Args:</span>
<span class="sd">            subdict (dict): The dictionary containing the image path.</span>
<span class="sd">            delta_e_method (str): The calculation method used for assigning the</span>
<span class="sd">                closest color name, defaults to &quot;CIE 1976&quot;.</span>
<span class="sd">                The available options are: &#39;CIE 1976&#39;, &#39;CIE 1994&#39;, &#39;CIE 2000&#39;,</span>
<span class="sd">                &#39;CMC&#39;, &#39;ITP&#39;, &#39;CAM02-LCD&#39;, &#39;CAM02-SCD&#39;, &#39;CAM02-UCS&#39;, &#39;CAM16-LCD&#39;,</span>
<span class="sd">                &#39;CAM16-SCD&#39;, &#39;CAM16-UCS&#39;, &#39;DIN99&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">subdict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_keys</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">merge_color</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_colors</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="k">if</span> <span class="n">delta_e_method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">COLOR_SCHEMES</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Invalid selection for assigning the color name. Please select one of </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">COLOR_SCHEMES</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delta_e_method</span> <span class="o">=</span> <span class="n">delta_e_method</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;red&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;green&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;blue&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;yellow&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;cyan&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;orange&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;purple&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;pink&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;brown&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;grey&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;white&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;black&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">colors</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analyse_image</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Uses the colorgram library to extract the n most common colors from the images.</span>
<span class="sd">        One problem is, that the most common colors are taken before beeing categorized,</span>
<span class="sd">        so for small values it might occur that the ten most common colors are shades of grey,</span>
<span class="sd">        while other colors are present but will be ignored. Because of this n_colors=100 was chosen as default.</span>

<span class="sd">        The colors are then matched to the closest color in the CSS3 color list using the delta-e metric.</span>
<span class="sd">        They are then merged into one data frame.</span>
<span class="sd">        The colors can be reduced to a smaller list of colors using the get_color_table function.</span>
<span class="sd">        These colors are: &quot;red&quot;, &quot;green&quot;, &quot;blue&quot;, &quot;yellow&quot;,&quot;cyan&quot;, &quot;orange&quot;, &quot;purple&quot;, &quot;pink&quot;, &quot;brown&quot;, &quot;grey&quot;, &quot;white&quot;, &quot;black&quot;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Dictionary with color names as keys and percentage of color in image as values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span>

        <span class="n">colors</span> <span class="o">=</span> <span class="n">colorgram</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_colors</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">color</span> <span class="ow">in</span> <span class="n">colors</span><span class="p">:</span>
            <span class="n">rgb_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rgb2name</span><span class="p">(</span>
                <span class="n">color</span><span class="o">.</span><span class="n">rgb</span><span class="p">,</span>
                <span class="n">merge_color</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">merge_color</span><span class="p">,</span>
                <span class="n">delta_e_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_e_method</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="p">[</span><span class="n">rgb_name</span><span class="p">]</span> <span class="o">+=</span> <span class="n">color</span><span class="o">.</span><span class="n">proportion</span>

        <span class="c1"># ensure color rounding</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_keys</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">rgb2name</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">merge_color</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">delta_e_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;CIE 1976&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Take an rgb color as input and return the closest color name from the CSS3 color list.</span>

<span class="sd">        Args:</span>
<span class="sd">            c (Union[List,tuple]): RGB value.</span>
<span class="sd">            merge_color (bool, Optional): Whether color name should be reduced, defaults to True.</span>
<span class="sd">        Returns:</span>
<span class="sd">            str: Closest matching color name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input color must be a list or tuple of length 3 (RGB).&quot;</span><span class="p">)</span>

        <span class="n">h_color</span> <span class="o">=</span> <span class="s2">&quot;#</span><span class="si">{:02x}{:02x}{:02x}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">output_color</span> <span class="o">=</span> <span class="n">webcolors</span><span class="o">.</span><span class="n">hex_to_name</span><span class="p">(</span><span class="n">h_color</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="s2">&quot;css3&quot;</span><span class="p">)</span>
            <span class="n">output_color</span> <span class="o">=</span> <span class="n">output_color</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span> <span class="s2">&quot;gray&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">delta_e_lst</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">filtered_colors</span> <span class="o">=</span> <span class="n">webcolors</span><span class="o">.</span><span class="n">_definitions</span><span class="o">.</span><span class="n">_CSS3_NAMES_TO_HEX</span>

            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">img_hex</span> <span class="ow">in</span> <span class="n">filtered_colors</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">cur_clr</span> <span class="o">=</span> <span class="n">webcolors</span><span class="o">.</span><span class="n">hex_to_rgb</span><span class="p">(</span><span class="n">img_hex</span><span class="p">)</span>
                <span class="c1"># calculate color Delta-E</span>
                <span class="n">delta_e</span> <span class="o">=</span> <span class="n">colour</span><span class="o">.</span><span class="n">delta_E</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">cur_clr</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">delta_e_method</span><span class="p">)</span>
                <span class="n">delta_e_lst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">delta_e</span><span class="p">)</span>
            <span class="c1"># find lowest delta-e</span>
            <span class="n">min_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">delta_e_lst</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">output_color</span> <span class="o">=</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">filtered_colors</span><span class="o">.</span><span class="n">items</span><span class="p">())[</span><span class="n">min_diff</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span> <span class="s2">&quot;gray&quot;</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># match color to reduced list:</span>
        <span class="k">if</span> <span class="n">merge_color</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">reduced_key</span><span class="p">,</span> <span class="n">reduced_color_sub_list</span> <span class="ow">in</span> <span class="n">get_color_table</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">output_color</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">color_name</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">color_name</span> <span class="ow">in</span> <span class="n">reduced_color_sub_list</span><span class="p">[</span><span class="s2">&quot;ColorName&quot;</span><span class="p">]</span>
                <span class="p">]:</span>
                    <span class="n">output_color</span> <span class="o">=</span> <span class="n">reduced_key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="k">break</span>
        <span class="k">return</span> <span class="n">output_color</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="ammico.colors.ColorDetector.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">subdict</span><span class="p">,</span> <span class="n">delta_e_method</span><span class="o">=</span><span class="s1">&#39;CIE 1976&#39;</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Color Analysis class, analyse hue and identify named colors.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>subdict</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The dictionary containing the image path.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>delta_e_method</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The calculation method used for assigning the
closest color name, defaults to "CIE 1976".
The available options are: 'CIE 1976', 'CIE 1994', 'CIE 2000',
'CMC', 'ITP', 'CAM02-LCD', 'CAM02-SCD', 'CAM02-UCS', 'CAM16-LCD',
'CAM16-SCD', 'CAM16-UCS', 'DIN99'</p>
              </div>
            </td>
            <td>
                  <code>&#39;CIE 1976&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ammico/colors.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">subdict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">delta_e_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;CIE 1976&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Color Analysis class, analyse hue and identify named colors.</span>

<span class="sd">    Args:</span>
<span class="sd">        subdict (dict): The dictionary containing the image path.</span>
<span class="sd">        delta_e_method (str): The calculation method used for assigning the</span>
<span class="sd">            closest color name, defaults to &quot;CIE 1976&quot;.</span>
<span class="sd">            The available options are: &#39;CIE 1976&#39;, &#39;CIE 1994&#39;, &#39;CIE 2000&#39;,</span>
<span class="sd">            &#39;CMC&#39;, &#39;ITP&#39;, &#39;CAM02-LCD&#39;, &#39;CAM02-SCD&#39;, &#39;CAM02-UCS&#39;, &#39;CAM16-LCD&#39;,</span>
<span class="sd">            &#39;CAM16-SCD&#39;, &#39;CAM16-UCS&#39;, &#39;DIN99&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">subdict</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_keys</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">merge_color</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">n_colors</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="k">if</span> <span class="n">delta_e_method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">COLOR_SCHEMES</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Invalid selection for assigning the color name. Please select one of </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">COLOR_SCHEMES</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">delta_e_method</span> <span class="o">=</span> <span class="n">delta_e_method</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ammico.colors.ColorDetector.analyse_image" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">analyse_image</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Uses the colorgram library to extract the n most common colors from the images.
One problem is, that the most common colors are taken before beeing categorized,
so for small values it might occur that the ten most common colors are shades of grey,
while other colors are present but will be ignored. Because of this n_colors=100 was chosen as default.</p>
<p>The colors are then matched to the closest color in the CSS3 color list using the delta-e metric.
They are then merged into one data frame.
The colors can be reduced to a smaller list of colors using the get_color_table function.
These colors are: "red", "green", "blue", "yellow","cyan", "orange", "purple", "pink", "brown", "grey", "white", "black".</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary with color names as keys and percentage of color in image as values.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ammico/colors.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span>
<span class="normal">97</span>
<span class="normal">98</span>
<span class="normal">99</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">analyse_image</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Uses the colorgram library to extract the n most common colors from the images.</span>
<span class="sd">    One problem is, that the most common colors are taken before beeing categorized,</span>
<span class="sd">    so for small values it might occur that the ten most common colors are shades of grey,</span>
<span class="sd">    while other colors are present but will be ignored. Because of this n_colors=100 was chosen as default.</span>

<span class="sd">    The colors are then matched to the closest color in the CSS3 color list using the delta-e metric.</span>
<span class="sd">    They are then merged into one data frame.</span>
<span class="sd">    The colors can be reduced to a smaller list of colors using the get_color_table function.</span>
<span class="sd">    These colors are: &quot;red&quot;, &quot;green&quot;, &quot;blue&quot;, &quot;yellow&quot;,&quot;cyan&quot;, &quot;orange&quot;, &quot;purple&quot;, &quot;pink&quot;, &quot;brown&quot;, &quot;grey&quot;, &quot;white&quot;, &quot;black&quot;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Dictionary with color names as keys and percentage of color in image as values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span>

    <span class="n">colors</span> <span class="o">=</span> <span class="n">colorgram</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_colors</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">color</span> <span class="ow">in</span> <span class="n">colors</span><span class="p">:</span>
        <span class="n">rgb_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rgb2name</span><span class="p">(</span>
            <span class="n">color</span><span class="o">.</span><span class="n">rgb</span><span class="p">,</span>
            <span class="n">merge_color</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">merge_color</span><span class="p">,</span>
            <span class="n">delta_e_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_e_method</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="p">[</span><span class="n">rgb_name</span><span class="p">]</span> <span class="o">+=</span> <span class="n">color</span><span class="o">.</span><span class="n">proportion</span>

    <span class="c1"># ensure color rounding</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_keys</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subdict</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ammico.colors.ColorDetector.rgb2name" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">rgb2name</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">merge_color</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">delta_e_method</span><span class="o">=</span><span class="s1">&#39;CIE 1976&#39;</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Take an rgb color as input and return the closest color name from the CSS3 color list.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>c</code>
            </td>
            <td>
                  <code><span title="Union">Union</span>[<span title="List">List</span>, <span title="tuple">tuple</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>RGB value.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>merge_color</code>
            </td>
            <td>
                  <code>(<span title="bool">bool</span>, <span title="Optional">Optional</span>)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether color name should be reduced, defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Returns:
    str: Closest matching color name.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ammico/colors.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">rgb2name</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">merge_color</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">delta_e_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;CIE 1976&quot;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Take an rgb color as input and return the closest color name from the CSS3 color list.</span>

<span class="sd">    Args:</span>
<span class="sd">        c (Union[List,tuple]): RGB value.</span>
<span class="sd">        merge_color (bool, Optional): Whether color name should be reduced, defaults to True.</span>
<span class="sd">    Returns:</span>
<span class="sd">        str: Closest matching color name.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input color must be a list or tuple of length 3 (RGB).&quot;</span><span class="p">)</span>

    <span class="n">h_color</span> <span class="o">=</span> <span class="s2">&quot;#</span><span class="si">{:02x}{:02x}{:02x}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">output_color</span> <span class="o">=</span> <span class="n">webcolors</span><span class="o">.</span><span class="n">hex_to_name</span><span class="p">(</span><span class="n">h_color</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="s2">&quot;css3&quot;</span><span class="p">)</span>
        <span class="n">output_color</span> <span class="o">=</span> <span class="n">output_color</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span> <span class="s2">&quot;gray&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">delta_e_lst</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">filtered_colors</span> <span class="o">=</span> <span class="n">webcolors</span><span class="o">.</span><span class="n">_definitions</span><span class="o">.</span><span class="n">_CSS3_NAMES_TO_HEX</span>

        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">img_hex</span> <span class="ow">in</span> <span class="n">filtered_colors</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">cur_clr</span> <span class="o">=</span> <span class="n">webcolors</span><span class="o">.</span><span class="n">hex_to_rgb</span><span class="p">(</span><span class="n">img_hex</span><span class="p">)</span>
            <span class="c1"># calculate color Delta-E</span>
            <span class="n">delta_e</span> <span class="o">=</span> <span class="n">colour</span><span class="o">.</span><span class="n">delta_E</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">cur_clr</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">delta_e_method</span><span class="p">)</span>
            <span class="n">delta_e_lst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">delta_e</span><span class="p">)</span>
        <span class="c1"># find lowest delta-e</span>
        <span class="n">min_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">delta_e_lst</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">output_color</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">filtered_colors</span><span class="o">.</span><span class="n">items</span><span class="p">())[</span><span class="n">min_diff</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span> <span class="s2">&quot;gray&quot;</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="c1"># match color to reduced list:</span>
    <span class="k">if</span> <span class="n">merge_color</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">reduced_key</span><span class="p">,</span> <span class="n">reduced_color_sub_list</span> <span class="ow">in</span> <span class="n">get_color_table</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">output_color</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">color_name</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">color_name</span> <span class="ow">in</span> <span class="n">reduced_color_sub_list</span><span class="p">[</span><span class="s2">&quot;ColorName&quot;</span><span class="p">]</span>
            <span class="p">]:</span>
                <span class="n">output_color</span> <span class="o">=</span> <span class="n">reduced_key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="k">break</span>
    <span class="k">return</span> <span class="n">output_color</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div><h2 id="utils">Utils</h2>


<div class="doc doc-object doc-module">



<a id="ammico.utils"></a>
    <div class="doc doc-contents first">










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="ammico.utils.AnalysisMethod" class="doc doc-heading">
            <code>AnalysisMethod</code>


</h2>


    <div class="doc doc-contents ">



        <p>Base class to be inherited by all analysis methods.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>ammico/utils.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">AnalysisMethod</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class to be inherited by all analysis methods.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subdict</span> <span class="o">=</span> <span class="n">subdict</span>
        <span class="c1"># define keys that will be set by the analysis</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analyse_image</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="ammico.utils.DownloadResource" class="doc doc-heading">
            <code>DownloadResource</code>


</h2>


    <div class="doc doc-contents ">



        <p>A remote resource that needs on demand downloading.</p>
<p>We use this as a wrapper to the pooch library. The wrapper registers
each data file and allows prefetching through the CLI entry point
ammico_prefetch_models.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>ammico/utils.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">DownloadResource</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A remote resource that needs on demand downloading.</span>

<span class="sd">    We use this as a wrapper to the pooch library. The wrapper registers</span>
<span class="sd">    each data file and allows prefetching through the CLI entry point</span>
<span class="sd">    ammico_prefetch_models.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># We store a list of defined resouces in a class variable, allowing</span>
    <span class="c1"># us prefetching from a CLI e.g. to bundle into a Docker image</span>
    <span class="n">resources</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">DownloadResource</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">pooch</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h2 id="ammico.utils.ammico_prefetch_models" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">ammico_prefetch_models</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Prefetch all the download resources</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ammico/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">ammico_prefetch_models</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Prefetch all the download resources&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">DownloadResource</span><span class="o">.</span><span class="n">resources</span><span class="p">:</span>
        <span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="ammico.utils.append_data_to_dict" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">append_data_to_dict</span><span class="p">(</span><span class="n">mydict</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Append entries from nested dictionaries to keys in a global dict.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ammico/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">append_data_to_dict</span><span class="p">(</span><span class="n">mydict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Append entries from nested dictionaries to keys in a global dict.&quot;&quot;&quot;</span>

    <span class="c1"># first initialize empty list for each key that is present</span>
    <span class="n">outdict</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">mydict</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
    <span class="c1"># now append the values to each key in a list</span>
    <span class="k">for</span> <span class="n">subdict</span> <span class="ow">in</span> <span class="n">mydict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">subdict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">outdict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subdict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">outdict</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="ammico.utils.dump_df" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">dump_df</span><span class="p">(</span><span class="n">mydict</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Utility to dump the dictionary into a dataframe.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ammico/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">dump_df</span><span class="p">(</span><span class="n">mydict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Utility to dump the dictionary into a dataframe.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">mydict</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="ammico.utils.find_files" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">find_files</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_as_list</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Find image files on the file system.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The base directory where we are looking for the images. Defaults
to None, which uses the ammico data directory if set or the current
working directory otherwise.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>pattern</code>
            </td>
            <td>
                  <code><span title="str">str</span> | <span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The naming pattern that the filename should match.
    Use either '.ext' or just 'ext'
    Defaults to ["png", "jpg", "jpeg", "gif", "webp", "avif","tiff"]. Can be used to allow other patterns or to only include
    specific prefixes or suffixes.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>recursive</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to recurse into subdirectories. Default is set to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>limit</code>
            </td>
            <td>
                  <code><span title="int">int</span> / <span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The maximum number of images to be found.
Provide a list or tuple of length 2 to batch the images.
Defaults to 20. To return all images, set to None or -1.</p>
              </div>
            </td>
            <td>
                  <code>20</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>random_seed</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The random seed to use for shuffling the images.
If None is provided the data will not be shuffeled. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>return_as_list</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to return the list of files instead of a dict.
Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Returns:
    dict: A nested dictionary with file ids and all filenames including the path.
    Or
    list: A list of file paths if return_as_list is set to True.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ammico/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">find_files</span><span class="p">(</span>
    <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">,</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">pattern</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">recursive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">limit</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">random_seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">return_as_list</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">list</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Find image files on the file system.</span>

<span class="sd">    Args:</span>
<span class="sd">        path (str, optional): The base directory where we are looking for the images. Defaults</span>
<span class="sd">            to None, which uses the ammico data directory if set or the current</span>
<span class="sd">            working directory otherwise.</span>
<span class="sd">        pattern (str|list, optional): The naming pattern that the filename should match.</span>
<span class="sd">                Use either &#39;.ext&#39; or just &#39;ext&#39;</span>
<span class="sd">                Defaults to [&quot;png&quot;, &quot;jpg&quot;, &quot;jpeg&quot;, &quot;gif&quot;, &quot;webp&quot;, &quot;avif&quot;,&quot;tiff&quot;]. Can be used to allow other patterns or to only include</span>
<span class="sd">                specific prefixes or suffixes.</span>
<span class="sd">        recursive (bool, optional): Whether to recurse into subdirectories. Default is set to True.</span>
<span class="sd">        limit (int/list, optional): The maximum number of images to be found.</span>
<span class="sd">            Provide a list or tuple of length 2 to batch the images.</span>
<span class="sd">            Defaults to 20. To return all images, set to None or -1.</span>
<span class="sd">        random_seed (int, optional): The random seed to use for shuffling the images.</span>
<span class="sd">            If None is provided the data will not be shuffeled. Defaults to None.</span>
<span class="sd">        return_as_list (bool, optional): Whether to return the list of files instead of a dict.</span>
<span class="sd">            Defaults to False.</span>
<span class="sd">    Returns:</span>
<span class="sd">        dict: A nested dictionary with file ids and all filenames including the path.</span>
<span class="sd">        Or</span>
<span class="sd">        list: A list of file paths if return_as_list is set to True.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;AMMICO_DATA_HOME&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pattern</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;png&quot;</span><span class="p">,</span> <span class="s2">&quot;jpg&quot;</span><span class="p">,</span> <span class="s2">&quot;jpeg&quot;</span><span class="p">,</span> <span class="s2">&quot;gif&quot;</span><span class="p">,</span> <span class="s2">&quot;webp&quot;</span><span class="p">,</span> <span class="s2">&quot;avif&quot;</span><span class="p">,</span> <span class="s2">&quot;tiff&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="p">[</span><span class="n">pattern</span><span class="p">]</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pattern</span><span class="p">:</span>
        <span class="n">results</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_match_pattern</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="n">recursive</span><span class="p">))</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No files found in </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2"> with pattern &#39;</span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">random_seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">random_seed</span><span class="p">)</span>
        <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

    <span class="n">images</span> <span class="o">=</span> <span class="n">_limit_results</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_as_list</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">images</span>

    <span class="k">return</span> <span class="n">initialize_dict</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="ammico.utils.find_videos" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">find_videos</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mp4&#39;</span><span class="p">,</span> <span class="s1">&#39;mov&#39;</span><span class="p">,</span> <span class="s1">&#39;avi&#39;</span><span class="p">,</span> <span class="s1">&#39;mkv&#39;</span><span class="p">,</span> <span class="s1">&#39;webm&#39;</span><span class="p">],</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Find video files on the file system.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ammico/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">find_videos</span><span class="p">(</span>
    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">pattern</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mp4&quot;</span><span class="p">,</span> <span class="s2">&quot;mov&quot;</span><span class="p">,</span> <span class="s2">&quot;avi&quot;</span><span class="p">,</span> <span class="s2">&quot;mkv&quot;</span><span class="p">,</span> <span class="s2">&quot;webm&quot;</span><span class="p">],</span>
    <span class="n">recursive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">limit</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">random_seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Find video files on the file system.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;AMMICO_DATA_HOME&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="p">[</span><span class="n">pattern</span><span class="p">]</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pattern</span><span class="p">:</span>
        <span class="n">results</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_match_pattern</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="n">recursive</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No files found in </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2"> with pattern &#39;</span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">random_seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">random_seed</span><span class="p">)</span>
        <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
    <span class="n">videos</span> <span class="o">=</span> <span class="n">_limit_results</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">initialize_dict</span><span class="p">(</span><span class="n">videos</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="ammico.utils.get_supported_whisperx_languages" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_supported_whisperx_languages</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Get the list of supported whisperx languages.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ammico/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_supported_whisperx_languages</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the list of supported whisperx languages.&quot;&quot;&quot;</span>
    <span class="n">supported_languages</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">DEFAULT_ALIGN_MODELS_TORCH</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span>
        <span class="n">DEFAULT_ALIGN_MODELS_HF</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">supported_languages</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="ammico.utils.initialize_dict" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">initialize_dict</span><span class="p">(</span><span class="n">filelist</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Initialize the nested dictionary for all the found images.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>filelist</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The list of files to be analyzed, including their paths.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Returns:
    dict: The nested dictionary with all image ids and their paths.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ammico/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">initialize_dict</span><span class="p">(</span><span class="n">filelist</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the nested dictionary for all the found images.</span>

<span class="sd">    Args:</span>
<span class="sd">        filelist (list): The list of files to be analyzed, including their paths.</span>
<span class="sd">    Returns:</span>
<span class="sd">        dict: The nested dictionary with all image ids and their paths.&quot;&quot;&quot;</span>
    <span class="n">mydict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">img_path</span> <span class="ow">in</span> <span class="n">filelist</span><span class="p">:</span>
        <span class="n">id_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">img_path</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">mydict</span><span class="p">[</span><span class="n">id_</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="n">img_path</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">mydict</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="ammico.utils.is_interactive" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">is_interactive</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Check if we are running in an interactive environment.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ammico/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">is_interactive</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if we are running in an interactive environment.&quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">__main__</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">main</span>

    <span class="k">return</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">main</span><span class="p">,</span> <span class="s2">&quot;__file__&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="ammico.utils.load_image" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">load_image</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Load image from file path or return if already PIL Image.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ammico/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">load_image</span><span class="p">(</span><span class="n">image_path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">,</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load image from file path or return if already PIL Image.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image_path</span><span class="p">,</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">image_path</span>

    <span class="n">image_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">image_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image file not found: </span><span class="si">{</span><span class="n">image_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">&quot;RGB&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="ammico.utils.prepare_image" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">prepare_image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">target_size</span><span class="o">=</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">),</span> <span class="n">resize_mode</span><span class="o">=</span><span class="s1">&#39;resize&#39;</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Prepare image for model input with optimal resolution.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ammico/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">prepare_image</span><span class="p">(</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span>
    <span class="n">target_size</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">),</span>
    <span class="n">resize_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;resize&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Prepare image for model input with optimal resolution.&quot;&quot;&quot;</span>
    <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">size</span>
    <span class="n">target_w</span><span class="p">,</span> <span class="n">target_h</span> <span class="o">=</span> <span class="n">target_size</span>

    <span class="k">if</span> <span class="n">resize_mode</span> <span class="o">==</span> <span class="s2">&quot;center_crop&quot;</span><span class="p">:</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">target_w</span> <span class="o">/</span> <span class="n">width</span><span class="p">,</span> <span class="n">target_h</span> <span class="o">/</span> <span class="n">height</span><span class="p">)</span>
        <span class="n">new_width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)</span>
        <span class="n">new_height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">height</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="n">new_width</span><span class="p">,</span> <span class="n">new_height</span><span class="p">),</span> <span class="n">Image</span><span class="o">.</span><span class="n">Resampling</span><span class="o">.</span><span class="n">LANCZOS</span><span class="p">)</span>

        <span class="n">left</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_width</span> <span class="o">-</span> <span class="n">target_w</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">top</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_height</span> <span class="o">-</span> <span class="n">target_h</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">crop</span><span class="p">((</span><span class="n">left</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">left</span> <span class="o">+</span> <span class="n">target_w</span><span class="p">,</span> <span class="n">top</span> <span class="o">+</span> <span class="n">target_h</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">target_size</span><span class="p">,</span> <span class="n">Image</span><span class="o">.</span><span class="n">Resampling</span><span class="o">.</span><span class="n">LANCZOS</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">image</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><h2 id="display">Display</h2>


<div class="doc doc-object doc-module">



<a id="ammico.display"></a>
    <div class="doc doc-contents first">










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="ammico.display.AnalysisExplorer" class="doc doc-heading">
            <code>AnalysisExplorer</code>


</h2>


    <div class="doc doc-contents ">










              <details class="mkdocstrings-source">
                <summary>Source code in <code>ammico/display.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">AnalysisExplorer</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mydict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the AnalysisExplorer class to create an interactive</span>
<span class="sd">        visualization of the analysis results.</span>

<span class="sd">        Args:</span>
<span class="sd">            mydict (dict): A nested dictionary containing image data for all images.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">Dash</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">external_stylesheets</span><span class="o">=</span><span class="p">[</span><span class="n">dbc</span><span class="o">.</span><span class="n">themes</span><span class="o">.</span><span class="n">BOOTSTRAP</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mydict</span> <span class="o">=</span> <span class="n">mydict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theme</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;scheme&quot;</span><span class="p">:</span> <span class="s2">&quot;monokai&quot;</span><span class="p">,</span>
            <span class="s2">&quot;author&quot;</span><span class="p">:</span> <span class="s2">&quot;wimer hazenberg (http://www.monokai.nl)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;base00&quot;</span><span class="p">:</span> <span class="s2">&quot;#272822&quot;</span><span class="p">,</span>
            <span class="s2">&quot;base01&quot;</span><span class="p">:</span> <span class="s2">&quot;#383830&quot;</span><span class="p">,</span>
            <span class="s2">&quot;base02&quot;</span><span class="p">:</span> <span class="s2">&quot;#49483e&quot;</span><span class="p">,</span>
            <span class="s2">&quot;base03&quot;</span><span class="p">:</span> <span class="s2">&quot;#75715e&quot;</span><span class="p">,</span>
            <span class="s2">&quot;base04&quot;</span><span class="p">:</span> <span class="s2">&quot;#a59f85&quot;</span><span class="p">,</span>
            <span class="s2">&quot;base05&quot;</span><span class="p">:</span> <span class="s2">&quot;#f8f8f2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;base06&quot;</span><span class="p">:</span> <span class="s2">&quot;#f5f4f1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;base07&quot;</span><span class="p">:</span> <span class="s2">&quot;#f9f8f5&quot;</span><span class="p">,</span>
            <span class="s2">&quot;base08&quot;</span><span class="p">:</span> <span class="s2">&quot;#f92672&quot;</span><span class="p">,</span>
            <span class="s2">&quot;base09&quot;</span><span class="p">:</span> <span class="s2">&quot;#fd971f&quot;</span><span class="p">,</span>
            <span class="s2">&quot;base0A&quot;</span><span class="p">:</span> <span class="s2">&quot;#f4bf75&quot;</span><span class="p">,</span>
            <span class="s2">&quot;base0B&quot;</span><span class="p">:</span> <span class="s2">&quot;#a6e22e&quot;</span><span class="p">,</span>
            <span class="s2">&quot;base0C&quot;</span><span class="p">:</span> <span class="s2">&quot;#a1efe4&quot;</span><span class="p">,</span>
            <span class="s2">&quot;base0D&quot;</span><span class="p">:</span> <span class="s2">&quot;#66d9ef&quot;</span><span class="p">,</span>
            <span class="s2">&quot;base0E&quot;</span><span class="p">:</span> <span class="s2">&quot;#ae81ff&quot;</span><span class="p">,</span>
            <span class="s2">&quot;base0F&quot;</span><span class="p">:</span> <span class="s2">&quot;#cc6633&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># Setup the layout</span>
        <span class="n">app_layout</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="c1"># Top row, only file explorer</span>
                <span class="n">dbc</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">dbc</span><span class="o">.</span><span class="n">Col</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_top_file_explorer</span><span class="p">(</span><span class="n">mydict</span><span class="p">))],</span>
                    <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;Div_top&quot;</span><span class="p">,</span>
                    <span class="n">style</span><span class="o">=</span><span class="p">{</span>
                        <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="s2">&quot;30%&quot;</span><span class="p">,</span>
                    <span class="p">},</span>
                <span class="p">),</span>
                <span class="c1"># second row, middle picture and right output</span>
                <span class="n">dbc</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="c1"># first column: picture</span>
                        <span class="n">dbc</span><span class="o">.</span><span class="n">Col</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_middle_picture_frame</span><span class="p">()),</span>
                        <span class="n">dbc</span><span class="o">.</span><span class="n">Col</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_right_output_json</span><span class="p">()),</span>
                    <span class="p">]</span>
                <span class="p">),</span>
            <span class="p">],</span>
            <span class="c1"># style={&quot;width&quot;: &quot;95%&quot;, &quot;display&quot;: &quot;inline-block&quot;},</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">layout</span> <span class="o">=</span> <span class="n">app_layout</span>

        <span class="c1"># Add callbacks to the app</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span>
            <span class="n">Output</span><span class="p">(</span><span class="s2">&quot;img_middle_picture_id&quot;</span><span class="p">,</span> <span class="s2">&quot;src&quot;</span><span class="p">),</span>
            <span class="n">Input</span><span class="p">(</span><span class="s2">&quot;left_select_id&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">),</span>
            <span class="n">prevent_initial_call</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_picture</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span>
            <span class="n">Output</span><span class="p">(</span><span class="s2">&quot;right_json_viewer&quot;</span><span class="p">,</span> <span class="s2">&quot;children&quot;</span><span class="p">),</span>
            <span class="n">Input</span><span class="p">(</span><span class="s2">&quot;button_run&quot;</span><span class="p">,</span> <span class="s2">&quot;n_clicks&quot;</span><span class="p">),</span>
            <span class="n">State</span><span class="p">(</span><span class="s2">&quot;left_select_id&quot;</span><span class="p">,</span> <span class="s2">&quot;options&quot;</span><span class="p">),</span>
            <span class="n">State</span><span class="p">(</span><span class="s2">&quot;left_select_id&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">),</span>
            <span class="n">State</span><span class="p">(</span><span class="s2">&quot;Dropdown_select_Detector&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">),</span>
            <span class="n">State</span><span class="p">(</span><span class="s2">&quot;Dropdown_analysis_type&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">),</span>
            <span class="n">State</span><span class="p">(</span><span class="s2">&quot;textarea_questions&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">),</span>
            <span class="n">State</span><span class="p">(</span><span class="s2">&quot;setting_privacy_env_var&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">),</span>
            <span class="n">State</span><span class="p">(</span><span class="s2">&quot;setting_Color_delta_e_method&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">),</span>
            <span class="n">prevent_initial_call</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">_right_output_analysis</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span>
            <span class="n">Output</span><span class="p">(</span><span class="s2">&quot;settings_TextDetector&quot;</span><span class="p">,</span> <span class="s2">&quot;style&quot;</span><span class="p">),</span>
            <span class="n">Output</span><span class="p">(</span><span class="s2">&quot;settings_ColorDetector&quot;</span><span class="p">,</span> <span class="s2">&quot;style&quot;</span><span class="p">),</span>
            <span class="n">Output</span><span class="p">(</span><span class="s2">&quot;settings_VQA&quot;</span><span class="p">,</span> <span class="s2">&quot;style&quot;</span><span class="p">),</span>
            <span class="n">Input</span><span class="p">(</span><span class="s2">&quot;Dropdown_select_Detector&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">),</span>
        <span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">_update_detector_setting</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span>
            <span class="n">Output</span><span class="p">(</span><span class="s2">&quot;textarea_questions&quot;</span><span class="p">,</span> <span class="s2">&quot;style&quot;</span><span class="p">),</span>
            <span class="n">Input</span><span class="p">(</span><span class="s2">&quot;Dropdown_analysis_type&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">),</span>
        <span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">_show_questions_textarea_on_demand</span><span class="p">)</span>

    <span class="c1"># I split the different sections into subfunctions for better clarity</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_top_file_explorer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mydict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the file explorer dropdown for selecting the file to be analyzed.</span>

<span class="sd">        Args:</span>
<span class="sd">            mydict (dict): A dictionary containing image data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            html.Div: The layout for the file explorer dropdown.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">left_layout</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">dcc</span><span class="o">.</span><span class="n">Dropdown</span><span class="p">(</span>
                    <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="n">value</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]:</span> <span class="n">key</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">mydict</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span>
                    <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;left_select_id&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">left_layout</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_middle_picture_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the picture frame to display the image.</span>

<span class="sd">        Returns:</span>
<span class="sd">            html.Div: The layout for the picture frame.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">middle_layout</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">html</span><span class="o">.</span><span class="n">Img</span><span class="p">(</span>
                    <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;img_middle_picture_id&quot;</span><span class="p">,</span>
                    <span class="n">style</span><span class="o">=</span><span class="p">{</span>
                        <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="s2">&quot;80%&quot;</span><span class="p">,</span>
                    <span class="p">},</span>
                <span class="p">)</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">middle_layout</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_setting_layout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">settings_layout</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="c1"># text summary start</span>
                <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">(</span>
                    <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;settings_TextDetector&quot;</span><span class="p">,</span>
                    <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;display&quot;</span><span class="p">:</span> <span class="s2">&quot;none&quot;</span><span class="p">},</span>
                    <span class="n">children</span><span class="o">=</span><span class="p">[</span>
                        <span class="c1"># row 1</span>
                        <span class="n">dbc</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span>
                            <span class="n">dbc</span><span class="o">.</span><span class="n">Col</span><span class="p">(</span>
                                <span class="p">[</span>
                                    <span class="n">html</span><span class="o">.</span><span class="n">P</span><span class="p">(</span>
                                        <span class="s2">&quot;Privacy disclosure acceptance environment variable&quot;</span>
                                    <span class="p">),</span>
                                    <span class="n">dcc</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span>
                                        <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">,</span>
                                        <span class="n">value</span><span class="o">=</span><span class="s2">&quot;PRIVACY_AMMICO&quot;</span><span class="p">,</span>
                                        <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;setting_privacy_env_var&quot;</span><span class="p">,</span>
                                        <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="s2">&quot;100%&quot;</span><span class="p">},</span>
                                    <span class="p">),</span>
                                <span class="p">],</span>
                                <span class="n">align</span><span class="o">=</span><span class="s2">&quot;start&quot;</span><span class="p">,</span>
                            <span class="p">),</span>
                        <span class="p">),</span>
                    <span class="p">],</span>
                <span class="p">),</span>  <span class="c1"># text summary end</span>
                <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">(</span>
                    <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;settings_ColorDetector&quot;</span><span class="p">,</span>
                    <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;display&quot;</span><span class="p">:</span> <span class="s2">&quot;none&quot;</span><span class="p">},</span>
                    <span class="n">children</span><span class="o">=</span><span class="p">[</span>
                        <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">(</span>
                            <span class="p">[</span>
                                <span class="n">dcc</span><span class="o">.</span><span class="n">Dropdown</span><span class="p">(</span>
                                    <span class="n">options</span><span class="o">=</span><span class="n">COLOR_SCHEMES</span><span class="p">,</span>
                                    <span class="n">value</span><span class="o">=</span><span class="s2">&quot;CIE 1976&quot;</span><span class="p">,</span>
                                    <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;setting_Color_delta_e_method&quot;</span><span class="p">,</span>
                                <span class="p">)</span>
                            <span class="p">],</span>
                            <span class="n">style</span><span class="o">=</span><span class="p">{</span>
                                <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="s2">&quot;49%&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;display&quot;</span><span class="p">:</span> <span class="s2">&quot;inline-block&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;margin-top&quot;</span><span class="p">:</span> <span class="s2">&quot;10px&quot;</span><span class="p">,</span>
                            <span class="p">},</span>
                        <span class="p">)</span>
                    <span class="p">],</span>
                <span class="p">),</span>
                <span class="c1"># start VQA settings</span>
                <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">(</span>
                    <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;settings_VQA&quot;</span><span class="p">,</span>
                    <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;display&quot;</span><span class="p">:</span> <span class="s2">&quot;none&quot;</span><span class="p">},</span>
                    <span class="n">children</span><span class="o">=</span><span class="p">[</span>
                        <span class="n">dbc</span><span class="o">.</span><span class="n">Card</span><span class="p">(</span>
                            <span class="p">[</span>
                                <span class="n">dbc</span><span class="o">.</span><span class="n">CardBody</span><span class="p">(</span>
                                    <span class="p">[</span>
                                        <span class="n">dbc</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span>
                                            <span class="n">dbc</span><span class="o">.</span><span class="n">Col</span><span class="p">(</span>
                                                <span class="n">dcc</span><span class="o">.</span><span class="n">Dropdown</span><span class="p">(</span>
                                                    <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;Dropdown_analysis_type&quot;</span><span class="p">,</span>
                                                    <span class="n">options</span><span class="o">=</span><span class="p">[</span>
                                                        <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">v</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">v</span><span class="p">}</span>
                                                        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">SUMMARY_ANALYSIS_TYPE</span>
                                                    <span class="p">],</span>
                                                    <span class="n">value</span><span class="o">=</span><span class="s2">&quot;summary_and_questions&quot;</span><span class="p">,</span>
                                                    <span class="n">clearable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                    <span class="n">style</span><span class="o">=</span><span class="p">{</span>
                                                        <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="s2">&quot;100%&quot;</span><span class="p">,</span>
                                                        <span class="s2">&quot;minWidth&quot;</span><span class="p">:</span> <span class="s2">&quot;240px&quot;</span><span class="p">,</span>
                                                        <span class="s2">&quot;maxWidth&quot;</span><span class="p">:</span> <span class="s2">&quot;520px&quot;</span><span class="p">,</span>
                                                    <span class="p">},</span>
                                                <span class="p">),</span>
                                            <span class="p">),</span>
                                            <span class="n">justify</span><span class="o">=</span><span class="s2">&quot;start&quot;</span><span class="p">,</span>
                                        <span class="p">),</span>
                                        <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="s2">&quot;8px&quot;</span><span class="p">}),</span>
                                        <span class="n">dbc</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span>
                                            <span class="p">[</span>
                                                <span class="n">dbc</span><span class="o">.</span><span class="n">Col</span><span class="p">(</span>
                                                    <span class="n">dcc</span><span class="o">.</span><span class="n">Textarea</span><span class="p">(</span>
                                                        <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;textarea_questions&quot;</span><span class="p">,</span>
                                                        <span class="n">value</span><span class="o">=</span><span class="s2">&quot;Are there people in the image?</span><span class="se">\n</span><span class="s2">What is this picture about?&quot;</span><span class="p">,</span>
                                                        <span class="n">placeholder</span><span class="o">=</span><span class="s2">&quot;One question per line...&quot;</span><span class="p">,</span>
                                                        <span class="n">style</span><span class="o">=</span><span class="p">{</span>
                                                            <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="s2">&quot;100%&quot;</span><span class="p">,</span>
                                                            <span class="s2">&quot;minHeight&quot;</span><span class="p">:</span> <span class="s2">&quot;160px&quot;</span><span class="p">,</span>
                                                            <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="s2">&quot;220px&quot;</span><span class="p">,</span>
                                                            <span class="s2">&quot;resize&quot;</span><span class="p">:</span> <span class="s2">&quot;vertical&quot;</span><span class="p">,</span>
                                                            <span class="s2">&quot;overflow&quot;</span><span class="p">:</span> <span class="s2">&quot;auto&quot;</span><span class="p">,</span>
                                                        <span class="p">},</span>
                                                        <span class="n">rows</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                                                    <span class="p">),</span>
                                                    <span class="n">width</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                                                <span class="p">),</span>
                                            <span class="p">],</span>
                                            <span class="n">justify</span><span class="o">=</span><span class="s2">&quot;start&quot;</span><span class="p">,</span>
                                        <span class="p">),</span>
                                    <span class="p">]</span>
                                <span class="p">)</span>
                            <span class="p">],</span>
                            <span class="n">style</span><span class="o">=</span><span class="p">{</span>
                                <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="s2">&quot;100%&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;marginTop&quot;</span><span class="p">:</span> <span class="s2">&quot;10px&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;zIndex&quot;</span><span class="p">:</span> <span class="mi">2000</span><span class="p">,</span>
                            <span class="p">},</span>
                        <span class="p">)</span>
                    <span class="p">],</span>
                <span class="p">),</span>
            <span class="p">],</span>
            <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="s2">&quot;100%&quot;</span><span class="p">,</span> <span class="s2">&quot;display&quot;</span><span class="p">:</span> <span class="s2">&quot;inline-block&quot;</span><span class="p">,</span> <span class="s2">&quot;overflow&quot;</span><span class="p">:</span> <span class="s2">&quot;visible&quot;</span><span class="p">},</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">settings_layout</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_right_output_json</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the DetectorDropdown, argument Div and JSON viewer for displaying the analysis output.</span>

<span class="sd">        Returns:</span>
<span class="sd">            html.Div: The layout for the JSON viewer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">right_layout</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">dbc</span><span class="o">.</span><span class="n">Col</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="n">dbc</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span>
                            <span class="n">dcc</span><span class="o">.</span><span class="n">Dropdown</span><span class="p">(</span>
                                <span class="n">options</span><span class="o">=</span><span class="p">[</span>
                                    <span class="s2">&quot;TextDetector&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;ColorDetector&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;VQA&quot;</span><span class="p">,</span>
                                <span class="p">],</span>
                                <span class="n">value</span><span class="o">=</span><span class="s2">&quot;TextDetector&quot;</span><span class="p">,</span>
                                <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;Dropdown_select_Detector&quot;</span><span class="p">,</span>
                                <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="s2">&quot;60%&quot;</span><span class="p">},</span>
                            <span class="p">),</span>
                            <span class="n">justify</span><span class="o">=</span><span class="s2">&quot;start&quot;</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="n">dbc</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span>
                            <span class="n">children</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_setting_layout</span><span class="p">()],</span>
                            <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;div_detector_args&quot;</span><span class="p">,</span>
                            <span class="n">justify</span><span class="o">=</span><span class="s2">&quot;start&quot;</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="n">dbc</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span>
                            <span class="n">html</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span>
                                <span class="s2">&quot;Run Detector&quot;</span><span class="p">,</span>
                                <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;button_run&quot;</span><span class="p">,</span>
                                <span class="n">style</span><span class="o">=</span><span class="p">{</span>
                                    <span class="s2">&quot;margin-top&quot;</span><span class="p">:</span> <span class="s2">&quot;15px&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;margin-bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;15px&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;margin-left&quot;</span><span class="p">:</span> <span class="s2">&quot;11px&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="s2">&quot;30%&quot;</span><span class="p">,</span>
                                <span class="p">},</span>
                            <span class="p">),</span>
                            <span class="n">justify</span><span class="o">=</span><span class="s2">&quot;start&quot;</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="n">dbc</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span>
                            <span class="n">dcc</span><span class="o">.</span><span class="n">Loading</span><span class="p">(</span>
                                <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;loading-2&quot;</span><span class="p">,</span>
                                <span class="n">children</span><span class="o">=</span><span class="p">[</span>
                                    <span class="c1"># This is where the json is shown.</span>
                                    <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;right_json_viewer&quot;</span><span class="p">),</span>
                                <span class="p">],</span>
                                <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;circle&quot;</span><span class="p">,</span>
                            <span class="p">),</span>
                            <span class="n">justify</span><span class="o">=</span><span class="s2">&quot;start&quot;</span><span class="p">,</span>
                        <span class="p">),</span>
                    <span class="p">],</span>
                    <span class="n">align</span><span class="o">=</span><span class="s2">&quot;start&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">right_layout</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run_server</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8050</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the Dash server to start the analysis explorer.</span>


<span class="sd">        Args:</span>
<span class="sd">            port (int, optional): The port number to run the server on (default: 8050).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">)</span>

    <span class="c1"># Dash callbacks</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_picture</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Callback function to update the displayed image.</span>

<span class="sd">        Args:</span>
<span class="sd">            img_path (str): The path of the selected image.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Union[PIL.PngImagePlugin, None]: The image object to be displayed</span>
<span class="sd">                or None if the image path is</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">img_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">image</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_update_detector_setting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">setting_input</span><span class="p">):</span>
        <span class="c1"># return settings_TextDetector -&gt; style,</span>
        <span class="n">display_none</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;display&quot;</span><span class="p">:</span> <span class="s2">&quot;none&quot;</span><span class="p">}</span>
        <span class="n">display_flex</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;display&quot;</span><span class="p">:</span> <span class="s2">&quot;flex&quot;</span><span class="p">,</span>
            <span class="s2">&quot;flexWrap&quot;</span><span class="p">:</span> <span class="s2">&quot;wrap&quot;</span><span class="p">,</span>
            <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span>
            <span class="s2">&quot;margin-top&quot;</span><span class="p">:</span> <span class="s2">&quot;20px&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">setting_input</span> <span class="o">==</span> <span class="s2">&quot;TextDetector&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">display_flex</span><span class="p">,</span> <span class="n">display_none</span><span class="p">,</span> <span class="n">display_none</span><span class="p">,</span> <span class="n">display_none</span>
        <span class="k">if</span> <span class="n">setting_input</span> <span class="o">==</span> <span class="s2">&quot;ColorDetector&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">display_none</span><span class="p">,</span> <span class="n">display_none</span><span class="p">,</span> <span class="n">display_flex</span><span class="p">,</span> <span class="n">display_none</span>
        <span class="k">if</span> <span class="n">setting_input</span> <span class="o">==</span> <span class="s2">&quot;VQA&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">display_none</span><span class="p">,</span> <span class="n">display_none</span><span class="p">,</span> <span class="n">display_none</span><span class="p">,</span> <span class="n">display_flex</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">display_none</span><span class="p">,</span> <span class="n">display_none</span><span class="p">,</span> <span class="n">display_none</span><span class="p">,</span> <span class="n">display_none</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_questions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="p">[</span><span class="n">q</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span> <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
        <span class="k">return</span> <span class="n">qs</span> <span class="k">if</span> <span class="n">qs</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_right_output_analysis</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">n_clicks</span><span class="p">,</span>
        <span class="n">all_img_options</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">current_img_value</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">detector_value</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">analysis_type_value</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">textarea_questions_value</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">setting_privacy_env_var</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">setting_color_delta_e_method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Callback function to perform analysis on the selected image and return the output.</span>

<span class="sd">        Args:</span>
<span class="sd">            all_options (dict): The available options in the file explorer dropdown.</span>
<span class="sd">            current_value (str): The current selected value in the file explorer dropdown.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: The analysis output for the selected image.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">identify_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;TextDetector&quot;</span><span class="p">:</span> <span class="n">text</span><span class="o">.</span><span class="n">TextDetector</span><span class="p">,</span>
            <span class="s2">&quot;ColorDetector&quot;</span><span class="p">:</span> <span class="n">colors</span><span class="o">.</span><span class="n">ColorDetector</span><span class="p">,</span>
            <span class="s2">&quot;VQA&quot;</span><span class="p">:</span> <span class="n">image_summary</span><span class="o">.</span><span class="n">ImageSummaryDetector</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># Get image ID from dropdown value, which is the filepath</span>
        <span class="k">if</span> <span class="n">current_img_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="n">image_id</span> <span class="o">=</span> <span class="n">all_img_options</span><span class="p">[</span><span class="n">current_img_value</span><span class="p">]</span>
        <span class="n">image_copy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mydict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">image_id</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">analysis_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">detector_value</span> <span class="o">==</span> <span class="s2">&quot;VQA&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">qwen_model</span> <span class="o">=</span> <span class="n">MultimodalSummaryModel</span><span class="p">(</span>
                    <span class="n">model_id</span><span class="o">=</span><span class="s2">&quot;Qwen/Qwen2.5-VL-3B-Instruct&quot;</span>
                <span class="p">)</span>  <span class="c1"># TODO: allow user to specify model</span>
                <span class="n">vqa_cls</span> <span class="o">=</span> <span class="n">identify_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;VQA&quot;</span><span class="p">)</span>
                <span class="n">vqa_detector</span> <span class="o">=</span> <span class="n">vqa_cls</span><span class="p">(</span><span class="n">qwen_model</span><span class="p">,</span> <span class="n">subdict</span><span class="o">=</span><span class="p">{})</span>
                <span class="n">questions_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_questions</span><span class="p">(</span><span class="n">textarea_questions_value</span><span class="p">)</span>
                <span class="n">analysis_result</span> <span class="o">=</span> <span class="n">vqa_detector</span><span class="o">.</span><span class="n">analyse_image</span><span class="p">(</span>
                    <span class="n">image_copy</span><span class="p">,</span>
                    <span class="n">analysis_type</span><span class="o">=</span><span class="n">analysis_type_value</span><span class="p">,</span>
                    <span class="n">list_of_questions</span><span class="o">=</span><span class="n">questions_list</span><span class="p">,</span>
                    <span class="n">is_concise_summary</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">is_concise_answer</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">analysis_dict</span> <span class="o">=</span> <span class="n">analysis_result</span> <span class="ow">or</span> <span class="p">{}</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;VQA/Image tasks failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">analysis_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;image_tasks_error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># detector value is the string name of the chosen detector</span>
            <span class="n">identify_function</span> <span class="o">=</span> <span class="n">identify_dict</span><span class="p">[</span><span class="n">detector_value</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">detector_value</span> <span class="o">==</span> <span class="s2">&quot;TextDetector&quot;</span><span class="p">:</span>
                <span class="n">detector_class</span> <span class="o">=</span> <span class="n">identify_function</span><span class="p">(</span>
                    <span class="n">image_copy</span><span class="p">,</span>
                    <span class="n">accept_privacy</span><span class="o">=</span><span class="p">(</span>
                        <span class="n">setting_privacy_env_var</span>
                        <span class="k">if</span> <span class="n">setting_privacy_env_var</span>
                        <span class="k">else</span> <span class="s2">&quot;PRIVACY_AMMICO&quot;</span>
                    <span class="p">),</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">detector_value</span> <span class="o">==</span> <span class="s2">&quot;ColorDetector&quot;</span><span class="p">:</span>
                <span class="n">detector_class</span> <span class="o">=</span> <span class="n">identify_function</span><span class="p">(</span>
                    <span class="n">image_copy</span><span class="p">,</span>
                    <span class="n">delta_e_method</span><span class="o">=</span><span class="n">setting_color_delta_e_method</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">detector_class</span> <span class="o">=</span> <span class="n">identify_function</span><span class="p">(</span><span class="n">image_copy</span><span class="p">)</span>

            <span class="n">analysis_dict</span> <span class="o">=</span> <span class="n">detector_class</span><span class="o">.</span><span class="n">analyse_image</span><span class="p">()</span>

        <span class="n">new_analysis_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Iterate over the items in the original dictionary</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">analysis_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Check if the value is a list</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="c1"># If it is, convert each item in the list to a string and join them with a comma</span>
                <span class="n">new_value</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">v</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># If it&#39;s not a list, keep the value as it is</span>
                <span class="n">new_value</span> <span class="o">=</span> <span class="n">v</span>

            <span class="c1"># Add the new key-value pair to the new dictionary</span>
            <span class="n">new_analysis_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_value</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">new_analysis_dict</span><span class="p">])</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;filename&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;filename&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dbc</span><span class="o">.</span><span class="n">Table</span><span class="o">.</span><span class="n">from_dataframe</span><span class="p">(</span>
            <span class="n">df</span><span class="p">,</span> <span class="n">striped</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bordered</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">hover</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_show_questions_textarea_on_demand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analysis_type_value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">analysis_type_value</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;questions&quot;</span><span class="p">,</span> <span class="s2">&quot;summary_and_questions&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;display&quot;</span><span class="p">:</span> <span class="s2">&quot;block&quot;</span><span class="p">,</span> <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="s2">&quot;100%&quot;</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;display&quot;</span><span class="p">:</span> <span class="s2">&quot;none&quot;</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="ammico.display.AnalysisExplorer.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">mydict</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Initialize the AnalysisExplorer class to create an interactive
visualization of the analysis results.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>mydict</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A nested dictionary containing image data for all images.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ammico/display.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mydict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the AnalysisExplorer class to create an interactive</span>
<span class="sd">    visualization of the analysis results.</span>

<span class="sd">    Args:</span>
<span class="sd">        mydict (dict): A nested dictionary containing image data for all images.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">Dash</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">external_stylesheets</span><span class="o">=</span><span class="p">[</span><span class="n">dbc</span><span class="o">.</span><span class="n">themes</span><span class="o">.</span><span class="n">BOOTSTRAP</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mydict</span> <span class="o">=</span> <span class="n">mydict</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">theme</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;scheme&quot;</span><span class="p">:</span> <span class="s2">&quot;monokai&quot;</span><span class="p">,</span>
        <span class="s2">&quot;author&quot;</span><span class="p">:</span> <span class="s2">&quot;wimer hazenberg (http://www.monokai.nl)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;base00&quot;</span><span class="p">:</span> <span class="s2">&quot;#272822&quot;</span><span class="p">,</span>
        <span class="s2">&quot;base01&quot;</span><span class="p">:</span> <span class="s2">&quot;#383830&quot;</span><span class="p">,</span>
        <span class="s2">&quot;base02&quot;</span><span class="p">:</span> <span class="s2">&quot;#49483e&quot;</span><span class="p">,</span>
        <span class="s2">&quot;base03&quot;</span><span class="p">:</span> <span class="s2">&quot;#75715e&quot;</span><span class="p">,</span>
        <span class="s2">&quot;base04&quot;</span><span class="p">:</span> <span class="s2">&quot;#a59f85&quot;</span><span class="p">,</span>
        <span class="s2">&quot;base05&quot;</span><span class="p">:</span> <span class="s2">&quot;#f8f8f2&quot;</span><span class="p">,</span>
        <span class="s2">&quot;base06&quot;</span><span class="p">:</span> <span class="s2">&quot;#f5f4f1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;base07&quot;</span><span class="p">:</span> <span class="s2">&quot;#f9f8f5&quot;</span><span class="p">,</span>
        <span class="s2">&quot;base08&quot;</span><span class="p">:</span> <span class="s2">&quot;#f92672&quot;</span><span class="p">,</span>
        <span class="s2">&quot;base09&quot;</span><span class="p">:</span> <span class="s2">&quot;#fd971f&quot;</span><span class="p">,</span>
        <span class="s2">&quot;base0A&quot;</span><span class="p">:</span> <span class="s2">&quot;#f4bf75&quot;</span><span class="p">,</span>
        <span class="s2">&quot;base0B&quot;</span><span class="p">:</span> <span class="s2">&quot;#a6e22e&quot;</span><span class="p">,</span>
        <span class="s2">&quot;base0C&quot;</span><span class="p">:</span> <span class="s2">&quot;#a1efe4&quot;</span><span class="p">,</span>
        <span class="s2">&quot;base0D&quot;</span><span class="p">:</span> <span class="s2">&quot;#66d9ef&quot;</span><span class="p">,</span>
        <span class="s2">&quot;base0E&quot;</span><span class="p">:</span> <span class="s2">&quot;#ae81ff&quot;</span><span class="p">,</span>
        <span class="s2">&quot;base0F&quot;</span><span class="p">:</span> <span class="s2">&quot;#cc6633&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1"># Setup the layout</span>
    <span class="n">app_layout</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="c1"># Top row, only file explorer</span>
            <span class="n">dbc</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span>
                <span class="p">[</span><span class="n">dbc</span><span class="o">.</span><span class="n">Col</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_top_file_explorer</span><span class="p">(</span><span class="n">mydict</span><span class="p">))],</span>
                <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;Div_top&quot;</span><span class="p">,</span>
                <span class="n">style</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="s2">&quot;30%&quot;</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">),</span>
            <span class="c1"># second row, middle picture and right output</span>
            <span class="n">dbc</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="c1"># first column: picture</span>
                    <span class="n">dbc</span><span class="o">.</span><span class="n">Col</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_middle_picture_frame</span><span class="p">()),</span>
                    <span class="n">dbc</span><span class="o">.</span><span class="n">Col</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_right_output_json</span><span class="p">()),</span>
                <span class="p">]</span>
            <span class="p">),</span>
        <span class="p">],</span>
        <span class="c1"># style={&quot;width&quot;: &quot;95%&quot;, &quot;display&quot;: &quot;inline-block&quot;},</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">layout</span> <span class="o">=</span> <span class="n">app_layout</span>

    <span class="c1"># Add callbacks to the app</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span>
        <span class="n">Output</span><span class="p">(</span><span class="s2">&quot;img_middle_picture_id&quot;</span><span class="p">,</span> <span class="s2">&quot;src&quot;</span><span class="p">),</span>
        <span class="n">Input</span><span class="p">(</span><span class="s2">&quot;left_select_id&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">),</span>
        <span class="n">prevent_initial_call</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_picture</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span>
        <span class="n">Output</span><span class="p">(</span><span class="s2">&quot;right_json_viewer&quot;</span><span class="p">,</span> <span class="s2">&quot;children&quot;</span><span class="p">),</span>
        <span class="n">Input</span><span class="p">(</span><span class="s2">&quot;button_run&quot;</span><span class="p">,</span> <span class="s2">&quot;n_clicks&quot;</span><span class="p">),</span>
        <span class="n">State</span><span class="p">(</span><span class="s2">&quot;left_select_id&quot;</span><span class="p">,</span> <span class="s2">&quot;options&quot;</span><span class="p">),</span>
        <span class="n">State</span><span class="p">(</span><span class="s2">&quot;left_select_id&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">),</span>
        <span class="n">State</span><span class="p">(</span><span class="s2">&quot;Dropdown_select_Detector&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">),</span>
        <span class="n">State</span><span class="p">(</span><span class="s2">&quot;Dropdown_analysis_type&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">),</span>
        <span class="n">State</span><span class="p">(</span><span class="s2">&quot;textarea_questions&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">),</span>
        <span class="n">State</span><span class="p">(</span><span class="s2">&quot;setting_privacy_env_var&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">),</span>
        <span class="n">State</span><span class="p">(</span><span class="s2">&quot;setting_Color_delta_e_method&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">),</span>
        <span class="n">prevent_initial_call</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">_right_output_analysis</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span>
        <span class="n">Output</span><span class="p">(</span><span class="s2">&quot;settings_TextDetector&quot;</span><span class="p">,</span> <span class="s2">&quot;style&quot;</span><span class="p">),</span>
        <span class="n">Output</span><span class="p">(</span><span class="s2">&quot;settings_ColorDetector&quot;</span><span class="p">,</span> <span class="s2">&quot;style&quot;</span><span class="p">),</span>
        <span class="n">Output</span><span class="p">(</span><span class="s2">&quot;settings_VQA&quot;</span><span class="p">,</span> <span class="s2">&quot;style&quot;</span><span class="p">),</span>
        <span class="n">Input</span><span class="p">(</span><span class="s2">&quot;Dropdown_select_Detector&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">),</span>
    <span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">_update_detector_setting</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span>
        <span class="n">Output</span><span class="p">(</span><span class="s2">&quot;textarea_questions&quot;</span><span class="p">,</span> <span class="s2">&quot;style&quot;</span><span class="p">),</span>
        <span class="n">Input</span><span class="p">(</span><span class="s2">&quot;Dropdown_analysis_type&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">),</span>
    <span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">_show_questions_textarea_on_demand</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ammico.display.AnalysisExplorer.run_server" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">run_server</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="mi">8050</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Run the Dash server to start the analysis explorer.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>port</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The port number to run the server on (default: 8050).</p>
              </div>
            </td>
            <td>
                  <code>8050</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ammico/display.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">run_server</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8050</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run the Dash server to start the analysis explorer.</span>


<span class="sd">    Args:</span>
<span class="sd">        port (int, optional): The port number to run the server on (default: 8050).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ammico.display.AnalysisExplorer.update_picture" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">update_picture</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Callback function to update the displayed image.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>img_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The path of the selected image.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="PIL.Image.Image">Image</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Union[PIL.PngImagePlugin, None]: The image object to be displayed
or None if the image path is</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ammico/display.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">update_picture</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Callback function to update the displayed image.</span>

<span class="sd">    Args:</span>
<span class="sd">        img_path (str): The path of the selected image.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Union[PIL.PngImagePlugin, None]: The image object to be displayed</span>
<span class="sd">            or None if the image path is</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">img_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">image</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div><h2 id="model">Model</h2>


<div class="doc doc-object doc-module">



<a id="ammico.model"></a>
    <div class="doc doc-contents first">










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="ammico.model.AudioToTextModel" class="doc doc-heading">
            <code>AudioToTextModel</code>


</h2>


    <div class="doc doc-contents ">










              <details class="mkdocstrings-source">
                <summary>Source code in <code>ammico/model.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">AudioToTextModel</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model_size</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;large&quot;</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">language</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Class for WhisperX model loading and inference.</span>
<span class="sd">        Args:</span>
<span class="sd">            model_size: Size of Whisper model to load (small, base, large).</span>
<span class="sd">            device: &quot;cuda&quot; or &quot;cpu&quot; (auto-detected when None).</span>
<span class="sd">            language: ISO-639-1 language code (e.g., &quot;en&quot;, &quot;fr&quot;, &quot;de&quot;).</span>
<span class="sd">                     If None, language will be detected automatically.</span>
<span class="sd">                     Set this to avoid unreliable detection on small clips.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">resolve_model_device</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model_size</span> <span class="o">=</span> <span class="n">resolve_model_size</span><span class="p">(</span><span class="n">model_size</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">language</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_language</span><span class="p">(</span><span class="n">language</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_load_model</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_language</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">language</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Validate the provided language code against whisperx&#39;s supported languages.</span>
<span class="sd">        Args:</span>
<span class="sd">            language: ISO-639-1 language code (e.g., &quot;en&quot;, &quot;fr&quot;, &quot;de&quot;).</span>
<span class="sd">        Returns:</span>
<span class="sd">            Validated language code or None.</span>
<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the language code is invalid or unsupported.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">language</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">language</span> <span class="o">=</span> <span class="n">language</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">supported_languages</span> <span class="o">=</span> <span class="n">get_supported_whisperx_languages</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">language</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Invalid language code: &#39;</span><span class="si">{</span><span class="n">language</span><span class="si">}</span><span class="s2">&#39;. Language codes must be 2 letters.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">language</span><span class="o">.</span><span class="n">isalpha</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Invalid language code: &#39;</span><span class="si">{</span><span class="n">language</span><span class="si">}</span><span class="s2">&#39;. Language codes must contain only alphabetic characters.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">language</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">supported_languages</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unsupported language code: &#39;</span><span class="si">{</span><span class="n">language</span><span class="si">}</span><span class="s2">&#39;. Supported: </span><span class="si">{</span><span class="nb">sorted</span><span class="p">(</span><span class="n">supported_languages</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">language</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_load_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">==</span> <span class="s2">&quot;cuda&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">whisperx</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model_size</span><span class="p">,</span>
                <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
                <span class="n">compute_type</span><span class="o">=</span><span class="s2">&quot;float16&quot;</span><span class="p">,</span>
                <span class="n">language</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">language</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">whisperx</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model_size</span><span class="p">,</span>
                <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
                <span class="n">compute_type</span><span class="o">=</span><span class="s2">&quot;int8&quot;</span><span class="p">,</span>
                <span class="n">language</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">language</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Free model resources (helpful in long-running processes).&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
                    <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;Failed to empty CUDA cache. This is not critical, but may lead to memory lingering: &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="ne">RuntimeWarning</span><span class="p">,</span>
                    <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="ammico.model.AudioToTextModel.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">model_size</span><span class="o">=</span><span class="s1">&#39;large&#39;</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">language</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Class for WhisperX model loading and inference.
Args:
    model_size: Size of Whisper model to load (small, base, large).
    device: "cuda" or "cpu" (auto-detected when None).
    language: ISO-639-1 language code (e.g., "en", "fr", "de").
             If None, language will be detected automatically.
             Set this to avoid unreliable detection on small clips.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ammico/model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">model_size</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;large&quot;</span><span class="p">,</span>
    <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">language</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class for WhisperX model loading and inference.</span>
<span class="sd">    Args:</span>
<span class="sd">        model_size: Size of Whisper model to load (small, base, large).</span>
<span class="sd">        device: &quot;cuda&quot; or &quot;cpu&quot; (auto-detected when None).</span>
<span class="sd">        language: ISO-639-1 language code (e.g., &quot;en&quot;, &quot;fr&quot;, &quot;de&quot;).</span>
<span class="sd">                 If None, language will be detected automatically.</span>
<span class="sd">                 Set this to avoid unreliable detection on small clips.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">resolve_model_device</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">model_size</span> <span class="o">=</span> <span class="n">resolve_model_size</span><span class="p">(</span><span class="n">model_size</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">language</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_language</span><span class="p">(</span><span class="n">language</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_load_model</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ammico.model.AudioToTextModel.close" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">close</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Free model resources (helpful in long-running processes).</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ammico/model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Free model resources (helpful in long-running processes).&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;Failed to empty CUDA cache. This is not critical, but may lead to memory lingering: &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="ne">RuntimeWarning</span><span class="p">,</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="ammico.model.MultimodalEmbeddingsModel" class="doc doc-heading">
            <code>MultimodalEmbeddingsModel</code>


</h2>


    <div class="doc doc-contents ">










              <details class="mkdocstrings-source">
                <summary>Source code in <code>ammico/model.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">MultimodalEmbeddingsModel</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Class for Multimodal Embeddings model loading and inference. Uses Jina CLIP-V2 model.</span>
<span class="sd">        Args:</span>
<span class="sd">            device: &quot;cuda&quot; or &quot;cpu&quot; (auto-detected when None).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">resolve_model_device</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

        <span class="n">model_id</span> <span class="o">=</span> <span class="s2">&quot;jinaai/jina-clip-v2&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">SentenceTransformer</span><span class="p">(</span>
            <span class="n">model_id</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
            <span class="n">trust_remote_code</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">model_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;torch_dtype&quot;</span><span class="p">:</span> <span class="s2">&quot;auto&quot;</span><span class="p">},</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">embedding_dim</span> <span class="o">=</span> <span class="mi">1024</span>

    <span class="nd">@torch</span><span class="o">.</span><span class="n">inference_mode</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">encode_text</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">texts</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
        <span class="n">truncate_dim</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">texts</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">texts</span> <span class="o">=</span> <span class="p">[</span><span class="n">texts</span><span class="p">]</span>

        <span class="n">convert_to_tensor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">==</span> <span class="s2">&quot;cuda&quot;</span>
        <span class="n">convert_to_numpy</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">convert_to_tensor</span>

        <span class="n">embeddings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
            <span class="n">texts</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">convert_to_tensor</span><span class="o">=</span><span class="n">convert_to_tensor</span><span class="p">,</span>
            <span class="n">convert_to_numpy</span><span class="o">=</span><span class="n">convert_to_numpy</span><span class="p">,</span>
            <span class="n">normalize_embeddings</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">truncate_dim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">64</span> <span class="o">&lt;=</span> <span class="n">truncate_dim</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_dim</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;truncate_dim must be between 64 and </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding_dim</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="n">embeddings</span> <span class="o">=</span> <span class="n">embeddings</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_dim</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">embeddings</span>

    <span class="nd">@torch</span><span class="o">.</span><span class="n">inference_mode</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">encode_image</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">images</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">]],</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
        <span class="n">truncate_dim</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;images must be a PIL.Image or a list of PIL.Image objects. Please load images properly.&quot;</span>
            <span class="p">)</span>

        <span class="n">convert_to_tensor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">==</span> <span class="s2">&quot;cuda&quot;</span>
        <span class="n">convert_to_numpy</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">convert_to_tensor</span>

        <span class="n">embeddings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
            <span class="n">images</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">images</span><span class="p">],</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">convert_to_tensor</span><span class="o">=</span><span class="n">convert_to_tensor</span><span class="p">,</span>
            <span class="n">convert_to_numpy</span><span class="o">=</span><span class="n">convert_to_numpy</span><span class="p">,</span>
            <span class="n">normalize_embeddings</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">truncate_dim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">64</span> <span class="o">&lt;=</span> <span class="n">truncate_dim</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_dim</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;truncate_dim must be between 64 and </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding_dim</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="n">embeddings</span> <span class="o">=</span> <span class="n">embeddings</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_dim</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">embeddings</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Free model resources (helpful in long-running processes).&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
                    <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;Failed to empty CUDA cache. This is not critical, but may lead to memory lingering: &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="ne">RuntimeWarning</span><span class="p">,</span>
                    <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="ammico.model.MultimodalEmbeddingsModel.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Class for Multimodal Embeddings model loading and inference. Uses Jina CLIP-V2 model.
Args:
    device: "cuda" or "cpu" (auto-detected when None).</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ammico/model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class for Multimodal Embeddings model loading and inference. Uses Jina CLIP-V2 model.</span>
<span class="sd">    Args:</span>
<span class="sd">        device: &quot;cuda&quot; or &quot;cpu&quot; (auto-detected when None).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">resolve_model_device</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

    <span class="n">model_id</span> <span class="o">=</span> <span class="s2">&quot;jinaai/jina-clip-v2&quot;</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">SentenceTransformer</span><span class="p">(</span>
        <span class="n">model_id</span><span class="p">,</span>
        <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
        <span class="n">trust_remote_code</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">model_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;torch_dtype&quot;</span><span class="p">:</span> <span class="s2">&quot;auto&quot;</span><span class="p">},</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">embedding_dim</span> <span class="o">=</span> <span class="mi">1024</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ammico.model.MultimodalEmbeddingsModel.close" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">close</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Free model resources (helpful in long-running processes).</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ammico/model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Free model resources (helpful in long-running processes).&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;Failed to empty CUDA cache. This is not critical, but may lead to memory lingering: &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="ne">RuntimeWarning</span><span class="p">,</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="ammico.model.MultimodalSummaryModel" class="doc doc-heading">
            <code>MultimodalSummaryModel</code>


</h2>


    <div class="doc doc-contents ">










              <details class="mkdocstrings-source">
                <summary>Source code in <code>ammico/model.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">MultimodalSummaryModel</span><span class="p">:</span>
    <span class="n">DEFAULT_CUDA_MODEL</span> <span class="o">=</span> <span class="s2">&quot;Qwen/Qwen2.5-VL-7B-Instruct&quot;</span>
    <span class="n">DEFAULT_CPU_MODEL</span> <span class="o">=</span> <span class="s2">&quot;Qwen/Qwen2.5-VL-3B-Instruct&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">cache_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Class for QWEN-2.5-VL model loading and inference.</span>
<span class="sd">        Args:</span>
<span class="sd">            model_id: Type of model to load, defaults to a smaller version for CPU if device is &quot;cpu&quot;.</span>
<span class="sd">            device: &quot;cuda&quot; or &quot;cpu&quot; (auto-detected when None).</span>
<span class="sd">            cache_dir: huggingface cache dir (optional).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">resolve_model_device</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">model_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">model_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_CUDA_MODEL</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_CPU_MODEL</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;model_id must be one of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_CUDA_MODEL</span><span class="si">}</span><span class="s2"> or </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_CPU_MODEL</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model_id</span> <span class="o">=</span> <span class="n">model_id</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_CUDA_MODEL</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">==</span> <span class="s2">&quot;cuda&quot;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_CPU_MODEL</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cache_dir</span> <span class="o">=</span> <span class="n">cache_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_trust_remote_code</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_quantize</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processor</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_load_model_and_processor</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_load_model_and_processor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">load_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;trust_remote_code&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trust_remote_code</span><span class="p">,</span> <span class="s2">&quot;use_cache&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_dir</span><span class="p">:</span>
            <span class="n">load_kwargs</span><span class="p">[</span><span class="s2">&quot;cache_dir&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_dir</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">processor</span> <span class="o">=</span> <span class="n">AutoProcessor</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_id</span><span class="p">,</span> <span class="n">padding_side</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">load_kwargs</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_id</span><span class="p">,</span> <span class="o">**</span><span class="n">load_kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">==</span> <span class="s2">&quot;cuda&quot;</span><span class="p">:</span>
            <span class="n">compute_dtype</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">bfloat16</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_bf16_supported</span><span class="p">()</span> <span class="k">else</span> <span class="n">torch</span><span class="o">.</span><span class="n">float16</span>
            <span class="p">)</span>
            <span class="n">bnb_config</span> <span class="o">=</span> <span class="n">BitsAndBytesConfig</span><span class="p">(</span>
                <span class="n">load_in_4bit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">bnb_4bit_use_double_quant</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">bnb_4bit_quant_type</span><span class="o">=</span><span class="s2">&quot;nf4&quot;</span><span class="p">,</span>
                <span class="n">bnb_4bit_compute_dtype</span><span class="o">=</span><span class="n">compute_dtype</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">load_kwargs</span><span class="p">[</span><span class="s2">&quot;quantization_config&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bnb_config</span>
            <span class="n">load_kwargs</span><span class="p">[</span><span class="s2">&quot;device_map&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">load_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;quantization_config&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">load_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;device_map&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">Qwen2_5_VLForConditionalGeneration</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_id</span><span class="p">,</span> <span class="o">**</span><span class="n">load_kwargs</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Free model resources (helpful in long-running processes).&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">processor</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
                    <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;Failed to empty CUDA cache. This is not critical, but may lead to memory lingering: &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="ne">RuntimeWarning</span><span class="p">,</span>
                    <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="ammico.model.MultimodalSummaryModel.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">model_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cache_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Class for QWEN-2.5-VL model loading and inference.
Args:
    model_id: Type of model to load, defaults to a smaller version for CPU if device is "cpu".
    device: "cuda" or "cpu" (auto-detected when None).
    cache_dir: huggingface cache dir (optional).</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ammico/model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">model_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">cache_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class for QWEN-2.5-VL model loading and inference.</span>
<span class="sd">    Args:</span>
<span class="sd">        model_id: Type of model to load, defaults to a smaller version for CPU if device is &quot;cpu&quot;.</span>
<span class="sd">        device: &quot;cuda&quot; or &quot;cpu&quot; (auto-detected when None).</span>
<span class="sd">        cache_dir: huggingface cache dir (optional).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">resolve_model_device</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">model_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">model_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_CUDA_MODEL</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_CPU_MODEL</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;model_id must be one of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_CUDA_MODEL</span><span class="si">}</span><span class="s2"> or </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_CPU_MODEL</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">model_id</span> <span class="o">=</span> <span class="n">model_id</span> <span class="ow">or</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_CUDA_MODEL</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">==</span> <span class="s2">&quot;cuda&quot;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_CPU_MODEL</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">cache_dir</span> <span class="o">=</span> <span class="n">cache_dir</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_trust_remote_code</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_quantize</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">processor</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_load_model_and_processor</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ammico.model.MultimodalSummaryModel.close" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">close</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Free model resources (helpful in long-running processes).</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ammico/model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Free model resources (helpful in long-running processes).&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">processor</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;Failed to empty CUDA cache. This is not critical, but may lead to memory lingering: &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="ne">RuntimeWarning</span><span class="p">,</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div><h2 id="prompt-builder">Prompt Builder</h2>


<div class="doc doc-object doc-module">



<a id="ammico.prompt_builder"></a>
    <div class="doc doc-contents first">










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="ammico.prompt_builder.ProcessingLevel" class="doc doc-heading">
            <code>ProcessingLevel</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="enum.Enum">Enum</span></code></p>



        <p>Define the three processing levels in a pipeline.
FRAME: individual frame analysis
CLIP: video segment (multiple frames)
VIDEO: full video (multiple clips)</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>ammico/prompt_builder.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ProcessingLevel</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Define the three processing levels in a pipeline.</span>
<span class="sd">    FRAME: individual frame analysis</span>
<span class="sd">    CLIP: video segment (multiple frames)</span>
<span class="sd">    VIDEO: full video (multiple clips)&quot;&quot;&quot;</span>

    <span class="n">FRAME</span> <span class="o">=</span> <span class="s2">&quot;frame&quot;</span>
    <span class="n">CLIP</span> <span class="o">=</span> <span class="s2">&quot;clip&quot;</span>
    <span class="n">VIDEO</span> <span class="o">=</span> <span class="s2">&quot;video&quot;</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="ammico.prompt_builder.PromptBuilder" class="doc doc-heading">
            <code>PromptBuilder</code>


</h2>


    <div class="doc doc-contents ">



        <p>Modular prompt builder for multi-level video analysis.
Handles frame-level, clip-level, and video-level prompts.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>ammico/prompt_builder.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">PromptBuilder</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Modular prompt builder for multi-level video analysis.</span>
<span class="sd">    Handles frame-level, clip-level, and video-level prompts.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ROLE_MODULE</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;You are a precise video analysis AI. Your purpose is to:</span>
<span class="s2">    - Extract only information explicitly present in provided sources</span>
<span class="s2">    - Never hallucinate or infer beyond what is shown</span>
<span class="s2">    - Generate clear, concise, well-structured outputs</span>
<span class="s2">    - Maintain logical coherence across visual and audio sources&quot;&quot;&quot;</span>

    <span class="n">CONSTRAINTS_MODULE</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;## Quality Requirements</span>

<span class="s2">    - **Accuracy:** Use only explicitly provided information</span>
<span class="s2">    - **Conciseness:** Eliminate redundancy; be direct</span>
<span class="s2">    - **Clarity:** Use accessible language</span>
<span class="s2">    - **Consistency:** Align audio and visual information when both exist</span>
<span class="s2">    - **Format Compliance:** Follow output format exactly&quot;&quot;&quot;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">visual_frames_module</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;For frame-level processing with actual images.&quot;&quot;&quot;</span>
        <span class="n">str_to_return</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;## Visual Information</span>

<span class="s2">        Visual information is represented by keyframe extracted from the video segment at specified timestamp.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">str_to_return</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">visual_captions_module</span><span class="p">(</span><span class="n">frame_bullets</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;For clip-level processing with frame summaries.&quot;&quot;&quot;</span>
        <span class="n">bullets_text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">frame_bullets</span><span class="p">)</span>
        <span class="n">str_to_return</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;## Visual Information</span>

<span class="s2">        The following are summary bullets extracted from video frames with timestamps.</span>
<span class="s2">        These bullets represent the visual content detected in each frame of the video segment:</span>

<span class="s2">        </span><span class="si">{</span><span class="n">bullets_text</span><span class="si">}</span><span class="s2">&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">str_to_return</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">visual_captions_final_module</span><span class="p">(</span><span class="n">clip_summaries</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;For video-level processing with clip summaries.&quot;&quot;&quot;</span>
        <span class="n">str_to_return</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;## Visual Information</span>

<span class="s2">        The following are brief summaries obtained for each segment of the video.</span>
<span class="s2">        These summaries are associated with the timestamp of each segment&#39;s beginning:</span>

<span class="s2">        </span><span class="si">{</span><span class="n">clip_summaries</span><span class="si">}</span><span class="s2">&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">str_to_return</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">audio_module</span><span class="p">(</span><span class="n">audio_transcription</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Audio transcription with timestamps.&quot;&quot;&quot;</span>
        <span class="n">audio_text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;start_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s - </span><span class="si">{</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;end_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s]: </span><span class="si">{</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">audio_transcription</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">str_to_return</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;## Audio Information</span>

<span class="s2">        The following is the audio transcription for the same video segment,</span>
<span class="s2">        with precise timestamps for each spoken element:</span>

<span class="s2">        </span><span class="si">{</span><span class="n">audio_text</span><span class="si">}</span><span class="s2">&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">str_to_return</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">summary_task</span><span class="p">(</span><span class="n">has_audio</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate summary task (with or without audio).&quot;&quot;&quot;</span>
        <span class="n">sources</span> <span class="o">=</span> <span class="s2">&quot;visual and audio information&quot;</span> <span class="k">if</span> <span class="n">has_audio</span> <span class="k">else</span> <span class="s2">&quot;visual information&quot;</span>
        <span class="n">str_to_return</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;## Task: Generate Concise Summary</span>

<span class="s2">        Based on the </span><span class="si">{</span><span class="n">sources</span><span class="si">}</span><span class="s2"> provided, generate a brief summary that:</span>
<span class="s2">        - Captures and summarizes the main events and themes</span>
<span class="s2">        - Uses clear, accessible language</span>
<span class="s2">        - Is between 1-3 sentences</span>
<span class="s2">        - Contains no unsupported claims</span>

<span class="s2">        Return ONLY this format:</span>

<span class="s2">        Summary: &lt;your summary here&gt;&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">str_to_return</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">summary_vqa_task</span><span class="p">(</span>
        <span class="n">level</span><span class="p">:</span> <span class="n">ProcessingLevel</span><span class="p">,</span>
        <span class="n">has_audio</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate summary+VQA task (adapts based on level and audio). For Frame and Clip levels.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="n">ProcessingLevel</span><span class="o">.</span><span class="n">FRAME</span><span class="p">:</span>
            <span class="n">vqa_task</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Answer the provided questions based ONLY on information from the visual information. Answers must be brief and direct.</span>

<span class="s2">            **Critical Rule:** If you cannot answer a question from the provided sources,</span>
<span class="s2">            respond with: &quot;Cannot be determined from provided information.&quot;</span>
<span class="s2">            &quot;&quot;&quot;</span>
        <span class="k">elif</span> <span class="n">level</span> <span class="o">==</span> <span class="n">ProcessingLevel</span><span class="o">.</span><span class="n">CLIP</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">has_audio</span><span class="p">:</span>
                <span class="n">priority_list</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                    1. **Frame-Level Answers** - Pre-computed per-frame answers (auxiliary reference only)</span>
<span class="s2">                    2. **Audio Information** - Spoken content from audio transcription</span>
<span class="s2">                    3. **Visual Information** - Direct visual content from video frames&quot;&quot;&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">priority_list</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;1. **Frame-Level Answers** - Pre-computed per-frame answers (auxiliary reference only)</span>
<span class="s2">                    2. **Visual Information** - Direct visual content from video frames&quot;&quot;&quot;</span>
            <span class="n">vqa_task</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;For each question, use the BEST available source in this priority:</span>
<span class="s2">                </span><span class="si">{</span><span class="n">priority_list</span><span class="si">}</span>

<span class="s2">                **Critical Logic:**</span>
<span class="s2">                - If frame-level answer is a REAL answer (not &quot;Cannot be determined from provided information.&quot;)  use it</span>
<span class="s2">                - If frame-level answer is &quot;Cannot be determined&quot;  SKIP IT and check audio/visual instead</span>
<span class="s2">                - If answer is found in visual OR audio information  use that</span>
<span class="s2">                - ONLY respond &quot;Cannot be determined&quot; if truly no information exists anywhere</span>

<span class="s2">                &quot;&quot;&quot;</span>

        <span class="n">str_to_return</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;## You have two tasks:</span>

<span class="s2">        ### task 1: Concise Summary</span>
<span class="s2">        Generate a brief summary that captures and summarizes main events and themes from the visual information (1-3 sentences).</span>

<span class="s2">        ### task 2: Question Answering</span>
<span class="s2">        </span><span class="si">{</span><span class="n">vqa_task</span><span class="si">}</span>

<span class="s2">        Return ONLY this format:</span>

<span class="s2">        Summary: &lt;your summary here&gt;</span>

<span class="s2">        VQA Answers:</span>
<span class="s2">        1. &lt;answer to question 1&gt;</span>
<span class="s2">        2. &lt;answer to question 2&gt;</span>
<span class="s2">        [etc.]&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">str_to_return</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">vqa_only_task</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;VQA-only task for video-level processing.&quot;&quot;&quot;</span>
        <span class="n">str_to_return</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;## Task: Answer Questions</span>

<span class="s2">        For each question, use the BEST available source in this priority:</span>
<span class="s2">            1. **Segment-Level Answers** - Pre-computed per-frame answers (auxiliary reference only)</span>
<span class="s2">            2. **Visual Information** - Direct visual content from video frames</span>

<span class="s2">        **Critical Logic:**</span>
<span class="s2">                - If segment-level answer is a REAL answer (not &quot;Cannot be determined from provided information.&quot;)  use it</span>
<span class="s2">                - If frame-level answer is &quot;Cannot be determined&quot;  SKIP IT and check visual information instead</span>
<span class="s2">                - If answer is found in visual information  use that</span>
<span class="s2">                - ONLY respond &quot;Cannot be determined&quot; if truly no information exists anywhere</span>

<span class="s2">        Return ONLY this format:</span>

<span class="s2">        VQA Answers:</span>
<span class="s2">        1. &lt;answer to question 1&gt;</span>
<span class="s2">        2. &lt;answer to question 2&gt;</span>
<span class="s2">        [etc.]&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">str_to_return</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">questions_module</span><span class="p">(</span><span class="n">questions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Format questions list.&quot;&quot;&quot;</span>
        <span class="n">questions_text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">q</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">q</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">questions</span><span class="p">)]</span>
        <span class="p">)</span>
        <span class="n">str_to_return</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;## Questions to Answer</span>

<span class="s2">        </span><span class="si">{</span><span class="n">questions_text</span><span class="si">}</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">str_to_return</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">vqa_context_module</span><span class="p">(</span><span class="n">vqa_bullets</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">is_final</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;VQA context (frame-level or clip-level answers).&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">is_final</span><span class="p">:</span>
            <span class="n">header</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;## SEGMENT-Level Answer Context (Reference Only)</span>

<span class="s2">            The following are answers to above questions obtained for each segment of the video.</span>
<span class="s2">            These answers are associated with the timestamp of each segment&#39;s beginning:&quot;&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">header</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;## FRAME-Level Answer Context (Reference Only)</span>

<span class="s2">            For each question, the following are frame-level answers provided as reference.</span>
<span class="s2">            If these answers are &quot;Cannot be determined&quot;, do not accept that as finalinstead, </span>
<span class="s2">            use visual and audio information to answer the question:&quot;&quot;&quot;</span>

        <span class="n">bullets_text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">vqa_bullets</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">header</span><span class="si">}</span><span class="se">\n\n</span><span class="si">{</span><span class="n">bullets_text</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">build_frame_prompt</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">include_vqa</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">questions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Build prompt for frame-level analysis.&quot;&quot;&quot;</span>
        <span class="n">modules</span> <span class="o">=</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">ROLE_MODULE</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">visual_frames_module</span><span class="p">()]</span>

        <span class="k">if</span> <span class="n">include_vqa</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">questions</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Questions must be provided when VQA should be included.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">include_vqa</span><span class="p">:</span>
            <span class="n">modules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">summary_vqa_task</span><span class="p">(</span><span class="n">ProcessingLevel</span><span class="o">.</span><span class="n">FRAME</span><span class="p">))</span>
            <span class="n">modules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">questions_module</span><span class="p">(</span><span class="n">questions</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">modules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">summary_task</span><span class="p">())</span>

        <span class="n">modules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">CONSTRAINTS_MODULE</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">modules</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">build_clip_prompt</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">frame_bullets</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">include_audio</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">audio_transcription</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">include_vqa</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">questions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">vqa_bullets</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Build prompt for clip-level analysis.&quot;&quot;&quot;</span>
        <span class="n">modules</span> <span class="o">=</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">ROLE_MODULE</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">visual_captions_module</span><span class="p">(</span><span class="n">frame_bullets</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">include_audio</span> <span class="ow">and</span> <span class="n">audio_transcription</span><span class="p">:</span>
            <span class="n">modules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">audio_module</span><span class="p">(</span><span class="n">audio_transcription</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">include_vqa</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">questions</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Questions must be provided when VQA should be included.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">include_vqa</span><span class="p">:</span>
            <span class="n">modules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">summary_vqa_task</span><span class="p">(</span><span class="n">ProcessingLevel</span><span class="o">.</span><span class="n">CLIP</span><span class="p">,</span> <span class="n">has_audio</span><span class="o">=</span><span class="n">include_audio</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">modules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">questions_module</span><span class="p">(</span><span class="n">questions</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">vqa_bullets</span><span class="p">:</span>
                <span class="n">modules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">vqa_context_module</span><span class="p">(</span><span class="n">vqa_bullets</span><span class="p">,</span> <span class="n">is_final</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">modules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">summary_task</span><span class="p">(</span><span class="n">has_audio</span><span class="o">=</span><span class="n">include_audio</span><span class="p">))</span>

        <span class="n">modules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">CONSTRAINTS_MODULE</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">modules</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">build_video_prompt</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">include_vqa</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">clip_summaries</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">questions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">vqa_bullets</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Build prompt for video-level analysis.&quot;&quot;&quot;</span>
        <span class="n">modules</span> <span class="o">=</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">ROLE_MODULE</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">include_vqa</span><span class="p">:</span>
            <span class="n">modules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">visual_captions_final_module</span><span class="p">(</span><span class="n">clip_summaries</span><span class="p">))</span>
            <span class="n">modules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">summary_task</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">questions</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Questions must be provided when VQA should be included.&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">vqa_bullets</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Vqa_bullets must be provided for video-level VQA.&quot;</span><span class="p">)</span>

            <span class="n">modules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">visual_captions_final_module</span><span class="p">(</span><span class="n">clip_summaries</span><span class="p">))</span>
            <span class="n">modules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">vqa_context_module</span><span class="p">(</span><span class="n">vqa_bullets</span><span class="p">,</span> <span class="n">is_final</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="n">modules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">vqa_only_task</span><span class="p">())</span>
            <span class="n">modules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">questions_module</span><span class="p">(</span><span class="n">questions</span><span class="p">))</span>

        <span class="n">modules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">CONSTRAINTS_MODULE</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">modules</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="ammico.prompt_builder.PromptBuilder.audio_module" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">audio_module</span><span class="p">(</span><span class="n">audio_transcription</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Audio transcription with timestamps.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ammico/prompt_builder.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">audio_module</span><span class="p">(</span><span class="n">audio_transcription</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Audio transcription with timestamps.&quot;&quot;&quot;</span>
    <span class="n">audio_text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;start_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s - </span><span class="si">{</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;end_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s]: </span><span class="si">{</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">audio_transcription</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="n">str_to_return</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;## Audio Information</span>

<span class="s2">    The following is the audio transcription for the same video segment,</span>
<span class="s2">    with precise timestamps for each spoken element:</span>

<span class="s2">    </span><span class="si">{</span><span class="n">audio_text</span><span class="si">}</span><span class="s2">&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">str_to_return</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ammico.prompt_builder.PromptBuilder.build_clip_prompt" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">build_clip_prompt</span><span class="p">(</span><span class="n">frame_bullets</span><span class="p">,</span> <span class="n">include_audio</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">audio_transcription</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">include_vqa</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">questions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vqa_bullets</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Build prompt for clip-level analysis.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ammico/prompt_builder.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">build_clip_prompt</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span>
    <span class="n">frame_bullets</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">include_audio</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">audio_transcription</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">include_vqa</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">questions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">vqa_bullets</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build prompt for clip-level analysis.&quot;&quot;&quot;</span>
    <span class="n">modules</span> <span class="o">=</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">ROLE_MODULE</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">visual_captions_module</span><span class="p">(</span><span class="n">frame_bullets</span><span class="p">)]</span>

    <span class="k">if</span> <span class="n">include_audio</span> <span class="ow">and</span> <span class="n">audio_transcription</span><span class="p">:</span>
        <span class="n">modules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">audio_module</span><span class="p">(</span><span class="n">audio_transcription</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">include_vqa</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">questions</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Questions must be provided when VQA should be included.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">include_vqa</span><span class="p">:</span>
        <span class="n">modules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">summary_vqa_task</span><span class="p">(</span><span class="n">ProcessingLevel</span><span class="o">.</span><span class="n">CLIP</span><span class="p">,</span> <span class="n">has_audio</span><span class="o">=</span><span class="n">include_audio</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">modules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">questions_module</span><span class="p">(</span><span class="n">questions</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">vqa_bullets</span><span class="p">:</span>
            <span class="n">modules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">vqa_context_module</span><span class="p">(</span><span class="n">vqa_bullets</span><span class="p">,</span> <span class="n">is_final</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">modules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">summary_task</span><span class="p">(</span><span class="n">has_audio</span><span class="o">=</span><span class="n">include_audio</span><span class="p">))</span>

    <span class="n">modules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">CONSTRAINTS_MODULE</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">modules</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ammico.prompt_builder.PromptBuilder.build_frame_prompt" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">build_frame_prompt</span><span class="p">(</span><span class="n">include_vqa</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">questions</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Build prompt for frame-level analysis.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ammico/prompt_builder.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">build_frame_prompt</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span> <span class="n">include_vqa</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">questions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build prompt for frame-level analysis.&quot;&quot;&quot;</span>
    <span class="n">modules</span> <span class="o">=</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">ROLE_MODULE</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">visual_frames_module</span><span class="p">()]</span>

    <span class="k">if</span> <span class="n">include_vqa</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">questions</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Questions must be provided when VQA should be included.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">include_vqa</span><span class="p">:</span>
        <span class="n">modules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">summary_vqa_task</span><span class="p">(</span><span class="n">ProcessingLevel</span><span class="o">.</span><span class="n">FRAME</span><span class="p">))</span>
        <span class="n">modules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">questions_module</span><span class="p">(</span><span class="n">questions</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">modules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">summary_task</span><span class="p">())</span>

    <span class="n">modules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">CONSTRAINTS_MODULE</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">modules</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ammico.prompt_builder.PromptBuilder.build_video_prompt" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">build_video_prompt</span><span class="p">(</span><span class="n">include_vqa</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">clip_summaries</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">questions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vqa_bullets</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Build prompt for video-level analysis.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ammico/prompt_builder.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">build_video_prompt</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span>
    <span class="n">include_vqa</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">clip_summaries</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">questions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">vqa_bullets</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build prompt for video-level analysis.&quot;&quot;&quot;</span>
    <span class="n">modules</span> <span class="o">=</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">ROLE_MODULE</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">include_vqa</span><span class="p">:</span>
        <span class="n">modules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">visual_captions_final_module</span><span class="p">(</span><span class="n">clip_summaries</span><span class="p">))</span>
        <span class="n">modules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">summary_task</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">questions</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Questions must be provided when VQA should be included.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">vqa_bullets</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Vqa_bullets must be provided for video-level VQA.&quot;</span><span class="p">)</span>

        <span class="n">modules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">visual_captions_final_module</span><span class="p">(</span><span class="n">clip_summaries</span><span class="p">))</span>
        <span class="n">modules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">vqa_context_module</span><span class="p">(</span><span class="n">vqa_bullets</span><span class="p">,</span> <span class="n">is_final</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">modules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">vqa_only_task</span><span class="p">())</span>
        <span class="n">modules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">questions_module</span><span class="p">(</span><span class="n">questions</span><span class="p">))</span>

    <span class="n">modules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">CONSTRAINTS_MODULE</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">modules</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ammico.prompt_builder.PromptBuilder.questions_module" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">questions_module</span><span class="p">(</span><span class="n">questions</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Format questions list.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ammico/prompt_builder.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">questions_module</span><span class="p">(</span><span class="n">questions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Format questions list.&quot;&quot;&quot;</span>
    <span class="n">questions_text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">q</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">q</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">questions</span><span class="p">)]</span>
    <span class="p">)</span>
    <span class="n">str_to_return</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;## Questions to Answer</span>

<span class="s2">    </span><span class="si">{</span><span class="n">questions_text</span><span class="si">}</span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">str_to_return</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ammico.prompt_builder.PromptBuilder.summary_task" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">summary_task</span><span class="p">(</span><span class="n">has_audio</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Generate summary task (with or without audio).</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ammico/prompt_builder.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">summary_task</span><span class="p">(</span><span class="n">has_audio</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate summary task (with or without audio).&quot;&quot;&quot;</span>
    <span class="n">sources</span> <span class="o">=</span> <span class="s2">&quot;visual and audio information&quot;</span> <span class="k">if</span> <span class="n">has_audio</span> <span class="k">else</span> <span class="s2">&quot;visual information&quot;</span>
    <span class="n">str_to_return</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;## Task: Generate Concise Summary</span>

<span class="s2">    Based on the </span><span class="si">{</span><span class="n">sources</span><span class="si">}</span><span class="s2"> provided, generate a brief summary that:</span>
<span class="s2">    - Captures and summarizes the main events and themes</span>
<span class="s2">    - Uses clear, accessible language</span>
<span class="s2">    - Is between 1-3 sentences</span>
<span class="s2">    - Contains no unsupported claims</span>

<span class="s2">    Return ONLY this format:</span>

<span class="s2">    Summary: &lt;your summary here&gt;&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">str_to_return</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ammico.prompt_builder.PromptBuilder.summary_vqa_task" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">summary_vqa_task</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">has_audio</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Generate summary+VQA task (adapts based on level and audio). For Frame and Clip levels.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ammico/prompt_builder.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">summary_vqa_task</span><span class="p">(</span>
    <span class="n">level</span><span class="p">:</span> <span class="n">ProcessingLevel</span><span class="p">,</span>
    <span class="n">has_audio</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate summary+VQA task (adapts based on level and audio). For Frame and Clip levels.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="n">ProcessingLevel</span><span class="o">.</span><span class="n">FRAME</span><span class="p">:</span>
        <span class="n">vqa_task</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Answer the provided questions based ONLY on information from the visual information. Answers must be brief and direct.</span>

<span class="s2">        **Critical Rule:** If you cannot answer a question from the provided sources,</span>
<span class="s2">        respond with: &quot;Cannot be determined from provided information.&quot;</span>
<span class="s2">        &quot;&quot;&quot;</span>
    <span class="k">elif</span> <span class="n">level</span> <span class="o">==</span> <span class="n">ProcessingLevel</span><span class="o">.</span><span class="n">CLIP</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">has_audio</span><span class="p">:</span>
            <span class="n">priority_list</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                1. **Frame-Level Answers** - Pre-computed per-frame answers (auxiliary reference only)</span>
<span class="s2">                2. **Audio Information** - Spoken content from audio transcription</span>
<span class="s2">                3. **Visual Information** - Direct visual content from video frames&quot;&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">priority_list</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;1. **Frame-Level Answers** - Pre-computed per-frame answers (auxiliary reference only)</span>
<span class="s2">                2. **Visual Information** - Direct visual content from video frames&quot;&quot;&quot;</span>
        <span class="n">vqa_task</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;For each question, use the BEST available source in this priority:</span>
<span class="s2">            </span><span class="si">{</span><span class="n">priority_list</span><span class="si">}</span>

<span class="s2">            **Critical Logic:**</span>
<span class="s2">            - If frame-level answer is a REAL answer (not &quot;Cannot be determined from provided information.&quot;)  use it</span>
<span class="s2">            - If frame-level answer is &quot;Cannot be determined&quot;  SKIP IT and check audio/visual instead</span>
<span class="s2">            - If answer is found in visual OR audio information  use that</span>
<span class="s2">            - ONLY respond &quot;Cannot be determined&quot; if truly no information exists anywhere</span>

<span class="s2">            &quot;&quot;&quot;</span>

    <span class="n">str_to_return</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;## You have two tasks:</span>

<span class="s2">    ### task 1: Concise Summary</span>
<span class="s2">    Generate a brief summary that captures and summarizes main events and themes from the visual information (1-3 sentences).</span>

<span class="s2">    ### task 2: Question Answering</span>
<span class="s2">    </span><span class="si">{</span><span class="n">vqa_task</span><span class="si">}</span>

<span class="s2">    Return ONLY this format:</span>

<span class="s2">    Summary: &lt;your summary here&gt;</span>

<span class="s2">    VQA Answers:</span>
<span class="s2">    1. &lt;answer to question 1&gt;</span>
<span class="s2">    2. &lt;answer to question 2&gt;</span>
<span class="s2">    [etc.]&quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">str_to_return</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ammico.prompt_builder.PromptBuilder.visual_captions_final_module" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">visual_captions_final_module</span><span class="p">(</span><span class="n">clip_summaries</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>For video-level processing with clip summaries.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ammico/prompt_builder.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">visual_captions_final_module</span><span class="p">(</span><span class="n">clip_summaries</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;For video-level processing with clip summaries.&quot;&quot;&quot;</span>
    <span class="n">str_to_return</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;## Visual Information</span>

<span class="s2">    The following are brief summaries obtained for each segment of the video.</span>
<span class="s2">    These summaries are associated with the timestamp of each segment&#39;s beginning:</span>

<span class="s2">    </span><span class="si">{</span><span class="n">clip_summaries</span><span class="si">}</span><span class="s2">&quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">str_to_return</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ammico.prompt_builder.PromptBuilder.visual_captions_module" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">visual_captions_module</span><span class="p">(</span><span class="n">frame_bullets</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>For clip-level processing with frame summaries.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ammico/prompt_builder.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">visual_captions_module</span><span class="p">(</span><span class="n">frame_bullets</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;For clip-level processing with frame summaries.&quot;&quot;&quot;</span>
    <span class="n">bullets_text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">frame_bullets</span><span class="p">)</span>
    <span class="n">str_to_return</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;## Visual Information</span>

<span class="s2">    The following are summary bullets extracted from video frames with timestamps.</span>
<span class="s2">    These bullets represent the visual content detected in each frame of the video segment:</span>

<span class="s2">    </span><span class="si">{</span><span class="n">bullets_text</span><span class="si">}</span><span class="s2">&quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">str_to_return</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ammico.prompt_builder.PromptBuilder.visual_frames_module" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">visual_frames_module</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>For frame-level processing with actual images.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ammico/prompt_builder.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">visual_frames_module</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;For frame-level processing with actual images.&quot;&quot;&quot;</span>
    <span class="n">str_to_return</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;## Visual Information</span>

<span class="s2">    Visual information is represented by keyframe extracted from the video segment at specified timestamp.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">str_to_return</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ammico.prompt_builder.PromptBuilder.vqa_context_module" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">vqa_context_module</span><span class="p">(</span><span class="n">vqa_bullets</span><span class="p">,</span> <span class="n">is_final</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>VQA context (frame-level or clip-level answers).</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ammico/prompt_builder.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">vqa_context_module</span><span class="p">(</span><span class="n">vqa_bullets</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">is_final</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;VQA context (frame-level or clip-level answers).&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">is_final</span><span class="p">:</span>
        <span class="n">header</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;## SEGMENT-Level Answer Context (Reference Only)</span>

<span class="s2">        The following are answers to above questions obtained for each segment of the video.</span>
<span class="s2">        These answers are associated with the timestamp of each segment&#39;s beginning:&quot;&quot;&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">header</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;## FRAME-Level Answer Context (Reference Only)</span>

<span class="s2">        For each question, the following are frame-level answers provided as reference.</span>
<span class="s2">        If these answers are &quot;Cannot be determined&quot;, do not accept that as finalinstead, </span>
<span class="s2">        use visual and audio information to answer the question:&quot;&quot;&quot;</span>

    <span class="n">bullets_text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">vqa_bullets</span><span class="p">)</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">header</span><span class="si">}</span><span class="se">\n\n</span><span class="si">{</span><span class="n">bullets_text</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ammico.prompt_builder.PromptBuilder.vqa_only_task" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">vqa_only_task</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>VQA-only task for video-level processing.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ammico/prompt_builder.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">vqa_only_task</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;VQA-only task for video-level processing.&quot;&quot;&quot;</span>
    <span class="n">str_to_return</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;## Task: Answer Questions</span>

<span class="s2">    For each question, use the BEST available source in this priority:</span>
<span class="s2">        1. **Segment-Level Answers** - Pre-computed per-frame answers (auxiliary reference only)</span>
<span class="s2">        2. **Visual Information** - Direct visual content from video frames</span>

<span class="s2">    **Critical Logic:**</span>
<span class="s2">            - If segment-level answer is a REAL answer (not &quot;Cannot be determined from provided information.&quot;)  use it</span>
<span class="s2">            - If frame-level answer is &quot;Cannot be determined&quot;  SKIP IT and check visual information instead</span>
<span class="s2">            - If answer is found in visual information  use that</span>
<span class="s2">            - ONLY respond &quot;Cannot be determined&quot; if truly no information exists anywhere</span>

<span class="s2">    Return ONLY this format:</span>

<span class="s2">    VQA Answers:</span>
<span class="s2">    1. &lt;answer to question 1&gt;</span>
<span class="s2">    2. &lt;answer to question 2&gt;</span>
<span class="s2">    [etc.]&quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">str_to_return</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "..", "features": ["navigation.sections", "navigation.indexes", "search.suggest", "search.highlight"], "search": "../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>